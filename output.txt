æ–‡ä»¶å¤¹ 'CloudArt' çš„å±‚çº§ç»“æ„:

â””â”€â”€ CloudArt/
    â”œâ”€â”€ .gitignore
    â”œâ”€â”€ CMakeLists.txt
    â”œâ”€â”€ output.txt
    â””â”€â”€ .qtcreator/
        â”œâ”€â”€ CMakeLists.txt.user
        â””â”€â”€ qtc-cmake-presets-bvhIHIpF/
        â””â”€â”€ qtc-cmake-presets-XZNvAZIY/
        â””â”€â”€ qtc-cmake-presets-ZvFdVnmy/
    â””â”€â”€ resources/
        â”œâ”€â”€ resources.qrc
        â””â”€â”€ images/
            â”œâ”€â”€ 426DAA5942BF4BCE235CD3004582BC3A.png
            â”œâ”€â”€ ComfyUI_00292_.png
            â”œâ”€â”€ ComfyUI_00301_.png
            â”œâ”€â”€ HideConversation.png
            â”œâ”€â”€ historypic.png
            â”œâ”€â”€ loading.gif
            â”œâ”€â”€ logo.png
            â”œâ”€â”€ setting.png
            â”œâ”€â”€ t2i_demo.gif
            â”œâ”€â”€ å›¾ç”Ÿå›¾æ¼”ç¤º.gif
            â”œâ”€â”€ å›¾ç”Ÿå›¾æ¼”ç¤º.png
            â”œâ”€â”€ æ–‡ç”Ÿå›¾æ¼”ç¤º.gif
            â”œâ”€â”€ æ–‡ç”Ÿå›¾æ¼”ç¤º.png
        â””â”€â”€ workflows/
            â”œâ”€â”€ i2i_render.json
            â”œâ”€â”€ i2i_vision.json
            â”œâ”€â”€ Z-Imageæ–‡ç”Ÿå›¾.json
            â”œâ”€â”€ é«˜æ¸…ä¿®å¤.json
    â””â”€â”€ src/
        â”œâ”€â”€ CMakeLists.txt
        â”œâ”€â”€ logo.ico
        â”œâ”€â”€ logo.rc
        â”œâ”€â”€ main.cpp
        â””â”€â”€ Core/
            â”œâ”€â”€ WorkflowManager.cpp
            â”œâ”€â”€ WorkflowManager.h
        â””â”€â”€ Database/
            â”œâ”€â”€ DatabaseManager.cpp
            â”œâ”€â”€ DatabaseManager.h
        â””â”€â”€ Model/
            â”œâ”€â”€ DataModels.h
            â”œâ”€â”€ WorkflowTypes.h
        â””â”€â”€ Network/
            â”œâ”€â”€ ComfyApiService.cpp
            â”œâ”€â”€ ComfyApiService.h
        â””â”€â”€ Ui/
            â”œâ”€â”€ MainWindow.cpp
            â”œâ”€â”€ MainWindow.h
            â””â”€â”€ Components/
                â”œâ”€â”€ ChatArea.cpp
                â”œâ”€â”€ ChatArea.h
                â”œâ”€â”€ ChatBubble.cpp
                â”œâ”€â”€ ChatBubble.h
                â”œâ”€â”€ HistoryGallery.cpp
                â”œâ”€â”€ HistoryGallery.h
                â”œâ”€â”€ ImageViewer.cpp
                â”œâ”€â”€ ImageViewer.h
                â”œâ”€â”€ InputPanel.cpp
                â”œâ”€â”€ InputPanel.h
                â”œâ”€â”€ ReferencePopup.cpp
                â”œâ”€â”€ ReferencePopup.h
                â”œâ”€â”€ SessionItem.cpp
                â”œâ”€â”€ SessionItem.h
                â”œâ”€â”€ SessionList.cpp
                â”œâ”€â”€ SessionList.h
                â”œâ”€â”€ SettingsDialog.cpp
                â”œâ”€â”€ SettingsDialog.h
                â”œâ”€â”€ SidebarControl.cpp
                â”œâ”€â”€ SidebarControl.h
                â”œâ”€â”€ WorkflowCard.cpp
                â”œâ”€â”€ WorkflowCard.h
                â”œâ”€â”€ WorkflowSelector.cpp
                â”œâ”€â”€ WorkflowSelector.h

================================================================================

--- æ–‡ä»¶å¼€å§‹: CMakeLists.txt ---

cmake_minimum_required(VERSION 3.16)

# é¡¹ç›®åç§°å’Œç‰ˆæœ¬
project(CloudArt VERSION 0.1 LANGUAGES CXX)

# è®¾ç½® C++ æ ‡å‡† (C++17 æ˜¯ç°ä»£ Qt6 å¼€å‘çš„æ ‡é…)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Qt æ ¸å¿ƒè®¾ç½®ï¼šè‡ªåŠ¨å¤„ç†å…ƒå¯¹è±¡ç³»ç»Ÿ(MOC)ã€èµ„æº(RCC)å’ŒUIæ–‡ä»¶(UIC)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC ON)

# æŸ¥æ‰¾ Qt6 ç»„ä»¶ (æ ¸å¿ƒç»„ä»¶ã€ç•Œé¢ç»„ä»¶ã€ç½‘ç»œç»„ä»¶)
find_package(Qt6 COMPONENTS Widgets Network WebSockets Sql REQUIRED)

# æ·»åŠ å­ç›®å½• (å°†æ„å»ºé€»è¾‘ä¸‹æ”¾åˆ° src æ–‡ä»¶å¤¹)
add_subdirectory(src)


--- æ–‡ä»¶ç»“æŸ: CMakeLists.txt ---

--- æ–‡ä»¶å¼€å§‹: output.txt ---



--- æ–‡ä»¶ç»“æŸ: output.txt ---

--- æ–‡ä»¶å¼€å§‹: resources\workflows\i2i_render.json ---

{
  "3": {
    "inputs": {
      "seed": 275879196400549,
      "steps": 8,
      "cfg": 1,
      "sampler_name": "dpmpp_2m_sde",
      "scheduler": "sgm_uniform",
      "denoise": 1,
      "model": [
        "51",
        0
      ],
      "positive": [
        "6",
        0
      ],
      "negative": [
        "70",
        0
      ],
      "latent_image": [
        "53",
        0
      ]
    },
    "class_type": "KSampler",
    "_meta": {
      "title": "Ké‡‡æ ·å™¨"
    }
  },
  "6": {
    "inputs": {
      "text": "ä¸€ä½å¹´è½»å¥³æ€§ï¼Œçº¦17-19å²ï¼Œä¸œäºšé¢å­”ï¼Œé•¿ç›´é»‘å‘å¸¦é½åˆ˜æµ·ï¼Œçœ¼ç¥ä¸“æ³¨ç•¥å¸¦æ…µæ‡’ï¼Œå˜´å”‡å¾®å¼ å«ç€ä¸€æ ¹ç»†æœ¨ç­¾ï¼›èº«ç©¿é»‘è‰²æ ¡æœå¤–å¥—æ­é…çº¢è‰²é¢†ç»“ä¸æ·±è‰²ç™¾è¤¶è£™ï¼Œå†…æ­ç™½è‰²è¡¬è¡«ï¼Œä¸‹èº«ç©¿ç€ç™½è‰²çŸ­è¢œé…çš®é‹ï¼Œå¤–å¥—æœ‰ç ´æ´è®¾è®¡ï¼Œè¡£æ‘†éšåŠ¨ä½œé£˜åŠ¨ï¼›èº«ä½“æ–œå€šåœ¨æ°´æ³¥å°é˜¶ä¸Šï¼Œå³è…¿æŠ¬èµ·å‘ˆåŠåå§¿ï¼Œå·¦æ‰‹è½»æ‰¶é˜¶æ²¿ï¼Œå³æ‰‹æŒæœ¨ç­¾é è¿‘å”‡è¾¹ï¼Œæ•´ä½“å§¿æ€æ”¾æ¾è€Œå¯Œæœ‰åŠ¨æ„Ÿï¼›èº«å¤„ç°ä»£éƒ½å¸‚è¡—å¤´é˜¶æ¢¯æ—ï¼Œä¸¤ä¾§æ˜¯è´´æ»¡æ—¥æ–‡å¹¿å‘Šç‰Œçš„åŸå¸‚å»ºç­‘å¢™é¢ï¼ŒçŸ³é˜¶è¡¨é¢å› é£åŒ–æ˜¾å‡ºç°ç™½é¢—ç²’ä¸æ±¡è¿¹ï¼Œè¿œå¤„å¯è§é«˜æ¥¼ç»ç’ƒå¹•å¢™åå°„å¤©å…‰ï¼›é¡¶éƒ¨åå·¦å¼ºå…‰ç…§å°„å½¢æˆæ˜æš—è¿‡æ¸¡ï¼Œé˜´å½±è½åœ¨è…¿éƒ¨ä¸å°é˜¶ç¼éš™å¤„ï¼Œç”»é¢ä¸»è°ƒä¸ºä¸­æ€§å†·ç°è‰²ç³»ä½†å±€éƒ¨å—å…‰åŒºåŸŸæ³›æš–é»„ï¼Œå¢å¼ºç«‹ä½“æ„Ÿï¼›è‚Œè‚¤å‘ˆç°ç»†è…»å“‘å…‰è´¨æ„Ÿï¼Œæ¯›å‘æ ¹éƒ¨æ¸…æ™°å¯è§ï¼Œè¡£ç‰©çº¤ç»´çº¹è·¯åˆ†æ˜ï¼Œçš®é©é‹é¢æœ‰æ²¹æ¶¦åå…‰ï¼Œæ··å‡åœŸå°é˜¶ç²—ç²å¤šå­”ä¸”æ²¾æŸ“å°˜åœŸç—•è¿¹ï¼›8Kè¶…æ¸…ç”»è´¨ï¼Œæè‡´ç»†èŠ‚æ‹‰æ»¡ï¼Œé•œå¤´é”åˆ©èšç„¦äºé¢éƒ¨ä¸æ‰‹éƒ¨ç‰¹å†™ï¼Œé«˜åŠ¨æ€èŒƒå›´å¯¹æ¯”åº¦ï¼Œä¸“ä¸šçº§å†™å®æ‘„å½±æ•ˆæœ",
      "clip": [
        "34",
        0
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "CLIP Text Encode (Positive Prompt)"
    }
  },
  "9": {
    "inputs": {
      "filename_prefix": "comfyuii2i",
      "images": [
        "80",
        0
      ]
    },
    "class_type": "SaveImage",
    "_meta": {
      "title": "ä¿å­˜å›¾åƒ"
    }
  },
  "17": {
    "inputs": {
      "vae_name": "ae.safetensors"
    },
    "class_type": "VAELoader",
    "_meta": {
      "title": "åŠ è½½VAE"
    }
  },
  "30": {
    "inputs": {
      "image": "pasted/image (22).png"
    },
    "class_type": "LoadImage",
    "_meta": {
      "title": "åŠ è½½å›¾åƒ"
    }
  },
  "34": {
    "inputs": {
      "clip_name": "qwen_3_4b.safetensors",
      "type": "lumina2",
      "device": "default"
    },
    "class_type": "CLIPLoader",
    "_meta": {
      "title": "åŠ è½½CLIP"
    }
  },
  "35": {
    "inputs": {
      "unet_name": "zImage_turbo.safetensors",
      "weight_dtype": "default"
    },
    "class_type": "UNETLoader",
    "_meta": {
      "title": "UNetåŠ è½½å™¨"
    }
  },
  "50": {
    "inputs": {
      "name": "Z-Image-Turbo-Fun-Controlnet-Union-2.1.safetensors"
    },
    "class_type": "ModelPatchLoader",
    "_meta": {
      "title": "ModelPatchLoader"
    }
  },
  "51": {
    "inputs": {
      "strength": 0.8,
      "model": [
        "35",
        0
      ],
      "model_patch": [
        "50",
        0
      ],
      "vae": [
        "17",
        0
      ],
      "image": [
        "52",
        0
      ]
    },
    "class_type": "QwenImageDiffsynthControlnet",
    "_meta": {
      "title": "QwenImageDiffsynthControlnet"
    }
  },
  "52": {
    "inputs": {
      "preprocessor": "DepthAnythingV2Preprocessor",
      "resolution": 1024,
      "image": [
        "83",
        0
      ]
    },
    "class_type": "AIO_Preprocessor",
    "_meta": {
      "title": "AIO Aux Preprocessor"
    }
  },
  "53": {
    "inputs": {
      "width": [
        "54",
        0
      ],
      "height": [
        "54",
        1
      ],
      "batch_size": 1
    },
    "class_type": "EmptyLatentImage",
    "_meta": {
      "title": "ç©ºLatentå›¾åƒ"
    }
  },
  "54": {
    "inputs": {
      "image": [
        "83",
        0
      ]
    },
    "class_type": "GetImageSize",
    "_meta": {
      "title": "è·å–å›¾åƒå°ºå¯¸"
    }
  },
  "69": {
    "inputs": {
      "images": [
        "52",
        0
      ]
    },
    "class_type": "PreviewImage",
    "_meta": {
      "title": "é¢„è§ˆå›¾åƒ"
    }
  },
  "70": {
    "inputs": {
      "conditioning": [
        "6",
        0
      ]
    },
    "class_type": "ConditioningZeroOut",
    "_meta": {
      "title": "æ¡ä»¶é›¶åŒ–"
    }
  },
  "71": {
    "inputs": {
      "samples": [
        "3",
        0
      ],
      "vae": [
        "17",
        0
      ]
    },
    "class_type": "VAEDecode",
    "_meta": {
      "title": "VAEè§£ç "
    }
  },
  "80": {
    "inputs": {
      "anything": [
        "71",
        0
      ]
    },
    "class_type": "easy cleanGpuUsed",
    "_meta": {
      "title": "æ¸…ç†æ˜¾å­˜å ç”¨"
    }
  },
  "83": {
    "inputs": {
      "mode": "Megapixel Limit",
      "target_value": 1024,
      "image": [
        "30",
        0
      ]
    },
    "class_type": "MySmartResize",
    "_meta": {
      "title": "ğŸ› ï¸ My Smart Resize"
    }
  }
}

--- æ–‡ä»¶ç»“æŸ: resources\workflows\i2i_render.json ---

--- æ–‡ä»¶å¼€å§‹: resources\workflows\i2i_vision.json ---

{
  "1": {
    "inputs": {
      "model_name": "Huihui-Qwen3-VL-8B-Instruct-abliterated",
      "quantization": "4-bit (VRAM-friendly)",
      "attention_mode": "sdpa",
      "preset_prompt": "ğŸ–¼ï¸ Detailed Description",
      "custom_prompt": "è¯·åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œç”Ÿæˆç”¨äºAIç»˜ç”»çš„å†™å®é£æ ¼ä¸­æ–‡æç¤ºè¯ï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è¦æ±‚è¾“å‡ºï¼š\n1. ä¸»ä½“ç»†èŠ‚ï¼šæå–å›¾ç‰‡æ ¸å¿ƒä¸»ä½“ï¼ˆäººç‰©/ç‰©ä½“/åœºæ™¯ï¼‰ï¼Œè‹¥ä¸ºäºŒæ¬¡å…ƒå›¾ç‰‡ï¼Œéœ€å°†å¤¸å¼ ç‰¹å¾è½¬åŒ–ä¸ºå†™å®ç»†èŠ‚ï¼ˆå¦‚åŠ¨æ¼«å¤§çœ¼ç›æ”¹ä¸ºè‡ªç„¶çœ¼å‹ï¼Œç®€åŒ–å‘å‹è½¬ä¸ºçœŸå®å‘è´¨ï¼‰ï¼Œç»†åŒ–æè¿°æ€§åˆ«ã€å¹´é¾„ã€æœé¥°ã€å§¿æ€ã€è¡¨æƒ…ç­‰ç‰¹å¾ã€‚\n2. åœºæ™¯ç¯å¢ƒï¼šè¯¦ç»†æè¿°èƒŒæ™¯åœºæ™¯ï¼ˆå®¤å†…/æˆ·å¤–/åŸå¸‚/è‡ªç„¶ï¼‰ï¼Œè¡¥å……å†™å®åŒ–ç»†èŠ‚ï¼ˆå¦‚è€æ—§å¢™å£çš„æ–‘é©³çº¹ç†ã€é˜³å…‰é€è¿‡æ ‘å¶çš„å…‰æ–‘ã€åœ°é¢çš„æ°´æ¸ï¼‰ï¼ŒäºŒæ¬¡å…ƒåœºæ™¯éœ€æ›¿æ¢ä¸ºç°å®ä¸­å¯¹åº”çš„çœŸå®åœºæ™¯ã€‚\n3. å…‰å½±æ°›å›´ï¼šæ˜ç¡®å…‰æºæ–¹å‘ï¼ˆä¾§å…‰/é€†å…‰/é¡¶å…‰ï¼‰ã€å…‰çº¿å¼ºåº¦ï¼ˆæŸ”å’Œ/å¼ºçƒˆï¼‰ã€è‰²è°ƒï¼ˆå†·è‰²è°ƒ/æš–è‰²è°ƒï¼‰ï¼Œè¥é€ å†™å®æ°›å›´ï¼ˆé™è°§ã€ç´§å¼ ã€æ¸©é¦¨ã€ç”µå½±æ„Ÿï¼‰ã€‚\n4. æè´¨è´¨æ„Ÿï¼šæè¿°ä¸»ä½“å’Œåœºæ™¯çš„æè´¨ç»†èŠ‚ï¼ˆä¸ç»¸è¡£ç‰©çš„å…‰æ³½ã€é‡‘å±çš„åå…‰ã€çš®è‚¤çš„æ¯›å­”ã€å²©çŸ³çš„ç²—ç³™çº¹ç†ã€å¸ƒæ–™çš„è¤¶çš±ï¼‰ã€‚\n5. ç”»è´¨å‚æ•°ï¼šæ·»åŠ å†™å®æ‘„å½±å…³é”®è¯ï¼ˆ8Kåˆ†è¾¨ç‡ã€é«˜æ¸…ã€ç»†èŠ‚æ‹‰æ»¡ã€é”åˆ©å¯¹ç„¦ã€é«˜å¯¹æ¯”åº¦ã€ä¸“ä¸šçº§ç”»è´¨ï¼‰ã€‚\n6. æ ¼å¼è¦æ±‚ï¼šç›´æ¥è¾“å‡ºä¸­æ–‡æç¤ºè¯ï¼Œç”¨ä¸­æ–‡é€—å·åˆ†éš”ï¼ŒæŒ‰ã€Œä¸»ä½“â†’åœºæ™¯â†’å…‰å½±â†’æè´¨â†’ç”»è´¨ã€çš„é¡ºåºæ’åˆ—ï¼Œæ— éœ€ä»»ä½•è§£é‡Šæ€§æ–‡å­—ï¼Œç¡®ä¿å¯ç›´æ¥ç”¨äºzimageç”Ÿæˆå†™å®å›¾ç‰‡ã€‚",
      "max_tokens": 1024,
      "keep_model_loaded": false,
      "seed": 2293362220,
      "image": [
        "6",
        0
      ]
    },
    "class_type": "AILab_QwenVL",
    "_meta": {
      "title": "QwenVL"
    }
  },
  "3": {
    "inputs": {
      "image": "011f4ac2b959b7875cad923fcd97cd86_720.jpg"
    },
    "class_type": "LoadImage",
    "_meta": {
      "title": "åŠ è½½å›¾åƒ"
    }
  },
  "4": {
    "inputs": {
      "preview": "",
      "previewMode": null,
      "source": [
        "7",
        0
      ]
    },
    "class_type": "PreviewAny",
    "_meta": {
      "title": "é¢„è§ˆä»»æ„"
    }
  },
  "6": {
    "inputs": {
      "mode": "Long Edge Limit",
      "target_value": 1024,
      "image": [
        "3",
        0
      ]
    },
    "class_type": "MySmartResize",
    "_meta": {
      "title": "ğŸ› ï¸ My Smart Resize"
    }
  },
  "7": {
    "inputs": {
      "anything": [
        "1",
        0
      ]
    },
    "class_type": "easy cleanGpuUsed",
    "_meta": {
      "title": "æ¸…ç†æ˜¾å­˜å ç”¨"
    }
  }
}

--- æ–‡ä»¶ç»“æŸ: resources\workflows\i2i_vision.json ---

--- æ–‡ä»¶å¼€å§‹: resources\workflows\Z-Imageæ–‡ç”Ÿå›¾.json ---

{
  "3": {
    "inputs": {
      "vae_name": "ae.safetensors"
    },
    "class_type": "VAELoader",
    "_meta": {
      "title": "åŠ è½½VAE"
    }
  },
  "4": {
    "inputs": {
      "seed": 859214507156335,
      "steps": 8,
      "cfg": 1,
      "sampler_name": "euler",
      "scheduler": "simple",
      "denoise": 1,
      "model": [
        "23",
        0
      ],
      "positive": [
        "5",
        0
      ],
      "negative": [
        "25",
        0
      ],
      "latent_image": [
        "7",
        0
      ]
    },
    "class_type": "KSampler",
    "_meta": {
      "title": "Ké‡‡æ ·å™¨"
    }
  },
  "5": {
    "inputs": {
      "text": " ",
      "clip": [
        "24",
        0
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "CLIPæ–‡æœ¬ç¼–ç "
    }
  },
  "7": {
    "inputs": {
      "width": 720,
      "height": 1080,
      "batch_size": 1
    },
    "class_type": "EmptyLatentImage",
    "_meta": {
      "title": "ç©ºLatentå›¾åƒ"
    }
  },
  "8": {
    "inputs": {
      "samples": [
        "4",
        0
      ],
      "vae": [
        "3",
        0
      ]
    },
    "class_type": "VAEDecode",
    "_meta": {
      "title": "VAEè§£ç "
    }
  },
  "20": {
    "inputs": {
      "filename_prefix": "ComfyUI",
      "images": [
        "29",
        0
      ]
    },
    "class_type": "SaveImage",
    "_meta": {
      "title": "ä¿å­˜å›¾åƒ"
    }
  },
  "23": {
    "inputs": {
      "unet_name": "zImage_turbo.safetensors",
      "weight_dtype": "default"
    },
    "class_type": "UNETLoader",
    "_meta": {
      "title": "UNetåŠ è½½å™¨"
    }
  },
  "24": {
    "inputs": {
      "clip_name": "qwen_3_4b.safetensors",
      "type": "qwen_image",
      "device": "default"
    },
    "class_type": "CLIPLoader",
    "_meta": {
      "title": "åŠ è½½CLIP"
    }
  },
  "25": {
    "inputs": {
      "text": "",
      "clip": [
        "24",
        0
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "CLIPæ–‡æœ¬ç¼–ç "
    }
  },
  "29": {
    "inputs": {
      "anything": [
        "8",
        0
      ]
    },
    "class_type": "easy cleanGpuUsed",
    "_meta": {
      "title": "æ¸…ç†æ˜¾å­˜å ç”¨"
    }
  }
}

--- æ–‡ä»¶ç»“æŸ: resources\workflows\Z-Imageæ–‡ç”Ÿå›¾.json ---

--- æ–‡ä»¶å¼€å§‹: resources\workflows\é«˜æ¸…ä¿®å¤.json ---

{
  "1": {
    "inputs": {
      "filename_prefix": "ComfyUI",
      "images": [
        "5",
        0
      ]
    },
    "class_type": "SaveImage",
    "_meta": {
      "title": "ä¿å­˜å›¾åƒ"
    }
  },
  "2": {
    "inputs": {
      "seed": 580323588,
      "resolution": 1536,
      "max_resolution": 0,
      "batch_size": 1,
      "uniform_batch_size": false,
      "color_correction": "wavelet",
      "temporal_overlap": 0,
      "prepend_frames": 0,
      "input_noise_scale": 0,
      "latent_noise_scale": 0,
      "offload_device": "cpu",
      "enable_debug": false,
      "image": [
        "6",
        0
      ],
      "dit": [
        "4",
        0
      ],
      "vae": [
        "3",
        0
      ]
    },
    "class_type": "SeedVR2VideoUpscaler",
    "_meta": {
      "title": "SeedVR2 Video Upscaler (v2.5.22)"
    }
  },
  "3": {
    "inputs": {
      "model": "ema_vae_fp16.safetensors",
      "device": "cuda:0",
      "encode_tiled": false,
      "encode_tile_size": 1024,
      "encode_tile_overlap": 128,
      "decode_tiled": false,
      "decode_tile_size": 1024,
      "decode_tile_overlap": 128,
      "tile_debug": "false",
      "offload_device": "cpu",
      "cache_model": false
    },
    "class_type": "SeedVR2LoadVAEModel",
    "_meta": {
      "title": "SeedVR2 (Down)Load VAE Model"
    }
  },
  "4": {
    "inputs": {
      "model": "seedvr2_ema_3b_fp8_e4m3fn.safetensors",
      "device": "cuda:0",
      "blocks_to_swap": 32,
      "swap_io_components": false,
      "offload_device": "cpu",
      "cache_model": false,
      "attention_mode": "sdpa"
    },
    "class_type": "SeedVR2LoadDiTModel",
    "_meta": {
      "title": "SeedVR2 (Down)Load DiT Model"
    }
  },
  "5": {
    "inputs": {
      "anything": [
        "2",
        0
      ]
    },
    "class_type": "easy cleanGpuUsed",
    "_meta": {
      "title": "æ¸…ç†æ˜¾å­˜å ç”¨"
    }
  },
  "6": {
    "inputs": {
      "image": "comfyuii2i_00140_.png"
    },
    "class_type": "LoadImage",
    "_meta": {
      "title": "åŠ è½½å›¾åƒ"
    }
  }
}

--- æ–‡ä»¶ç»“æŸ: resources\workflows\é«˜æ¸…ä¿®å¤.json ---

--- æ–‡ä»¶å¼€å§‹: src\CMakeLists.txt ---

# å®šä¹‰æºä»£ç æ–‡ä»¶åˆ—è¡¨
set(SOURCES
    main.cpp
    logo.rc
    Ui/MainWindow.h
    Ui/MainWindow.cpp

    #Core
    Core/WorkflowManager.h
    Core/WorkflowManager.cpp

    # Model
    Model/WorkflowTypes.h
    Model/DataModels.h

    # Database
    Database/DatabaseManager.h
    Database/DatabaseManager.cpp

    # Network
    Network/ComfyApiService.h
    Network/ComfyApiService.cpp

    # Components
    Ui/Components/SidebarControl.h
    Ui/Components/SidebarControl.cpp
    Ui/Components/SessionList.h
    Ui/Components/SessionList.cpp
    Ui/Components/ChatArea.h
    Ui/Components/ChatArea.cpp
    Ui/Components/InputPanel.h
    Ui/Components/InputPanel.cpp
    Ui/Components/WorkflowSelector.h
    Ui/Components/WorkflowSelector.cpp
    Ui/Components/WorkflowCard.h
    Ui/Components/WorkflowCard.cpp
    Ui/Components/ReferencePopup.h
    Ui/Components/ReferencePopup.cpp
    Ui/Components/SessionItem.h
    Ui/Components/SessionItem.cpp
    Ui/Components/ChatBubble.h
    Ui/Components/ChatBubble.cpp
    Ui/Components/ImageViewer.h
    Ui/Components/ImageViewer.cpp
    Ui/Components/HistoryGallery.h
    Ui/Components/HistoryGallery.cpp
    Ui/Components/SettingsDialog.h
    Ui/Components/SettingsDialog.cpp
    ../resources/resources.qrc
)

# å®šä¹‰å¯æ‰§è¡Œæ–‡ä»¶
add_executable(CloudArt ${SOURCES})

# é“¾æ¥ Qt åº“
target_link_libraries(CloudArt PRIVATE
    Qt6::Widgets
    Qt6::Network
    Qt6::WebSockets
    Qt6::Sql
)

# è®¾ç½® Windows å­ç³»ç»Ÿ (é¿å…è¿è¡Œæ—¶å¼¹å‡ºé»‘è‰² cmd çª—å£ï¼Œä½†åœ¨å¼€å‘è°ƒè¯•æœŸå¯ä»¥å…ˆæ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œ)
set_target_properties(CloudArt PROPERTIES WIN32_EXECUTABLE ON)


--- æ–‡ä»¶ç»“æŸ: src\CMakeLists.txt ---

--- æ–‡ä»¶å¼€å§‹: src\main.cpp ---

#include <QApplication>
#include "Ui/MainWindow.h"
// å¼•å…¥æ•°æ®åº“å¤´æ–‡ä»¶
#include "Database/DatabaseManager.h"

int main(int argc, char *argv[])
{
    QApplication app(argc, argv);
    app.setApplicationName("CloudArt");

    app.setWindowIcon(QIcon(":/images/logo.png"));

    // ã€æ–°å¢ã€‘å¯åŠ¨æ—¶åˆå§‹åŒ–æ•°æ®åº“
    // å¦‚æœå¤±è´¥äº†ï¼Œç›´æ¥æ‰“å°é”™è¯¯ï¼ˆæˆ–è€…å¼¹çª—æç¤ºï¼‰ï¼Œä½†ä¸ä¸€å®šè¦é€€å‡º
    if (!DatabaseManager::instance().init()) {
        qDebug() << "âš ï¸ è­¦å‘Šï¼šæ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œå†å²è®°å½•å°†æ— æ³•ä¿å­˜ï¼";
    }

    if (!DatabaseManager::instance().init()) {
        return -1;
    }

    MainWindow window;
    window.show();

    return app.exec();
}


--- æ–‡ä»¶ç»“æŸ: src\main.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Core\WorkflowManager.cpp ---

#include "WorkflowManager.h"
#include <QFile>
#include <QJsonDocument>
#include <QJsonObject>
#include <QJsonValue>
#include <QDebug>
#include <QRandomGenerator>

WorkflowManager::WorkflowManager(QObject *parent) : QObject(parent)
{
}


QJsonObject WorkflowManager::buildWorkflow(WorkflowType type, const QMap<QString, QVariant>& params)
{
    qDebug() << "WorkflowManager: æ„å»ºå·¥ä½œæµç±»å‹ ->" << (int)type;

    switch (type) {
    case WorkflowType::TextToImage:
        return buildTextToImage(params);

    case WorkflowType::Upscale:
        return buildUpscale(params);

    case WorkflowType::ImageToImage:
        return buildImageToImage(params); // é¢„ç•™

    case WorkflowType::VisionCaption:
        return buildVisionCaption(params);

    default:
        qDebug() << "âŒ æœªçŸ¥çš„å·¥ä½œæµç±»å‹:" << (int)type;
        return QJsonObject();
    }
}

QJsonObject WorkflowManager::buildTextToImage(const QMap<QString, QVariant>& params)
{
    QJsonObject workflow = loadTemplate(":/workflows/t2i");
    if (workflow.isEmpty()) return QJsonObject();

    // 1. è®¾ç½®æç¤ºè¯ (Node 5: CLIPTextEncode)
    if (params.contains("prompt")) {
        setNodeInput(workflow, "5", "text", params["prompt"].toString());
    }

    // 2. è®¾ç½®ç§å­ (Node 4: KSampler)
    if (params.contains("seed")) {
        setNodeInput(workflow, "4", "seed", params["seed"].toLongLong());
    }

    // 3. è®¾ç½®åˆ†è¾¨ç‡ (Node 7: EmptyLatentImage)
    if (params.contains("width") && params.contains("height")) {
        setNodeInput(workflow, "7", "width", params["width"].toInt());
        setNodeInput(workflow, "7", "height", params["height"].toInt());
    }

    return workflow;
}

QJsonObject WorkflowManager::buildUpscale(const QMap<QString, QVariant>& params)
{
    QJsonObject workflow = loadTemplate(":/workflows/upscale");
    if (workflow.isEmpty()) return QJsonObject();

    // 1. è®¾ç½®åŸå›¾è·¯å¾„ (Node 6: LoadImage)
    if (params.contains("image_path")) {
        setNodeInput(workflow, "6", "image", params["image_path"].toString());
    }

    // 2. è®¾ç½®ç§å­ (Node 2: SeedVR2)
    if (params.contains("seed")) {
        setNodeInput(workflow, "2", "seed", params["seed"].toLongLong());
    }

    return workflow;
}


// ---------------------------------------------------------
// å·¥å…·å‡½æ•°å®ç°
// ---------------------------------------------------------

void WorkflowManager::setNodeInput(QJsonObject& workflow, const QString& nodeId, const QString& inputKey, const QVariant& value)
{
    // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
    if (!workflow.contains(nodeId)) {
        qDebug() << "âš ï¸ Warning: JSONä¸­æ‰¾ä¸åˆ°èŠ‚ç‚¹ ID:" << nodeId;
        return;
    }

    // å‰¥æ´‹è‘±ï¼šworkflow -> node -> inputs -> value
    QJsonObject node = workflow[nodeId].toObject();

    if (!node.contains("inputs")) {
        qDebug() << "âš ï¸ Warning: èŠ‚ç‚¹" << nodeId << "æ²¡æœ‰ inputs å­—æ®µ";
        return;
    }

    QJsonObject inputs = node["inputs"].toObject();

    // æ ¹æ®å€¼çš„ç±»å‹è¿›è¡Œè½¬æ¢
    // æ³¨æ„ï¼šJSON æ•°å­—å¯¹åº” Qt çš„ double/long long
    if (value.typeId() == QMetaType::LongLong || value.typeId() == QMetaType::Int) {
        inputs[inputKey] = value.toLongLong();
    }
    else {
        inputs[inputKey] = value.toString();
    }

    // å°åŒ…å›å» (è¿™æ˜¯ä¿®æ”¹ QJsonObject çš„å¿…é¡»æ­¥éª¤ï¼Œå› ä¸ºå®ƒæ˜¯éšå¼å…±äº«çš„)
    node["inputs"] = inputs;
    workflow[nodeId] = node;
}


QJsonObject WorkflowManager::loadTemplate(const QString& resourcePath)
{
    QFile file(resourcePath);
    if (!file.open(QIODevice::ReadOnly)) {
        qDebug() << "âŒ æ— æ³•åŠ è½½æ¨¡æ¿æ–‡ä»¶:" << resourcePath;
        return QJsonObject();
    }

    QJsonDocument doc = QJsonDocument::fromJson(file.readAll());
    if (doc.isNull()) {
        qDebug() << "âŒ JSON æ ¼å¼é”™è¯¯:" << resourcePath;
        return QJsonObject();
    }

    return doc.object();
}


QJsonObject WorkflowManager::buildVisionCaption(const QMap<QString, QVariant>& params)
{
    // åŠ è½½æ¨¡æ¿ (ç¡®ä¿ resources.qrc é‡Œåˆ«åæ˜¯ vision)
    QJsonObject workflow = loadTemplate(":/workflows/vision");

    if (workflow.isEmpty()) {
        qDebug() << "âŒ æ— æ³•åŠ è½½åæ¨æ¨¡æ¿ :/workflows/vision";
        return QJsonObject();
    }

    // å¡«å…¥å›¾ç‰‡è·¯å¾„
    // å¯¹åº” JSON ä¸­çš„ Node 3 (LoadImage) -> inputs -> image
    if (params.contains("image_path")) {
        setNodeInput(workflow, "3", "image", params["image_path"].toString());
    }

    qint64 seed = QRandomGenerator::global()->generate();
    if (seed < 0) seed = -seed;

    // å¦‚æœ params é‡Œä¼ äº†ç§å­å°±ç”¨ä¼ çš„ï¼Œæ²¡ä¼ å°±éšæœºç”Ÿæˆ
    if (params.contains("seed")) {
        seed = params["seed"].toLongLong();
    }

    setNodeInput(workflow, "1", "seed", seed);

    return workflow;
}


QJsonObject WorkflowManager::buildImageToImage(const QMap<QString, QVariant>& params)
{
    // åˆ«å render å¯¹åº” i2i_render.json
    QJsonObject workflow = loadTemplate(":/workflows/render");
    if (workflow.isEmpty()) return QJsonObject();

    // 1. å¡«å…¥å‚è€ƒå›¾ (Node 30)
    if (params.contains("image_path")) {
        setNodeInput(workflow, "30", "image", params["image_path"].toString());
    }

    // 2. å¡«å…¥æç¤ºè¯ (Node 6)
    if (params.contains("prompt")) {
        setNodeInput(workflow, "6", "text", params["prompt"].toString());
    }

    // 3. å¡«å…¥ç§å­ (Node 3)
    if (params.contains("seed")) {
        setNodeInput(workflow, "3", "seed", params["seed"].toLongLong());
    }

    return workflow;
}


--- æ–‡ä»¶ç»“æŸ: src\Core\WorkflowManager.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Core\WorkflowManager.h ---

#pragma once
#include <QObject>
#include <QJsonObject>
#include <QMap>
#include <QVariant>
#include "../Model/WorkflowTypes.h"

class WorkflowManager : public QObject
{
    Q_OBJECT
public:
    explicit WorkflowManager(QObject *parent = nullptr);

    /**
     * @brief æ„å»ºå·¥ä½œæµ JSON
     * @param type å·¥ä½œæµç±»å‹ (ä¾‹å¦‚ TextToImage)
     * @param params ç”¨æˆ·è¾“å…¥çš„å‚æ•° (ä¾‹å¦‚ prompt, seed)
     * @return å‡†å¤‡å¥½å‘é€ç»™ API çš„ JSON å¯¹è±¡
     */
    QJsonObject buildWorkflow(WorkflowType type, const QMap<QString, QVariant>& params);

private:
    // åŠ è½½èµ„æºæ–‡ä»¶ä¸­çš„ JSON
    QJsonObject loadTemplate(const QString& resourcePath);

    // ã€æ–°å¢ã€‘é€šç”¨ä¿®æ”¹å™¨ï¼šè®¾ç½®æŒ‡å®šèŠ‚ç‚¹çš„è¾“å…¥å‚æ•°å€¼
    // workflow: å¼•ç”¨ä¼ é€’ï¼Œç›´æ¥ä¿®æ”¹
    // nodeId: èŠ‚ç‚¹ID (å¦‚ "3")
    // inputKey: å‚æ•°å (å¦‚ "seed", "text")
    // value: å‚æ•°å€¼
    void setNodeInput(QJsonObject& workflow, const QString& nodeId, const QString& inputKey, const QVariant& value);

    // --- å…·ä½“å·¥ä½œæµæ„å»ºå‡½æ•° ---

    // æ„å»ºæ–‡ç”Ÿå›¾
    QJsonObject buildTextToImage(const QMap<QString, QVariant>& params);

    // æ„å»ºé«˜æ¸…ä¿®å¤
    QJsonObject buildUpscale(const QMap<QString, QVariant>& params);

    // æ„å»ºå›¾ç”Ÿå›¾ (é¢„ç•™)
    QJsonObject buildImageToImage(const QMap<QString, QVariant>& params);

    // ã€æ–°å¢ã€‘æ„å»ºè§†è§‰åæ¨å·¥ä½œæµ
    QJsonObject buildVisionCaption(const QMap<QString, QVariant>& params);
};


--- æ–‡ä»¶ç»“æŸ: src\Core\WorkflowManager.h ---

--- æ–‡ä»¶å¼€å§‹: src\Database\DatabaseManager.cpp ---

#include "DatabaseManager.h"
#include <QSqlQuery>
#include <QSqlError>
#include <QStandardPaths>
#include <QDir>
#include <QDebug>
#include <QVariant>

DatabaseManager& DatabaseManager::instance()
{
    static DatabaseManager instance;
    return instance;
}

DatabaseManager::DatabaseManager(QObject *parent) : QObject(parent) {}

DatabaseManager::~DatabaseManager()
{
    if (m_db.isOpen()) m_db.close();
}

bool DatabaseManager::init()
{
    // 1. ç¡®å®šæ•°æ®åº“å­˜æ”¾åœ¨å“ªé‡Œ
    // ä¹Ÿå°±æ˜¯ C:/Users/ç”¨æˆ·å/AppData/Local/CloudArt/cloudart.db
    QString dataDir = QStandardPaths::writableLocation(QStandardPaths::AppDataLocation);

    // ç¡®ä¿æ–‡ä»¶å¤¹å­˜åœ¨
    QDir dir(dataDir);
    if (!dir.exists()) dir.mkpath(".");

    QString dbPath = dataDir + "/cloudart.db";
    qDebug() << "ğŸ“‚ æ•°æ®åº“è·¯å¾„:" << dbPath;

    // 2. è¿æ¥ SQLite
    m_db = QSqlDatabase::addDatabase("QSQLITE");
    m_db.setDatabaseName(dbPath);

    if (!m_db.open()) {
        qDebug() << "âŒ æ‰“å¼€æ•°æ®åº“å¤±è´¥:" << m_db.lastError().text();
        return false;
    }

    // 3. æ£€æŸ¥å¹¶åˆ›å»ºè¡¨
    createTables();
    return true;
}

void DatabaseManager::createTables()
{
    QSqlQuery query;

    // --- è¡¨1ï¼šä¼šè¯è¡¨ ---
    // id: è‡ªå¢ä¸»é”®
    // title: ä¼šè¯å
    // created_at: åˆ›å»ºæ—¶é—´
    bool success = query.exec(
        "CREATE TABLE IF NOT EXISTS tb_sessions ("
        "id INTEGER PRIMARY KEY AUTOINCREMENT, "
        "title TEXT NOT NULL, "
        "created_at INTEGER"
        ")"
        );
    if (!success) qDebug() << "âŒ tb_sessions å»ºè¡¨å¤±è´¥:" << query.lastError();

    // --- è¡¨2ï¼šæ¶ˆæ¯è¡¨ ---
    // session_id: å±äºå“ªä¸ªä¼šè¯
    // role: 'user' æˆ– 'ai'
    // content: æ–‡å­—å†…å®¹
    // image_path: å›¾ç‰‡è·¯å¾„
    // timestamp: æ—¶é—´
    success = query.exec(
        "CREATE TABLE IF NOT EXISTS tb_messages ("
        "id INTEGER PRIMARY KEY AUTOINCREMENT, "
        "session_id INTEGER, "
        "role TEXT, "
        "content TEXT, "
        "image_path TEXT, "
        "timestamp INTEGER"
        ")"
        );
    if (!success) qDebug() << "âŒ tb_messages å»ºè¡¨å¤±è´¥:" << query.lastError();
}

int DatabaseManager::createSession(const QString& name)
{
    QSqlQuery query;
    // ä½¿ç”¨ prepare é¢„å¤„ç†è¯­å¥ï¼Œ:name æ˜¯å ä½ç¬¦
    query.prepare("INSERT INTO tb_sessions (title, created_at) VALUES (:name, :time)");

    query.bindValue(":name", name);
    query.bindValue(":time", QDateTime::currentMSecsSinceEpoch());

    if (query.exec()) {
        // è¿”å›æ–°æ’å…¥è¡Œçš„è‡ªå¢ ID
        return query.lastInsertId().toInt();
    }

    qDebug() << "âŒ åˆ›å»ºä¼šè¯å¤±è´¥:" << query.lastError();
    return -1;
}

QVector<SessionData> DatabaseManager::getAllSessions()
{
    QVector<SessionData> list;
    QSqlQuery query("SELECT * FROM tb_sessions ORDER BY created_at DESC"); // æŒ‰æ—¶é—´å€’åºï¼Œæ–°çš„åœ¨ä¸Šé¢

    while (query.next()) {
        SessionData session;
        session.id = query.value("id").toInt();
        session.name = query.value("title").toString();
        session.createdAt = query.value("created_at").toLongLong();
        list.append(session);
    }
    return list;
}

bool DatabaseManager::renameSession(int id, const QString& newName)
{
    QSqlQuery query;
    query.prepare("UPDATE tb_sessions SET title = :name WHERE id = :id");
    query.bindValue(":name", newName);
    query.bindValue(":id", id);
    return query.exec();
}

bool DatabaseManager::deleteSession(int id)
{
    // 1. å…ˆåˆ æ¶ˆæ¯ (è™½ç„¶ SQLite å¯ä»¥è®¾çº§è”åˆ é™¤ï¼Œä½†æ‰‹åŠ¨åˆ æ›´ç¨³å¦¥)
    QSqlQuery queryMsg;
    queryMsg.prepare("DELETE FROM tb_messages WHERE session_id = :sid");
    queryMsg.bindValue(":sid", id);
    queryMsg.exec();

    // 2. å†åˆ ä¼šè¯
    QSqlQuery query;
    query.prepare("DELETE FROM tb_sessions WHERE id = :id");
    query.bindValue(":id", id);
    return query.exec();
}

// =========================================================
// æ¶ˆæ¯æ“ä½œå®ç°
// =========================================================

int DatabaseManager::addMessage(const MessageData& msg)
{
    QSqlQuery query;
    query.prepare("INSERT INTO tb_messages (session_id, role, content, image_path, timestamp) "
                  "VALUES (:sid, :role, :content, :img, :time)");

    query.bindValue(":sid", msg.sessionId);
    // æšä¸¾è½¬å­—ç¬¦ä¸²å­˜å…¥
    query.bindValue(":role", msg.role == MessageRole::User ? "user" : "ai");
    query.bindValue(":content", msg.text);
    query.bindValue(":img", msg.imagePath);
    query.bindValue(":time", QDateTime::currentMSecsSinceEpoch());

    if (query.exec()) {
        return query.lastInsertId().toInt();
    }

    qDebug() << "âŒ æ’å…¥æ¶ˆæ¯å¤±è´¥:" << query.lastError();
    return -1;
}

QVector<MessageData> DatabaseManager::getMessages(int sessionId)
{
    QVector<MessageData> list;
    QSqlQuery query;
    // æŒ‰æ—¶é—´æ­£åºï¼Œæ—©è¯´çš„è¯åœ¨ä¸Šé¢
    query.prepare("SELECT * FROM tb_messages WHERE session_id = :sid ORDER BY timestamp ASC");
    query.bindValue(":sid", sessionId);

    if (!query.exec()) {
        qDebug() << "âŒ æŸ¥è¯¢æ¶ˆæ¯å¤±è´¥:" << query.lastError();
        return list;
    }

    while (query.next()) {
        // ä½¿ç”¨æ„é€ å‡½æ•°æ–¹ä¾¿ä¸€ç‚¹ï¼Œæˆ–è€…æ‰‹åŠ¨èµ‹å€¼
        // int sid, MessageRole r, const QString& t, const QString& img
        int id = query.value("id").toInt();
        int sid = query.value("session_id").toInt();
        QString roleStr = query.value("role").toString();
        QString content = query.value("content").toString();
        QString imgPath = query.value("image_path").toString();
        qint64 time = query.value("timestamp").toLongLong();

        MessageRole role = (roleStr == "user") ? MessageRole::User : MessageRole::AI;

        MessageData msg(sid, role, content, imgPath);
        msg.id = id;
        msg.timestamp = time;

        list.append(msg);
    }
    return list;
}


QVector<QString> DatabaseManager::getAllAiImages()
{
    QVector<QString> list;
    QSqlQuery query;
    // æŸ¥è¯¢æ‰€æœ‰ role ä¸º 'ai' ä¸” image_path ä¸ä¸ºç©ºçš„è®°å½•ï¼ŒæŒ‰æ—¶é—´å€’åºæ’åˆ—
    query.prepare("SELECT image_path FROM tb_messages WHERE role = 'ai' AND image_path != '' ORDER BY timestamp DESC");

    if (query.exec()) {
        while (query.next()) {
            list.append(query.value("image_path").toString());
        }
    } else {
        qDebug() << "âŒ æŸ¥è¯¢å†å²å›¾ç‰‡å¤±è´¥:" << query.lastError();
    }
    return list;
}


--- æ–‡ä»¶ç»“æŸ: src\Database\DatabaseManager.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Database\DatabaseManager.h ---

#pragma once
#include <QObject>
#include <QSqlDatabase>
#include <QVector>
#include "../Model/DataModels.h"

class DatabaseManager : public QObject
{
    Q_OBJECT
public:
    // å•ä¾‹æ¨¡å¼ï¼šå…¨å±€åªæœ‰ä¸€ä¸ªæ•°æ®åº“è¿æ¥
    static DatabaseManager& instance();

    // åˆå§‹åŒ–ï¼šæ‰“å¼€æ•°æ®åº“ã€å»ºè¡¨
    bool init();

    // ==========================================
    // ã€æ–°å¢ã€‘ä¼šè¯æ“ä½œæ¥å£ (Session API)
    // ==========================================

    // åˆ›å»ºæ–°ä¼šè¯ï¼Œè¿”å›æ–°ç”Ÿæˆçš„ ID
    int createSession(const QString& name);

    // è·å–æ‰€æœ‰ä¼šè¯ (ç”¨äºåˆå§‹åŒ–å·¦ä¾§åˆ—è¡¨)
    QVector<SessionData> getAllSessions();

    // é‡å‘½åä¼šè¯
    bool renameSession(int id, const QString& newName);

    // åˆ é™¤ä¼šè¯ (ä¼šè¿å¸¦åˆ é™¤è¯¥ä¼šè¯ä¸‹çš„æ‰€æœ‰æ¶ˆæ¯)
    bool deleteSession(int id);

    // ==========================================
    // ã€æ–°å¢ã€‘æ¶ˆæ¯æ“ä½œæ¥å£ (Message API)
    // ==========================================

    // å­˜å…¥ä¸€æ¡æ–°æ¶ˆæ¯ï¼Œè¿”å›æ–° ID
    int addMessage(const MessageData& msg);

    // è·å–æŸä¸ªä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯ (ç”¨äºç‚¹å‡»ä¼šè¯ååŠ è½½å†å²)
    QVector<MessageData> getMessages(int sessionId);

    // ã€æ–°å¢ã€‘è·å–æ‰€æœ‰ç”Ÿæˆçš„å›¾ç‰‡è·¯å¾„ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
    QVector<QString> getAllAiImages();

private:
    explicit DatabaseManager(QObject *parent = nullptr);
    ~DatabaseManager();
    DatabaseManager(const DatabaseManager&) = delete;
    DatabaseManager& operator=(const DatabaseManager&) = delete;
    void createTables();

private:
    QSqlDatabase m_db;
};


--- æ–‡ä»¶ç»“æŸ: src\Database\DatabaseManager.h ---

--- æ–‡ä»¶å¼€å§‹: src\Model\DataModels.h ---

/**
 * @file DataModels.h
 * @brief æ ¸å¿ƒæ•°æ®æ¨¡å‹å®šä¹‰
 */

#pragma once
#include <QString>
#include <QDateTime>

// æ¶ˆæ¯å‘é€è€…è§’è‰² (å¯¹åº”æ•°æ®åº“é‡Œçš„ role å­—æ®µ)
enum class MessageRole {
    User, // ç”¨æˆ·
    AI    // AI
};

// ä¼šè¯æ•°æ®ç»“æ„
struct SessionData {
    int id = -1;                // æ•°æ®åº“ID
    QString name;               // ä¼šè¯æ ‡é¢˜
    qint64 createdAt = 0;       // åˆ›å»ºæ—¶é—´æˆ³

    // 1. é»˜è®¤æ„é€ å‡½æ•° (å¿…é¡»æœ‰)
    SessionData() {}

    // 2. ä¾¿æ·æ„é€ å‡½æ•° (æ–¹ä¾¿ä»£ç é‡Œä¸€è¡Œåˆå§‹åŒ–)
    SessionData(int _id, const QString& _name)
        : id(_id), name(_name), createdAt(QDateTime::currentMSecsSinceEpoch()) {}
};

// æ¶ˆæ¯æ•°æ®ç»“æ„
struct MessageData {
    int id = -1;
    int sessionId = -1;         // å¤–é”®
    MessageRole role = MessageRole::User;

    QString text;               // æ–‡å­—å†…å®¹
    QString imagePath;          // æœ¬åœ°å›¾ç‰‡è·¯å¾„ (å¦‚æœæ˜¯æ–‡å­—åˆ™ä¸ºç©º)

    qint64 timestamp = 0;       // æ—¶é—´

    // è¾…åŠ©å‡½æ•°ï¼šåˆ¤æ–­æ˜¯å¦æ˜¯å›¾ç‰‡
    bool isImage() const { return !imagePath.isEmpty(); }

    // 1. é»˜è®¤æ„é€ å‡½æ•° (å¿…é¡»æœ‰ï¼Œç”¨äº QSqlQuery è¯»å–æ—¶å…ˆåˆ›å»ºç©ºå¯¹è±¡)
    MessageData() {}

    // 2. ã€å…³é”®ä¿®å¤ã€‘ä¾¿æ·æ„é€ å‡½æ•° (DatabaseManager.cpp ç¬¬192è¡Œç”¨çš„å°±æ˜¯è¿™ä¸ª)
    // å‚æ•°: ä¼šè¯ID, è§’è‰², æ–‡æœ¬å†…å®¹, å›¾ç‰‡è·¯å¾„(é»˜è®¤ç©º)
    MessageData(int sid, MessageRole r, const QString& t, const QString& img = "")
        : sessionId(sid), role(r), text(t), imagePath(img)
    {
        // è‡ªåŠ¨å¡«å…¥å½“å‰æ—¶é—´
        timestamp = QDateTime::currentMSecsSinceEpoch();
    }
};


--- æ–‡ä»¶ç»“æŸ: src\Model\DataModels.h ---

--- æ–‡ä»¶å¼€å§‹: src\Model\WorkflowTypes.h ---

/**
 * @file WorkflowTypes.h
 * @brief å·¥ä½œæµç±»å‹å®šä¹‰å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†å·¥ä½œæµç›¸å…³çš„æšä¸¾ç±»å‹å’Œæ•°æ®ç»“æ„ã€‚
 * åŒ…å«å·¥ä½œæµç±»å‹æšä¸¾å’Œå·¥ä½œæµä¿¡æ¯ç»“æ„ä½“å®šä¹‰ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once

#include <QString>

/**
 * @brief å·¥ä½œæµç±»å‹æšä¸¾
 * 
 * å®šä¹‰äº†åº”ç”¨ç¨‹åºæ”¯æŒçš„æ‰€æœ‰å·¥ä½œæµç±»å‹ã€‚
 */
enum class WorkflowType {
    TextToImage = 1,      ///< æ–‡ç”Ÿå›¾
    ImageToImage = 2,     ///< å›¾ç”Ÿå›¾
    Inpaint = 3,          ///< å±€éƒ¨é‡ç»˜
    Upscale = 4,          ///< å›¾åƒæ”¾å¤§
    StyleTransfer = 5,    ///< é£æ ¼è½¬æ¢
    PortraitEnhance = 6,  ///< äººåƒç¾åŒ–
    BackgroundRemove = 7, ///< èƒŒæ™¯ç§»é™¤
    ColorCorrection = 8,   ///< è‰²å½©æ ¡æ­£
    VisionCaption = 9 // ã€æ–°å¢ã€‘è§†è§‰åæ¨
};

/**
 * @brief å·¥ä½œæµä¿¡æ¯ç»“æ„ä½“
 * 
 * åŒ…å«å•ä¸ªå·¥ä½œæµçš„å®Œæ•´ä¿¡æ¯ï¼Œç”¨äºç•Œé¢æ˜¾ç¤ºå’ŒåŠŸèƒ½å¤„ç†ã€‚
 */
struct WorkflowInfo {
    int id; ///< å·¥ä½œæµå”¯ä¸€æ ‡è¯†ç¬¦
    QString name; ///< å·¥ä½œæµåç§°
    QString imagePath; ///< å·¥ä½œæµå›¾æ ‡è·¯å¾„
    QString gifPath; ///< å·¥ä½œæµåŠ¨ç”»è·¯å¾„ï¼ˆå¯é€‰ï¼‰
    QString description; ///< å·¥ä½œæµæè¿°ï¼ˆå¯é€‰ï¼‰
    WorkflowType type; ///< å·¥ä½œæµç±»å‹
    
    /**
     * @brief æ„é€ å‡½æ•°
     * @param id å·¥ä½œæµID
     * @param name å·¥ä½œæµåç§°
     * @param imagePath å›¾æ ‡è·¯å¾„
     * @param gifPath åŠ¨ç”»è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸ºç©ºï¼‰
     * @param description æè¿°ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸ºç©ºï¼‰
     * @param type å·¥ä½œæµç±»å‹ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸ºæ–‡ç”Ÿå›¾ï¼‰
     */
    WorkflowInfo(int id, const QString& name, const QString& imagePath, 
                 const QString& gifPath = "", const QString& description = "", WorkflowType type = WorkflowType::TextToImage)
        : id(id), name(name), imagePath(imagePath), gifPath(gifPath), description(description), type(type) {}
};


--- æ–‡ä»¶ç»“æŸ: src\Model\WorkflowTypes.h ---

--- æ–‡ä»¶å¼€å§‹: src\Network\ComfyApiService.cpp ---

#include "ComfyApiService.h"
#include <QNetworkRequest>
#include <QJsonDocument>
#include <QJsonObject>
#include <QJsonArray>   // è§£ææ•°ç»„éœ€è¦
#include <QUrl>
#include <QUrlQuery>    // ã€å…³é”®ä¿®å¤ã€‘
#include <QDebug>
#include <QWebSocket>
#include <QHttpMultiPart> // ã€æ–°å¢ã€‘
#include <QHttpPart>      // ã€æ–°å¢ã€‘
#include <QFile>          // ã€æ–°å¢ã€‘
#include <QFileInfo>      // ã€æ–°å¢ã€‘
#include <QSslConfiguration>
#include <QSslSocket>

ComfyApiService::ComfyApiService(QObject *parent)
    : QObject(parent)
{
    m_networkManager = new QNetworkAccessManager(this);
    m_webSocket = new QWebSocket(QString(), QWebSocketProtocol::VersionLatest, this);

    // ç”Ÿæˆ ID
    m_clientId = QUuid::createUuid().toString(QUuid::WithoutBraces);

    // --- 1. è¿æ¥æˆåŠŸä¿¡å· ---
    connect(m_webSocket, &QWebSocket::connected, this, [=](){
        qDebug() << "âœ… WebSocket è¿æ¥æˆåŠŸ!";
        emit serverConnected();
    });

    // --- 2. è¿æ¥æ–­å¼€ä¿¡å· (å…³é”®) ---
    connect(m_webSocket, &QWebSocket::disconnected, this, [=](){
        qDebug() << "âŒ WebSocket è¿æ¥æ–­å¼€";
        emit serverDisconnected();
    });

    // --- 3. è¿æ¥é”™è¯¯ä¿¡å· (å…³é”®) ---
    // Qt6 å†™æ³•ï¼šä½¿ç”¨ lambda æ¥æ”¶é”™è¯¯ä¿¡æ¯
    connect(m_webSocket, &QWebSocket::errorOccurred, this, [=](QAbstractSocket::SocketError error){
        Q_UNUSED(error);
        QString errStr = m_webSocket->errorString();
        qDebug() << "âš ï¸ WebSocket é”™è¯¯:" << errStr;
        emit errorOccurred(errStr);
    });

    // --- 4. æ”¶åˆ°æ¶ˆæ¯ä¿¡å· ---
    connect(m_webSocket, &QWebSocket::textMessageReceived,
            this, &ComfyApiService::onTextMessageReceived);
}

ComfyApiService::~ComfyApiService()
{
    // socket å’Œ networkManager æŒ‡å®šäº† parent ä¸º thisï¼Œææ„æ—¶ä¼šè‡ªåŠ¨æ¸…ç†
    // ä½†ä¸ºäº†ä¼˜é›…é€€å‡ºï¼Œå¯ä»¥åœ¨è¿™é‡Œæ‰‹åŠ¨ close ä¸€ä¸‹
    if (m_webSocket) {
        m_webSocket->close();
    }
}

void ComfyApiService::connectToHost(const QString& fullUrl)
{
    QString urlStr = fullUrl.trimmed();

    // 1. å®¹é”™å¤„ç†ï¼šå¦‚æœç”¨æˆ·æ²¡å†™ http://ï¼Œé»˜è®¤è¡¥ä¸Š
    if (!urlStr.startsWith("http://") && !urlStr.startsWith("https://")) {
        urlStr = "http://" + urlStr;
    }

    // 2. å»æ‰æœ«å°¾çš„æ–œæ  (ä¸ºäº†åç»­æ‹¼æ¥æ–¹ä¾¿)
    if (urlStr.endsWith("/")) {
        urlStr.chop(1);
    }

    // 3. ä¿å­˜ HTTP åŸºç¡€åœ°å€ (ä¾‹å¦‚: http://frp.top:12345)
    m_apiBaseUrl = urlStr;

    // 4. ç”Ÿæˆ WebSocket åœ°å€
    // æŠŠ http æ¢æˆ wsï¼ŒæŠŠ https æ¢æˆ wss
    QString wsUrl = m_apiBaseUrl;
    if (wsUrl.startsWith("https://")) {
        wsUrl.replace(0, 8, "wss://");
    } else {
        wsUrl.replace(0, 7, "ws://");
    }

    // åŠ ä¸Š WebSocket è·¯å¾„å’Œ ClientID
    wsUrl += QString("/ws?clientId=%1").arg(m_clientId);

    qDebug() << "ğŸ”— å‡†å¤‡è¿æ¥:" << wsUrl;

    if (m_webSocket->state() == QAbstractSocket::ConnectedState) {
        m_webSocket->close();
    }

    // ================== ã€æ–°å¢ä»£ç å¼€å§‹ã€‘ ==================
    // é…ç½® SSLï¼Œå…è®¸è‡ªç­¾åè¯ä¹¦æˆ–ä¸å®‰å…¨çš„è¯ä¹¦
    QSslConfiguration sslConfig = m_webSocket->sslConfiguration();
    sslConfig.setPeerVerifyMode(QSslSocket::VerifyNone); // æ ¸å¿ƒï¼šä¸éªŒè¯æœåŠ¡å™¨è¯ä¹¦
    sslConfig.setProtocol(QSsl::AnyProtocol);
    m_webSocket->setSslConfiguration(sslConfig);

    // é¢å¤–ä¿é™©ï¼šå¦‚æœå‘ç”Ÿ SSL é”™è¯¯ï¼Œå¼ºåˆ¶å¿½ç•¥
    connect(m_webSocket, &QWebSocket::sslErrors, this, [=](const QList<QSslError>& errors){
        qDebug() << "âš ï¸ æ•è·åˆ° SSL é”™è¯¯ (å·²å¿½ç•¥):" << errors.first().errorString();
        m_webSocket->ignoreSslErrors();
    });
    // ================== ã€æ–°å¢ä»£ç ç»“æŸã€‘ ==================


    // æ‰“å¼€æ–°è¿æ¥
    m_webSocket->open(QUrl(wsUrl));
}

void ComfyApiService::queuePrompt(const QJsonObject& workflow)
{
    // ä¿®æ”¹è¿™é‡Œï¼šä½¿ç”¨ m_apiBaseUrl
    QUrl url(m_apiBaseUrl + "/prompt");
    QNetworkRequest request(url);

    // ... ä¸‹é¢çš„ä»£ç ä¿æŒä¸å˜ ...
    request.setHeader(QNetworkRequest::ContentTypeHeader, "application/json");
    QJsonObject payload;
    payload["prompt"] = workflow;
    payload["client_id"] = m_clientId;
    QByteArray data = QJsonDocument(payload).toJson();

    qDebug() << "Posting prompt to:" << url.toString(); // æ–¹ä¾¿è°ƒè¯•
    QNetworkReply* reply = m_networkManager->post(request, data);

    // ã€ä¿®æ”¹ä¸º Lambda å†™æ³•ã€‘
    connect(reply, &QNetworkReply::sslErrors, reply, [reply](const QList<QSslError> &errors){
        Q_UNUSED(errors);          // é˜²æ­¢ç¼–è¯‘å™¨è­¦å‘Šâ€œæœªä½¿ç”¨çš„å˜é‡â€
        reply->ignoreSslErrors();  // å¼ºåˆ¶å¿½ç•¥é”™è¯¯
    });

    connect(reply, &QNetworkReply::finished, this, &ComfyApiService::onPostFinished);
}

void ComfyApiService::onPostFinished()
{
    // è·å–è§¦å‘è¿™ä¸ªæ§½çš„ reply å¯¹è±¡
    QNetworkReply* reply = qobject_cast<QNetworkReply*>(sender());
    if (!reply) return;

    if (reply->error() == QNetworkReply::NoError) {
        // è¯·æ±‚æˆåŠŸï¼
        QByteArray response = reply->readAll();
        QJsonDocument doc = QJsonDocument::fromJson(response);
        QJsonObject obj = doc.object();

        // ComfyUI ä¼šè¿”å› {"prompt_id": "xxx", "number": ...}
        QString promptId = obj["prompt_id"].toString();

        // ã€æ–°å¢ã€‘ä¿å­˜è¿™ä¸ª IDï¼Œåé¢æ”¶åˆ°æ¶ˆæ¯æ—¶æ ¸å¯¹æ˜¯ä¸æ˜¯æˆ‘ä»¬å‘çš„
        m_currentPromptId = promptId;

        qDebug() << "âœ… ä»»åŠ¡å‘é€æˆåŠŸ! ID:" << promptId;

        emit promptQueued(promptId);
    } else {
        // è¯·æ±‚å¤±è´¥
        QString err = "å‘é€ä»»åŠ¡å¤±è´¥: " + reply->errorString();
        qDebug() << "âŒ" << err;
        emit errorOccurred(err);
    }

    reply->deleteLater(); // è®°å¾—æ¸…ç†å†…å­˜
}


void ComfyApiService::onTextMessageReceived(const QString &message)
{
    QJsonDocument doc = QJsonDocument::fromJson(message.toUtf8());
    QJsonObject root = doc.object();
    QString msgType = root["type"].toString();
    QJsonObject data = root["data"].toObject();

    // 1. å¤„ç†æµå¼æ¶ˆæ¯
    if (msgType == "cloudart_stream") {
        QString token = data["token"].toString();
        bool finished = data["finished"].toBool();
        emit streamTokenReceived(token, finished);
        return;
    }

    // 2. å¤„ç†èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ
    if (msgType == "executed") {
        // ã€å¼ºåˆ¶è½¬æ¢ã€‘æŠŠ node è½¬æˆå­—ç¬¦ä¸²ï¼Œé˜²æ­¢ JSON æ•°å­—/å­—ç¬¦ä¸²ç±»å‹ä¸åŒ¹é…
        QString nodeId = QString::number(data["node"].toInt());
        // å¦‚æœè½¬æ•°å­—å¤±è´¥ï¼ˆè¯´æ˜æœ¬èº«æ˜¯å­—ç¬¦ä¸²ï¼‰ï¼Œå†ç›´æ¥è½¬å­—ç¬¦ä¸²
        if (nodeId == "0") nodeId = data["node"].toString();

        QString promptId = data["prompt_id"].toString();

        // ã€å¼ºåŠ›è°ƒè¯•ã€‘æ‰“å°è¿™ä¸€è¡Œï¼Œçœ‹çœ‹åˆ°åº•æ”¶åˆ°äº†ä»€ä¹ˆ
        qDebug() << "ğŸ” æ£€æŸ¥ç»“æŸæ¡ä»¶ | æ”¶åˆ°ID:" << nodeId << " | ç›®æ ‡ID: 4 | ä»»åŠ¡åŒ¹é…:" << (promptId == m_currentPromptId);

        // é€»è¾‘ A: æ–‡ç”Ÿå›¾/é«˜æ¸…ä¿®å¤ (SaveImage)
        if (promptId == m_currentPromptId && (nodeId == "20" || nodeId == "1" || nodeId == "9")) {
            // ... (ä¿æŒåŸæœ‰çš„å›¾ç‰‡ä¸‹è½½é€»è¾‘) ...
            QJsonObject output = data["output"].toObject();
            QJsonArray images = output["images"].toArray();
            if (!images.isEmpty()) {
                QJsonObject imgInfo = images[0].toObject();
                getImage(imgInfo["filename"].toString(),
                         imgInfo["subfolder"].toString(),
                         imgInfo["type"].toString(), promptId);
            }
        }

        // é€»è¾‘ B: è§†è§‰åæ¨ (PreviewAny)
        // ã€ä¿®æ”¹ã€‘æ”¾å®½æ¡ä»¶ï¼Œåªè¦æ˜¯å½“å‰ä»»åŠ¡ä¸” ID æ˜¯ 4ï¼Œæˆ–è€…å®ƒæ˜¯å”¯ä¸€çš„è¾“å‡ºèŠ‚ç‚¹
        if (promptId == m_currentPromptId && nodeId == "4") {
            qDebug() << "ğŸ›‘ è§¦å‘åæ¨å¼ºåˆ¶è§£é”";
            emit streamTokenReceived("", true);
        }
    }
}


void ComfyApiService::getImage(const QString& filename, const QString& subfolder, const QString& type, const QString& promptId)
{
    QUrl url(m_apiBaseUrl + "/view");
    QUrlQuery query;
    query.addQueryItem("filename", filename);
    query.addQueryItem("subfolder", subfolder);
    query.addQueryItem("type", type);
    url.setQuery(query);

    QNetworkRequest request(url);
    QNetworkReply* reply = m_networkManager->get(request);

    // ã€ä¿®æ”¹ä¸º Lambda å†™æ³•ã€‘
    connect(reply, &QNetworkReply::sslErrors, reply, [reply](const QList<QSslError> &errors){
        Q_UNUSED(errors);
        reply->ignoreSslErrors();
    });

    // ã€å…³é”®ã€‘æŠŠ ID å’Œ æ–‡ä»¶å å­˜å…¥ reply çš„å±æ€§ä¸­ï¼Œä»¥ä¾¿å›è°ƒæ—¶ä½¿ç”¨
    reply->setProperty("promptId", promptId);
    reply->setProperty("filename", filename);

    connect(reply, &QNetworkReply::finished, this, &ComfyApiService::onImageDownloadFinished);
}

void ComfyApiService::onImageDownloadFinished()
{
    QNetworkReply* reply = qobject_cast<QNetworkReply*>(sender());
    if (!reply) return;

    // ã€å…³é”®ã€‘å–å‡ºåˆšæ‰å­˜çš„æ•°æ®
    QString promptId = reply->property("promptId").toString();
    QString filename = reply->property("filename").toString();

    if (reply->error() == QNetworkReply::NoError) {
        QByteArray data = reply->readAll();
        QPixmap pixmap;
        if (pixmap.loadFromData(data)) {
            qDebug() << "ğŸ–¼ï¸ å›¾ç‰‡ä¸‹è½½æˆåŠŸ:" << filename;

            // ã€ä¿®æ”¹ã€‘å‘é€åŒ…å« ID å’Œæ–‡ä»¶åçš„ä¿¡å·
            emit imageReceived(promptId, filename, pixmap);
        } else {
            qDebug() << "âŒ å›¾ç‰‡æ•°æ®æŸå";
        }
    } else {
        qDebug() << "âŒ å›¾ç‰‡ä¸‹è½½å¤±è´¥:" << reply->errorString();
    }
    reply->deleteLater();
}


void ComfyApiService::uploadImage(const QString& localPath)
{
    // 1. æ‰“å¼€æœ¬åœ°æ–‡ä»¶
    QFile* file = new QFile(localPath);
    if (!file->open(QIODevice::ReadOnly)) {
        qDebug() << "âŒ æ— æ³•æ‰“å¼€æœ¬åœ°å›¾ç‰‡:" << localPath;
        delete file;
        return;
    }

    // 2. æ„é€  Multipart è¡¨å•
    QHttpMultiPart *multiPart = new QHttpMultiPart(QHttpMultiPart::FormDataType);

    // å›¾ç‰‡éƒ¨åˆ†
    QHttpPart imagePart;
    QString fileName = QFileInfo(localPath).fileName();

    // è®¾ç½®å¤´ä¿¡æ¯
    imagePart.setHeader(QNetworkRequest::ContentTypeHeader, QVariant("image/png")); // å‡è®¾æ˜¯png/jpg
    imagePart.setHeader(QNetworkRequest::ContentDispositionHeader,
                        QVariant(QString("form-data; name=\"image\"; filename=\"%1\"").arg(fileName)));

    imagePart.setBodyDevice(file);
    file->setParent(multiPart); // è®© multiPart ç®¡ç† file çš„ç”Ÿå‘½å‘¨æœŸ

    multiPart->append(imagePart);

    // 3. æ„é€ è¯·æ±‚ URL: http://ip:port/upload/image
    QUrl url(m_apiBaseUrl + "/upload/image");
    QNetworkRequest request(url);

    qDebug() << "ğŸ“¤ æ­£åœ¨ä¸Šä¼ å›¾ç‰‡:" << localPath;

    // 4. å‘é€ POST
    QNetworkReply* reply = m_networkManager->post(request, multiPart);
    multiPart->setParent(reply); // è®© reply ç®¡ç† multiPart çš„ç”Ÿå‘½å‘¨æœŸ

    // ã€ä¿®æ”¹ä¸º Lambda å†™æ³•ã€‘
    connect(reply, &QNetworkReply::sslErrors, reply, [reply](const QList<QSslError> &errors){
        Q_UNUSED(errors);
        reply->ignoreSslErrors();
    });

    // 5. å¤„ç†ç»“æœ
    connect(reply, &QNetworkReply::finished, this, [=](){
        if (reply->error() == QNetworkReply::NoError) {
            QByteArray response = reply->readAll();
            QJsonDocument doc = QJsonDocument::fromJson(response);
            QJsonObject obj = doc.object();

            // ComfyUI è¿”å›: {"name": "xxx.png", "subfolder": "...", "type": "input"}
            QString serverName = obj["name"].toString();
            // å¦‚æœæœ‰ subfolderï¼Œå¯ä»¥æ‹¼ä¸€ä¸‹ï¼Œé€šå¸¸ simple workflow ä¸éœ€è¦

            qDebug() << "âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ! æœåŠ¡å™¨æ–‡ä»¶å:" << serverName;
            emit imageUploaded(serverName); // å‘å‡ºä¿¡å·
        } else {
            qDebug() << "âŒ ä¸Šä¼ å¤±è´¥:" << reply->errorString();
        }
        reply->deleteLater();
    });
}


--- æ–‡ä»¶ç»“æŸ: src\Network\ComfyApiService.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Network\ComfyApiService.h ---

/**
 * @file ComfyApiService.h
 * @brief ComfyUI APIæœåŠ¡ç±»å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†ComfyApiServiceç±»ï¼Œç”¨äºä¸ComfyUIæœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚
 * åŒ…å«HTTPè¯·æ±‚å’ŒWebSocketè¿æ¥åŠŸèƒ½ï¼Œæ”¯æŒå›¾ç‰‡ç”Ÿæˆè¿›åº¦ç›‘æ§å’Œç»“æœæ¥æ”¶ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once

#include <QObject>
#include <QPixmap>
#include <QJsonObject>
#include <QNetworkReply>
#include <QUuid>
#include <QHttpMultiPart>

// å‰å‘å£°æ˜
class QNetworkAccessManager;
class QWebSocket;

/**
 * @brief ComfyUI APIæœåŠ¡ç±»
 * 
 * è´Ÿè´£ä¸ComfyUIæœåŠ¡å™¨è¿›è¡ŒHTTPå’ŒWebSocketé€šä¿¡ï¼Œ
 * å¤„ç†å›¾ç‰‡ç”Ÿæˆè¯·æ±‚ã€è¿›åº¦ç›‘æ§å’Œç»“æœæ¥æ”¶ã€‚
 */
class ComfyApiService : public QObject
{
    Q_OBJECT

public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param parent çˆ¶å¯¹è±¡æŒ‡é’ˆ
     */
    explicit ComfyApiService(QObject *parent = nullptr);

    /**
     * @brief ææ„å‡½æ•°
     */
    ~ComfyApiService();

    /**
     * @brief è¿æ¥åˆ°ComfyUIæœåŠ¡å™¨
     * @param address æœåŠ¡å™¨åœ°å€
     * @param port æœåŠ¡å™¨ç«¯å£
     */
    void connectToHost(const QString& baseUrl);

    /**
     * @brief å‘é€æç¤ºè¯ç”Ÿæˆä»»åŠ¡
     * @param workflow å·¥ä½œæµJSONå¯¹è±¡
     */
    void queuePrompt(const QJsonObject& workflow);

    // ã€æ–°å¢ã€‘è·å–å›¾ç‰‡æ•°æ®çš„æ¥å£ (é€šè¿‡ HTTP GET)
    void getImage(const QString& filename, const QString& subfolder, const QString& type, const QString& promptId);

    // ã€æ–°å¢ã€‘ä¸Šä¼ å›¾ç‰‡å‡½æ•°
    void uploadImage(const QString& localPath);

signals:
    /**
     * @brief æœåŠ¡å™¨è¿æ¥æˆåŠŸä¿¡å·
     */
    void serverConnected();

    /**
     * @brief æœåŠ¡å™¨è¿æ¥æ–­å¼€ä¿¡å·
     */
    void serverDisconnected();

    /**
     * @brief ç”Ÿæˆè¿›åº¦æ›´æ–°ä¿¡å·
     * @param step å½“å‰æ­¥éª¤
     * @param total æ€»æ­¥éª¤æ•°
     */
    void progressUpdated(int step, int total);

    /**
     * @brief é”™è¯¯å‘ç”Ÿä¿¡å·
     * @param msg é”™è¯¯æ¶ˆæ¯
     */
    void errorOccurred(const QString& msg);

    void promptQueued(const QString& promptId);

    // ã€æ–°å¢ã€‘å›¾ç‰‡ä¸‹è½½å®Œæˆä¿¡å·
    void imageReceived(const QString& promptId, const QString& filename, const QPixmap& img);

    // ã€æ–°å¢ã€‘ä¸Šä¼ æˆåŠŸä¿¡å·
    void imageUploaded(const QString& serverFileName);

    // ã€æ–°å¢ã€‘æµå¼æ–‡å­—ä¿¡å·(å¦‚æœä¹‹å‰æ²¡åŠ )
    void streamTokenReceived(const QString& token, bool finished);

private slots:
    // ã€æ–°å¢ã€‘å¤„ç† HTTP å›å¤
    void onPostFinished();

    // ã€æ–°å¢ã€‘å¤„ç† WebSocket æ–‡æœ¬æ¶ˆæ¯
    void onTextMessageReceived(const QString &message);

    // ã€æ–°å¢ã€‘å¤„ç†å›¾ç‰‡ä¸‹è½½å®Œæˆ
    void onImageDownloadFinished();

private:
    QNetworkAccessManager* m_networkManager; ///< HTTPç½‘ç»œç®¡ç†å™¨
    QWebSocket* m_webSocket; ///< WebSocketè¿æ¥
    QString m_apiBaseUrl;
    // ã€æ–°å¢ã€‘è®°å½•å½“å‰çš„ä»»åŠ¡IDï¼Œç”¨äºåŒ¹é…
    QString m_currentPromptId;
    QString m_clientId;
};


--- æ–‡ä»¶ç»“æŸ: src\Network\ComfyApiService.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\MainWindow.cpp ---

/**
 * @file MainWindow.cpp
 * @brief ä¸»çª—å£å®ç°æ–‡ä»¶
 *
 * è¯¥æ–‡ä»¶å®ç°äº†MainWindowç±»ï¼Œä½œä¸ºåº”ç”¨ç¨‹åºçš„ä¸»çª—å£ã€‚
 * åŒ…å«ç•Œé¢å¸ƒå±€ã€ç»„ä»¶ç®¡ç†ã€ä¿¡å·è¿æ¥å’Œäº‹ä»¶å¤„ç†ç­‰åŠŸèƒ½ã€‚
 *
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#include "MainWindow.h"
#include "Components/SidebarControl.h"
#include "Components/SessionList.h"
#include "Components/ChatArea.h"
#include "Components/InputPanel.h"      // å¿…é¡»åŒ…å«è¿™ä¸ª
#include "Components/WorkflowSelector.h"
#include "Components/ReferencePopup.h"  // å¿…é¡»åŒ…å«è¿™ä¸ª
#include "Components/ChatBubble.h"
#include "../Network/ComfyApiService.h"  // æ–°å¢
#include "../Core/WorkflowManager.h"
#include "../Model/DataModels.h"
#include "Components/HistoryGallery.h" // ã€æ–°å¢ã€‘
#include "Components/ImageViewer.h"

#include <QHBoxLayout>
#include <QVBoxLayout>
#include <QToolButton>
#include <QPropertyAnimation>
#include <QToolTip>
#include <QTimer>
#include <QVBoxLayout>
#include <QResizeEvent>
#include <limits>
#include <QDebug>
#include <QRandomGenerator> // ç”¨äºç”Ÿæˆéšæœºç§å­
#include <QStandardPaths>
#include <QFileDialog>
#include <QStandardPaths>
#include <QDir>
#include <QDateTime>
#include <QSettings>

/**
 * @brief æ„é€ å‡½æ•°
 * @param parent çˆ¶çª—å£æŒ‡é’ˆ
 *
 * åˆå§‹åŒ–ä¸»çª—å£ï¼Œè®¾ç½®çª—å£å±æ€§å¹¶åˆ›å»ºUIç•Œé¢ã€‚
 */
MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , m_leftStack(nullptr)
    , m_sessionList(nullptr)
    , m_chatArea(nullptr)
    , m_inputPanel(nullptr)
    , m_wfSelector(nullptr)
    , m_refPopup(nullptr)
    , m_sidebarControl(nullptr)
    , m_leftContainerVisible(true)
    , m_leftContainerOriginalWidth(250) // é»˜è®¤å®½åº¦
    , m_currentPageIndex(0) // é»˜è®¤æ˜¾ç¤ºä¼šè¯åˆ—è¡¨
    , m_historyGallery(nullptr)
    , m_leftContainerAnimation(nullptr)
    , m_mainLayout(nullptr)
    , m_apiService(nullptr) // æ–°å¢
{
    setupUi();
}

/**
 * @brief ææ„å‡½æ•°
 *
 * Qtä¼šè‡ªåŠ¨æ¸…ç†å­æ§ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨åˆ é™¤ã€‚
 */
MainWindow::~MainWindow()
{
}

/**
 * @brief åˆå§‹åŒ–UIç•Œé¢
 *
 * åˆ›å»ºä¸»çª—å£çš„æ‰€æœ‰UIç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼š
 * - ä¸­å¿ƒéƒ¨ä»¶å’Œä¸»å¸ƒå±€
 * - å·¦ä¾§ä¼šè¯åˆ—è¡¨
 * - å³ä¾§èŠå¤©åŒºåŸŸå’Œè¾“å…¥é¢æ¿
 * - æµ®åŠ¨çª—å£ï¼ˆå·¥ä½œæµé€‰æ‹©å™¨å’Œå‚è€ƒå›¾å¼¹çª—ï¼‰
 * - ä¿¡å·è¿æ¥å’Œåˆå§‹çŠ¶æ€è®¾ç½®
 */
void MainWindow::setupUi()
{
    this->resize(1280, 800);
    this->setWindowTitle("CloudArt");
    // 1. åˆ›å»ºä¸­å¿ƒéƒ¨ä»¶

    QWidget* central = new QWidget(this);
    this->setCentralWidget(central);

    // 2. é¡¶çº§æ°´å¹³å¸ƒå±€ (å·¦ä¾§åˆ—è¡¨ | å³ä¾§å·¥ä½œåŒº)
    m_mainLayout = new QHBoxLayout(central);
    m_mainLayout->setContentsMargins(0, 0, 0, 0);
    m_mainLayout->setSpacing(0);

    // --- å·¦ä¾§å®¹å™¨å †æ ˆ ---
    m_leftStack = new QStackedWidget(central);

    // æ·»åŠ ä¼šè¯åˆ—è¡¨é¡µé¢
    m_sessionList = new SessionList(m_leftStack);
    m_leftStack->addWidget(m_sessionList);

    // æ·»åŠ å†å²è®°å½•é¡µé¢
    m_historyGallery = new HistoryGallery(m_leftStack);
    // è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨ setStyleSheet äº†ï¼Œå› ä¸ºç»„ä»¶å†…éƒ¨å·²ç»å†™å¥½äº†
    m_leftStack->addWidget(m_historyGallery);

    // è¿æ¥å›¾åº“çš„ç‚¹å‡»ä¿¡å· -> æ‰“å¼€å¤§å›¾æŸ¥çœ‹å™¨
    connect(m_historyGallery, &HistoryGallery::imageClicked, this, [this](const QString& path){
        QPixmap pix(path);
        if (!pix.isNull()) {
            ImageViewer* viewer = new ImageViewer(pix, this);
            viewer->exec(); // æ¨¡æ€æ˜¾ç¤º
            delete viewer;
        }
    });

    // è®¾ç½®é»˜è®¤æ˜¾ç¤ºä¼šè¯åˆ—è¡¨
    m_leftStack->setCurrentIndex(0);

    // ä¿å­˜å·¦ä¾§å®¹å™¨çš„åˆå§‹å®½åº¦ï¼Œæœ€å¤§ä¸è¶…è¿‡250
    m_leftContainerOriginalWidth = 250;
    m_leftStack->setMaximumWidth(250);

    m_mainLayout->insertWidget(0, m_leftStack);

    // --- å³ä¾§å®¹å™¨ ---
    QWidget* rightWidget = new QWidget(central);
    QVBoxLayout* rightLayout = new QVBoxLayout(rightWidget);
    rightLayout->setContentsMargins(0, 0, 0, 0);
    rightLayout->setSpacing(0);

    // A. å³ä¸Šï¼šèŠå¤©åŒºåŸŸ (ChatArea) - å æ®ä¸»è¦ç©ºé—´ (Stretch = 1)
    m_chatArea = new ChatArea(rightWidget);
    rightLayout->addWidget(m_chatArea, 1);

    // B. å³ä¸‹ï¼šè¾“å…¥æ§åˆ¶æ¿ (InputPanel) - ã€è¿™é‡Œå°±æ˜¯åˆ›å»ºå®ƒçš„åœ°æ–¹ï¼ã€‘
    m_inputPanel = new InputPanel(rightWidget);
    rightLayout->addWidget(m_inputPanel);

    // å°†å³ä¾§æ•´ä½“åŠ å…¥ä¸»å¸ƒå±€
    m_mainLayout->addWidget(rightWidget);

    // ---------------------------------------------------------
    // ä¸‹é¢æ˜¯æµ®åŠ¨çª—å£çš„åˆå§‹åŒ– (ä¸åŠ å…¥ Layoutï¼Œç‹¬ç«‹å­˜åœ¨çš„)
    // ---------------------------------------------------------

    // åˆå§‹åŒ–ä¸šåŠ¡ç®¡ç†å™¨
    m_wfManager = new WorkflowManager(this);

    // 1. åˆå§‹åŒ–å·¥ä½œæµé€‰æ‹©å™¨
    m_wfSelector = new WorkflowSelector(this);


    // 2. åˆå§‹åŒ–å‚è€ƒå›¾å¼¹çª—
    m_refPopup = new ReferencePopup(this);

    // ---------------------------------------------------------
    // åˆ‡æ¢æŒ‰é’®å’ŒåŠ¨ç”»åˆå§‹åŒ–
    // ---------------------------------------------------------
    // ä¾§è¾¹æ æ§åˆ¶ç»„ä»¶åˆå§‹åŒ–
    // ---------------------------------------------------------

    m_sidebarControl = new SidebarControl(this);

    // åˆ›å»ºåŠ¨ç”»æ•ˆæœ - ä½¿ç”¨minimumWidthå’ŒmaximumWidthæ§åˆ¶æ”¶ç¼©
    m_leftContainerAnimation = new QPropertyAnimation(m_leftStack, "minimumWidth", this);
    m_leftContainerAnimation->setDuration(300); // 300æ¯«ç§’åŠ¨ç”»
    m_leftContainerAnimation->setEasingCurve(QEasingCurve::InOutQuad);

    // è¿æ¥æŒ‰é’®ç‚¹å‡»ä¿¡å·
    connect(m_sidebarControl->toggleBtn(), &QToolButton::clicked,
            this, &MainWindow::switchToSessionList);
    connect(m_sidebarControl->historyBtn(), &QToolButton::clicked,
            this, &MainWindow::switchToHistoryWindow);

    // ---------------------------------------------------------
    // ä¿¡å·è¿æ¥
    // ---------------------------------------------------------

    // 1. ç‚¹å‡»"é€‰æ‹©å·¥ä½œæµ"æŒ‰é’® -> å‘¼å‡ºå·¥ä½œæµé¢æ¿
    connect(m_inputPanel->getWorkflowBtn(), &QPushButton::clicked,
            this, &MainWindow::onWorkflowBtnClicked);

    // 2. ç‚¹å‡»"å‚è€ƒå›¾(å›å½¢é’ˆ)"æŒ‰é’® -> å‘¼å‡ºå‚è€ƒå›¾é¢æ¿
    connect(m_inputPanel->getRefBtn(), &QToolButton::clicked,
            this, &MainWindow::onRefBtnClicked);

    // 3. ç‚¹å‡»"ç”Ÿæˆ"æŒ‰é’® -> å¤„ç†ç”Ÿæˆè¯·æ±‚
    connect(m_inputPanel, &InputPanel::generateClicked,
            this, &MainWindow::onGenerateClicked);

    // 4. å·¥ä½œæµé€‰æ‹©å™¨é€‰ä¸­å·¥ä½œæµ -> æ›´æ–°ç•Œé¢çŠ¶æ€
    connect(m_wfSelector, &WorkflowSelector::workflowSelected,
            this, &MainWindow::onWorkflowSelected);

    connect(m_inputPanel->getInterrogateBtn(), &QToolButton::clicked,
            this, &MainWindow::onInterrogateClicked);



    // ---------------------------------------------------------
    // åˆå§‹çŠ¶æ€è®¾ç½®
    // ---------------------------------------------------------

    // é»˜è®¤æˆ‘ä»¬å‡è®¾å½“å‰æ˜¯â€œæ–‡ç”Ÿå›¾â€æ¨¡å¼ï¼Œæ‰€ä»¥ç¦ç”¨å‚è€ƒå›¾æŒ‰é’®

    // é»˜è®¤æˆ‘ä»¬å‡è®¾å½“å‰æ˜¯â€œæ–‡ç”Ÿå›¾â€æ¨¡å¼
    m_inputPanel->updateState(WorkflowType::TextToImage);

    // =========================================================
    // ã€ä¿®å¤ä»£ç ã€‘åˆå§‹åŒ–ä¾§è¾¹æ æ§åˆ¶ç»„ä»¶çš„ä½ç½®
    // =========================================================

    // 1. å¼ºåˆ¶è®¾ç½®åˆå§‹ä½ç½®ã€‚
    // æ³¨æ„ï¼šæ­¤æ—¶ m_leftStack->width() å¯èƒ½è¿˜æ²¡è®¡ç®—å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä½¿ç”¨
    // å·²çŸ¥çš„ m_leftContainerOriginalWidth (250) æ¥è®¡ç®—ï¼Œç¡®ä¿è½¯ä»¶ä¸€å¯åŠ¨æŒ‰é’®å°±åœ¨æ­£ç¡®ä½ç½®ã€‚
    if (m_leftContainerVisible) {
        int initialBtnX = m_leftContainerOriginalWidth + 10;
        m_sidebarControl->move(initialBtnX, 10);
    } else {
        m_sidebarControl->move(10, 10);
    }

    // 2. ç¡®ä¿æŒ‰é’®åœ¨æ‰€æœ‰æ§ä»¶çš„æœ€ä¸Šå±‚ï¼ˆé˜²æ­¢è¢« Sidebar é®æŒ¡ï¼‰
    m_sidebarControl->raise();

    // 3. ä½¿ç”¨ 0ms å®šæ—¶å™¨è¿›è¡ŒäºŒæ¬¡æ ¡å‡†
    // è¿™æ˜¯ä¸€ä¸ª Qt å¸¸ç”¨æŠ€å·§ï¼š0ms å®šæ—¶å™¨ä¼šåœ¨å½“å‰äº‹ä»¶å¾ªç¯ç»“æŸåï¼ˆå³ç•Œé¢æ˜¾ç¤ºã€å¸ƒå±€è®¡ç®—å®Œæˆåï¼‰ç«‹åˆ»æ‰§è¡Œã€‚
    // è¿™æ ·èƒ½ç¡®ä¿ updateSidebarPosition è·å–åˆ°çš„æ˜¯ Layout è®¡ç®—åçš„çœŸå®åæ ‡ã€‚
    QTimer::singleShot(0, this, [this](){
        updateSidebarPosition();
    });

    // ---------------------------------------------------------
    // APIæœåŠ¡åˆå§‹åŒ–
    // ---------------------------------------------------------

    // --- æ‰¾åˆ°æœ€ååˆå§‹åŒ– m_apiService çš„åœ°æ–¹ ---

    m_apiService = new ComfyApiService(this);

    // 1. è¿æ¥æˆåŠŸ -> è§£é”å¹¶æ¢å¤æ–‡å­—
    connect(m_apiService, &ComfyApiService::serverConnected, this, [this](){
        this->setWindowTitle("CloudArt - å·²è¿æ¥ âœ…");
        m_inputPanel->setConnectionStatus(true); // <--- è°ƒç”¨è¿™é‡Œ
    });

    // 2. è¿æ¥æ–­å¼€ -> é”å®šå¹¶æç¤ºæœªè¿æ¥
    connect(m_apiService, &ComfyApiService::serverDisconnected, this, [this](){
        this->setWindowTitle("CloudArt - æœªè¿æ¥ âŒ");
        m_inputPanel->setConnectionStatus(false); // <--- è°ƒç”¨è¿™é‡Œ
    });

    // 3. é”™è¯¯ -> é”å®š
    connect(m_apiService, &ComfyApiService::errorOccurred, this, [this](const QString& msg){
        this->setWindowTitle("CloudArt - è¿æ¥å¤±è´¥ âš ï¸");
        m_inputPanel->setConnectionStatus(false); // <--- è°ƒç”¨è¿™é‡Œ
    });

    // åˆå§‹çŠ¶æ€é”ä½
    m_inputPanel->setConnectionStatus(false);

    // ã€æ–°å¢ã€‘è¿æ¥ä¾§è¾¹æ çš„â€œè®¾ç½®æŒ‰é’®â€
    connect(m_sidebarControl->settingsBtn(), &QToolButton::clicked, this, [this](){
        SettingsDialog dlg(this);
        if (dlg.exec() == QDialog::Accepted) {
            // å¦‚æœç”¨æˆ·ç‚¹äº†ç¡®å®šï¼Œå°±é‡æ–°è¯»å–é…ç½®å¹¶è¿æ¥
            loadAndConnect();
        }
    });

    // å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨è¯»å–é…ç½®å¹¶è¿æ¥
    loadAndConnect();

    // =========================================================
    // ã€æ ¸å¿ƒé€»è¾‘ 1ã€‘ä»»åŠ¡æäº¤æˆåŠŸï¼ŒæœåŠ¡å™¨è¿”å›äº† ID
    // =========================================================
    connect(m_apiService, &ComfyApiService::promptQueued, this, [this](const QString& promptId){
        // å¦‚æœå½“å‰æœ‰ä¸€ä¸ªæ­£åœ¨ç­‰å¾… ID çš„æ°”æ³¡
        if (m_tempBubbleForId) {
            qDebug() << "ğŸ”— ç»‘å®šä»»åŠ¡ ID:" << promptId << " åˆ°å½“å‰æ°”æ³¡";
            // å­˜å…¥æ˜ å°„è¡¨ï¼šä»¥åçœ‹åˆ°è¿™ä¸ª IDï¼Œå°±çŸ¥é“æ˜¯è¿™ä¸ªæ°”æ³¡
            m_pendingBubbles.insert(promptId, m_tempBubbleForId);
            // æ¸…ç©ºæš‚å­˜æŒ‡é’ˆï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡ä½¿ç”¨
            m_tempBubbleForId = nullptr;
        }
    });

    // =========================================================
    // ã€æ ¸å¿ƒé€»è¾‘ 2ã€‘å›¾ç‰‡ä¸‹è½½å®Œæ¯•
    // =========================================================
    // æ³¨æ„ï¼šè¯·ç¡®ä¿ä½ çš„ ComfyApiService ä¿¡å·æ˜¯è¿™ä¸ªç­¾åï¼š
    // void imageReceived(const QString& promptId, const QString& filename, const QPixmap& img);
    connect(m_apiService, &ComfyApiService::imageReceived, this,
            [this](const QString& promptId, const QString& filename, const QPixmap& img){

                // 1. ã€æ–°å¢ã€‘ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨
                QString localPath = saveImageToLocal(img);

                // 2. ã€æ–°å¢ã€‘å­˜å…¥æ•°æ®åº“ (AI Role)
                int currentSid = m_chatArea->currentSessionId();
                if (currentSid != -1 && !localPath.isEmpty()) {
                    MessageData msg(currentSid, MessageRole::AI, "", localPath); // æ–‡æœ¬ä¸ºç©ºï¼Œè·¯å¾„æœ‰å€¼
                    DatabaseManager::instance().addMessage(msg);
                }

                // æ£€æŸ¥è¿™ä¸ª ID æ˜¯å¦åœ¨æˆ‘ä»¬çš„ç­‰å¾…åˆ—è¡¨ä¸­
                if (m_pendingBubbles.contains(promptId)) {
                    qDebug() << "ğŸ–¼ï¸ æ‰¾åˆ°å¯¹åº”çš„æ°”æ³¡ï¼Œæ›´æ–°å›¾ç‰‡...";

                    ChatBubble* bubble = m_pendingBubbles[promptId];
                    if (bubble) {
                        // 1. æ°”æ³¡å˜èº« (é«˜åº¦ç¬é—´å˜é«˜)
                        bubble->updateImage(img, filename);


                        QTimer::singleShot(100, this, [this](){
                            m_chatArea->scrollToBottom();
                        });
                    }

                    setJobRunning(false);

                    // ä»»åŠ¡å®Œæˆï¼Œä»ç­‰å¾…åˆ—è¡¨ä¸­ç§»é™¤
                    m_pendingBubbles.remove(promptId);
                } else {
                    // å¯èƒ½æ˜¯æ—§çš„æˆ–è€…å…¶ä»–æ¥æºçš„å›¾ç‰‡ï¼Œç›´æ¥åŠ åˆ°æœ€åï¼ˆå…œåº•ç­–ç•¥ï¼‰
                    if (m_chatArea) {
                        m_chatArea->addAiImage(img);
                        // å…œåº•é€»è¾‘ä¹Ÿè¦æ»š
                        QTimer::singleShot(100, this, [this](){ m_chatArea->scrollToBottom(); });
                    }
                }
            });

    connect(m_chatArea, &ChatArea::upscaleRequested, this,
            [this](const QString& serverFileName, const QPixmap& img){

                if (m_isJobRunning) {
                    qDebug() << "âš ï¸ ä»»åŠ¡è¿›è¡Œä¸­ï¼Œå¿½ç•¥é«˜æ¸…ä¿®å¤è¯·æ±‚";
                    return;
                }

                // ã€æ–°å¢ã€‘ä¸Šé”
                setJobRunning(true);

                qDebug() << "æ”¶åˆ°é«˜æ¸…ä¿®å¤è¯·æ±‚ï¼Œå‡†å¤‡å›ç¯ä¸Šä¼ ...";

                // 1. åœ¨ç•Œé¢ä¸ŠåŠ ä¸ªè½¬åœˆæ°”æ³¡
                m_tempUpscaleBubble = m_chatArea->addLoadingBubble();

                // 2. å°†å›¾ç‰‡ä¿å­˜ä¸ºæœ¬åœ°ä¸´æ—¶æ–‡ä»¶
                QString tempPath = QStandardPaths::writableLocation(QStandardPaths::TempLocation)
                                   + "/temp_upscale_source.png";
                if (img.save(tempPath)) {
                    // 3. è®¾ç½®æ ‡è®°ä½ï¼Œå¼€å§‹ä¸Šä¼ 
                    m_isUploadingForUpscale = true;

                    // è¿™é‡Œçš„ m_tempBubbleForId éœ€è¦æŒ‡å‘è¿™ä¸ªæ–°æ°”æ³¡ï¼Œä»¥ä¾¿ upload å®Œå‘ä»»åŠ¡æ—¶ä½¿ç”¨
                    // ä½†æˆ‘ä»¬åœ¨ imageUploaded é‡Œå¤„ç†å‘ä»»åŠ¡ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦ä¼ æ–‡ä»¶
                    m_apiService->uploadImage(tempPath);
                } else {
                    qDebug() << "âŒ ä¸´æ—¶æ–‡ä»¶ä¿å­˜å¤±è´¥";
                    // åº”è¯¥åˆ é™¤è½¬åœˆæ°”æ³¡...
                    setJobRunning(false);
                }
            });

    connect(m_apiService, &ComfyApiService::imageUploaded, this, [this](const QString& serverName){

        // --- åˆ†æ”¯ï¼šå¦‚æœæ˜¯ä¸ºäº†é«˜æ¸…ä¿®å¤ ---
        if (m_isUploadingForUpscale) {
            qDebug() << "ğŸ”„ é«˜æ¸…ä¿®å¤åŸå›¾ä¸Šä¼ å®Œæ¯• (" << serverName << ")ï¼Œå¼€å§‹å‘é€ç”Ÿæˆä»»åŠ¡...";

            // 1. å¤ä½æ ‡è®°
            m_isUploadingForUpscale = false;

            // 2. å‡†å¤‡å‚æ•°
            QMap<QString, QVariant> params;
            params["image_path"] = serverName; // å¡«å…¥åˆšæ‰ä¸Šä¼ è¿”å›çš„æ–‡ä»¶å

            qint64 seed = QRandomGenerator::global()->generate();
            if (seed < 0) seed = -seed;
            params["seed"] = seed;

            // 3. æ„å»ºé«˜æ¸…ä¿®å¤å·¥ä½œæµ
            QJsonObject wf = m_wfManager->buildWorkflow(WorkflowType::Upscale, params);

            // 4. ç»‘å®šæ°”æ³¡ ID
            // æŠŠåˆšæ‰åˆ›å»ºçš„è½¬åœˆæ°”æ³¡ (m_tempUpscaleBubble) è½¬ç§»ç»™ m_tempBubbleForId
            // è¿™æ ·å½“ queuePrompt è¿”å› promptID æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨ç»‘å®šåˆ°è¿™ä¸ªæ°”æ³¡
            m_tempBubbleForId = m_tempUpscaleBubble;
            m_tempUpscaleBubble = nullptr;

            // 5. å‘é€ä»»åŠ¡
            if (m_apiService) {
                m_apiService->queuePrompt(wf);
            }

            return;
        }

        // --- åˆ†æ”¯ B: ã€æ–°å¢ã€‘è§†è§‰åæ¨ ---
        if (m_isUploadingForInterrogate) {
            qDebug() << "åæ¨å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨æ„å»ºä»»åŠ¡...";
            m_isUploadingForInterrogate = false; // å¤ä½æ ‡è®°
            m_currentServerRefImg = serverName;  // è®°ä¸‹æ¥ä¾›åç»­ä½¿ç”¨

            // 1. å‡†å¤‡å‚æ•°
            QMap<QString, QVariant> params;
            params["image_path"] = serverName; // å¡«å…¥åˆšæ‰ä¸Šä¼ çš„æ–‡ä»¶å

            // 2. è°ƒç”¨ç®¡ç†å™¨æ„å»º JSON
            QJsonObject wf = m_wfManager->buildWorkflow(WorkflowType::VisionCaption, params);

            // 3. å‘é€ä»»åŠ¡
            if (wf.isEmpty()) {
                qDebug() << "âŒ åæ¨å·¥ä½œæµæ„å»ºå¤±è´¥";
                setJobRunning(false); // è®°å¾—è§£é”
                return;
            }

            if (m_apiService) {
                m_apiService->queuePrompt(wf);
            }

            // åæ¨ä¸éœ€è¦ m_tempBubbleForIdï¼Œå› ä¸ºå®ƒæ˜¯æµå¼è¾“å‡ºï¼Œæˆ‘ä»¬ä¼šåŠ¨æ€åˆ›å»ºæ°”æ³¡
            return;
        }

        // --- åˆ†æ”¯ C: ã€æ–°å¢ã€‘å›¾ç”Ÿå›¾ç”Ÿæˆæ¥åŠ› ---
        if (m_isUploadingForI2I) {
            qDebug() << "å›¾ç”Ÿå›¾ç´ æä¸Šä¼ å®Œæ¯•:" << serverName;
            m_isUploadingForI2I = false; // å¤ä½æ ‡è®°

            // 1. å–å‡ºä¹‹å‰æš‚å­˜çš„å‚æ•° (æç¤ºè¯ã€ç§å­)
            QMap<QString, QVariant> params = m_pendingI2IParams;

            // 2. å¡«å…¥æœ€å…³é”®çš„å‚æ•°ï¼šæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶å
            params["image_path"] = serverName;

            // 3. æ„å»ºå·¥ä½œæµ JSON
            QJsonObject wf = m_wfManager->buildWorkflow(WorkflowType::ImageToImage, params);

            // 4. å‘é€ä»»åŠ¡
            if (wf.isEmpty()) {
                qDebug() << "âŒ å›¾ç”Ÿå›¾å·¥ä½œæµæ„å»ºå¤±è´¥";
                setJobRunning(false);
                return;
            }

            if (m_apiService) {
                m_apiService->queuePrompt(wf);
            }

            // æ³¨æ„ï¼šæ­¤æ—¶ m_tempBubbleForId ä¾ç„¶æŒ‡å‘æˆ‘ä»¬åœ¨ onGenerateClicked é‡Œåˆ›å»ºçš„é‚£ä¸ªæ°”æ³¡
            // ç­‰ä¸€ä¼šå„¿ promptQueued ä¿¡å·å›æ¥ï¼Œå°±ä¼šè‡ªåŠ¨æŠŠå®ƒå’Œä»»åŠ¡ ID ç»‘å®šä¸Š
            return;
        }



        // (æœªæ¥è¿™é‡Œè¿˜å¯ä»¥åŠ  else if å¤„ç†å›¾ç”Ÿå›¾çš„ä¸Šä¼ é€»è¾‘)
    });

    // ã€æ–°å¢ã€‘ç›‘å¬æµå¼æ–‡æœ¬ (åæ¨æç¤ºè¯)
    // =========================================================
    connect(m_apiService, &ComfyApiService::streamTokenReceived, this,
            [this](const QString& token, bool finished){

                // 1. ã€æ–°å¢ã€‘ç´¯åŠ æ–‡æœ¬ (åªç´¯åŠ æœ‰æ•ˆå†…å®¹)
                if (!token.isEmpty()) {
                    m_accumulatedStreamText += token;
                }

                // 2. UI æ˜¾ç¤º (åŸæœ‰é€»è¾‘)
                if (m_chatArea) {
                    m_chatArea->handleStreamToken(token, finished);
                }

                // 3. ç»“æŸå¤„ç†
                if (finished) {
                    qDebug() << "âœ… åæ¨ç»“æŸï¼Œå®Œæ•´æ–‡æœ¬é•¿åº¦:" << m_accumulatedStreamText.length();

                    // ã€æ–°å¢ã€‘å­˜å…¥æ•°æ®åº“ (AI Role)
                    int currentSid = m_chatArea->currentSessionId();

                    // åªæœ‰å½“æœ‰å†…å®¹ä¸”æœ‰ä¼šè¯æ—¶æ‰å­˜
                    if (currentSid != -1 && !m_accumulatedStreamText.isEmpty()) {
                        MessageData msg(currentSid, MessageRole::AI, m_accumulatedStreamText);
                        DatabaseManager::instance().addMessage(msg);
                        qDebug() << "ğŸ’¾ åæ¨æ–‡æœ¬å·²ä¿å­˜åˆ°æ•°æ®åº“";
                    }

                    // ã€æ–°å¢ã€‘æ¸…ç©ºç¼“å­˜ï¼Œä¸ºä¸‹æ¬¡åšå‡†å¤‡ (å¯é€‰ï¼ŒåŒé‡ä¿é™©)
                    m_accumulatedStreamText.clear();

                    setJobRunning(false);
                }
            });

    // å·¦ä¾§åˆ—è¡¨è¯·æ±‚æ–°å»ºä¼šè¯
    connect(m_sessionList, &SessionList::createNewSessionRequest,
            this, &MainWindow::createNewSession); // ã€ä¿®æ”¹ã€‘è¿åˆ°æ–°å†™çš„å‡½æ•°

    // 2. ã€ä¿®å¤ã€‘å¤„ç†é‡å‘½å
    connect(m_sessionList, &SessionList::sessionRenameRequest, this,
            [this](int id, const QString& newName){

                // æ›´æ–°æ•°æ®åº“
                DatabaseManager::instance().renameSession(id, newName);
                qDebug() << "ä¼šè¯" << id << "é‡å‘½åä¸º" << newName;
            });

    // 3. ã€ä¿®å¤ã€‘å¤„ç†åˆ é™¤
    connect(m_sessionList, &SessionList::sessionDeleteRequest, this,
            [this](int id){

                // æ›´æ–°æ•°æ®åº“ (çº§è”åˆ é™¤æ¶ˆæ¯)
                DatabaseManager::instance().deleteSession(id);

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„ä¼šè¯ï¼Œæ¸…ç©ºå³ä¾§å¹¶é‡ç½® ID
                if (m_chatArea->currentSessionId() == id) {
                    m_chatArea->clear();
                    m_chatArea->setCurrentSessionId(-1);
                }
                qDebug() << "ä¼šè¯" << id << "å·²åˆ é™¤";
            });

    // å·¦ä¾§åˆ—è¡¨è¯·æ±‚åˆ‡æ¢ä¼šè¯ (ä¹‹å‰å¯èƒ½æ²¡å®ç°å…·ä½“é€»è¾‘ï¼Œç°åœ¨è¦è¡¥ä¸Š)
    connect(m_sessionList, &SessionList::sessionSwitchRequest, this, [this](int id){
        loadSessionHistory(id);
    });

    // ...

    // ã€æœ€åä¸€æ­¥ã€‘å¯åŠ¨æ—¶åŠ è½½æ•°æ®
    // æ”¾åœ¨ setupUi çš„æœ€åï¼Œæˆ–è€… show() ä¹‹å‰
    loadSessionList();
}

/**
 * @brief å·¥ä½œæµæŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
 *
 * å½“ç”¨æˆ·ç‚¹å‡»å·¥ä½œæµé€‰æ‹©æŒ‰é’®æ—¶ï¼Œå¼¹å‡ºå·¥ä½œæµé€‰æ‹©å™¨çª—å£ã€‚
 * çª—å£ä½ç½®è‡ªåŠ¨è®¡ç®—åœ¨æŒ‰é’®ä¸Šæ–¹å±…ä¸­æ˜¾ç¤ºã€‚
 */
void MainWindow::onWorkflowBtnClicked() {
    // è·å–æŒ‰é’®ä½ç½®ï¼Œè®©é¢æ¿å‡ºç°åœ¨æŒ‰é’®ä¸Šæ–¹
    QPushButton* btn = m_inputPanel->getWorkflowBtn();
    if (btn) {
        QPoint btnPos = btn->mapToGlobal(QPoint(btn->width() / 2, 0));
        m_wfSelector->popup(btnPos);
    }
}

/**
 * @brief å‚è€ƒå›¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
 *
 * å½“ç”¨æˆ·ç‚¹å‡»å‚è€ƒå›¾æŒ‰é’®æ—¶ï¼Œåˆ‡æ¢å‚è€ƒå›¾é€‰æ‹©çª—å£çš„æ˜¾ç¤ºå’Œéšè—çŠ¶æ€ã€‚
 * å¦‚æœçª—å£å·²æ˜¾ç¤ºï¼Œåˆ™éšè—ï¼›å¦‚æœçª—å£å·²éšè—ï¼Œåˆ™æ˜¾ç¤ºã€‚
 */
void MainWindow::onRefBtnClicked() {
    // å¦‚æœçª—å£å·²æ˜¾ç¤ºï¼Œåˆ™éšè—ï¼›å¦åˆ™æ˜¾ç¤º
    if (m_refPopup->isVisible()) {
        m_refPopup->hide();
    } else {
        // è·å–æŒ‰é’®ä½ç½®ï¼Œè®©é¢æ¿å‡ºç°åœ¨æŒ‰é’®ä¸Šæ–¹
        QToolButton* btn = m_inputPanel->getRefBtn();
        if (btn) {
            QPoint btnPos = btn->mapToGlobal(QPoint(btn->width() / 2, 0));
            m_refPopup->popup(btnPos);
        }
    }
}

/**
 * @brief å·¥ä½œæµé€‰æ‹©äº‹ä»¶å¤„ç†
 * @param info é€‰ä¸­çš„å·¥ä½œæµä¿¡æ¯
 *
 * å½“ç”¨æˆ·ä»å·¥ä½œæµé€‰æ‹©å™¨ä¸­é€‰æ‹©å·¥ä½œæµæ—¶ï¼Œæ›´æ–°è¾“å…¥é¢æ¿çŠ¶æ€ã€‚
 * æ ¹æ®å·¥ä½œæµç±»å‹å¯ç”¨æˆ–ç¦ç”¨ç›¸å…³åŠŸèƒ½æŒ‰é’®ã€‚
 */
void MainWindow::onWorkflowSelected(const WorkflowInfo& info)
{
    // æ ¹æ®å·¥ä½œæµç±»å‹æ›´æ–°è¾“å…¥é¢æ¿çŠ¶æ€
    m_inputPanel->updateState(info.type);

    // ã€æ–°å¢ã€‘è®°å½•å½“å‰ç±»å‹ï¼Œä¾›ç”Ÿæˆæ—¶ä½¿ç”¨
    m_currentWorkflowType = info.type;

    qDebug() << "åˆ‡æ¢åˆ°å·¥ä½œæµ:" << info.name << " (ID:" << info.id << ")";
}

/**
 * @brief ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
 * @param prompt ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯
 *
 * å½“ç”¨æˆ·ç‚¹å‡»ç”ŸæˆæŒ‰é’®æ—¶ï¼Œå¤„ç†ç”Ÿæˆè¯·æ±‚ã€‚
 * åªæœ‰åœ¨è¾“å…¥æ¡†æœ‰å†…å®¹æ—¶æ‰ä¼šè§¦å‘æ­¤ä¿¡å·ã€‚
 * é¦–å…ˆåœ¨èŠå¤©åŒºåŸŸæ·»åŠ ç”¨æˆ·å¯¹è¯ï¼Œç„¶åå¤„ç†ç”Ÿæˆé€»è¾‘ã€‚
 */
void MainWindow::onGenerateClicked(const QString& prompt)
{
    // 1. æ£€æŸ¥é”
    if (m_isJobRunning) return;

    qDebug() << "ç”Ÿæˆè¯·æ±‚ - æç¤ºè¯:" << prompt;

    // ã€æ–°å¢ã€‘å­˜å…¥æ•°æ®åº“ -> UIæ˜¾ç¤º
    // åªæœ‰å½“å‰æœ‰é€‰ä¸­çš„ä¼šè¯æ‰å­˜ (currentSessionId != -1)
    // å¦‚æœæ²¡æœ‰é€‰ä¸­ä¼šè¯ï¼ˆæ¯”å¦‚åˆšå¯åŠ¨ï¼‰ï¼Œåº”è¯¥å…ˆ createNewSession()ï¼Œè¿™é‡Œå‡è®¾å·²æœ‰
    int currentSid = m_chatArea->currentSessionId();
    if (currentSid != -1) {
        // A. å­˜åº“
        MessageData msg(currentSid, MessageRole::User, prompt);
        DatabaseManager::instance().addMessage(msg);

        // B. ä¸Šå±
        m_chatArea->addUserMessage(prompt);
    }

    // 3. ç«‹å³æ·»åŠ â€œè½¬åœˆåœˆâ€æ°”æ³¡ï¼Œå¹¶æš‚å­˜æŒ‡é’ˆ
    // (è¿™ä¸ªæ°”æ³¡ä¼šä¸€ç›´è½¬ï¼Œç›´åˆ°æ–‡ç”Ÿå›¾çš„ä»»åŠ¡IDå›æ¥ï¼Œæˆ–è€…å›¾ç”Ÿå›¾çš„ä¸Šä¼ +ä»»åŠ¡IDå›æ¥)
    ChatBubble* loadingBubble = m_chatArea->addLoadingBubble();
    m_tempBubbleForId = loadingBubble;

    // 4. ä¸Šé”
    setJobRunning(true);

    // 5. å‡†å¤‡åŸºç¡€å‚æ•° (é€šç”¨éƒ¨åˆ†)
    QMap<QString, QVariant> params;
    params["prompt"] = prompt;

    qint64 seed = QRandomGenerator::global()->generate();
    if (seed < 0) seed = -seed;
    params["seed"] = seed;

    qDebug() << "å‡†å¤‡ç”Ÿæˆ, ç±»å‹:" << (int)m_currentWorkflowType << " ç§å­:" << seed;

    // =================================================
    // åˆ†æ”¯ A: å›¾ç”Ÿå›¾ (ImageToImage) -> éœ€è¦å…ˆä¸Šä¼ 
    // =================================================
    if (m_currentWorkflowType == WorkflowType::ImageToImage) {
        // è·å–æœ¬åœ°å‚è€ƒå›¾è·¯å¾„
        QString localPath = m_refPopup->currentPath();

        if (localPath.isEmpty()) {
            qDebug() << "âŒ å›¾ç”Ÿå›¾æ¨¡å¼å¿…é¡»å…ˆé€‰æ‹©å‚è€ƒå›¾";
            // å¤±è´¥å¤„ç†ï¼šè§£é”ï¼Œå¹¶æŠŠåˆšæ‰ç”Ÿæˆçš„è½¬åœˆæ°”æ³¡åˆ æ‰(æˆ–è€…æ˜¾ç¤ºé”™è¯¯)
            setJobRunning(false);
            // è¿™é‡Œç®€å•å¤„ç†ï¼Œä½ å¯ä»¥åŠ ä¸ª delete loadingBubble;
            return;
        }

        // æ ‡è®°çŠ¶æ€ï¼šè¿™æ¬¡ä¸Šä¼ æ˜¯ä¸ºäº† I2I
        m_isUploadingForI2I = true;

        // æš‚å­˜å‚æ•° (ç­‰ä¸Šä¼ å®Œäº†ï¼Œå†æŠŠ filename å¡è¿›å»)
        m_pendingI2IParams = params;

        // å¼€å§‹ä¸Šä¼  (ä¸Šä¼ æˆåŠŸåä¼šè§¦å‘ imageUploaded ä¿¡å·ï¼Œé€»è¾‘åœ¨é‚£è¾¹ç»§ç»­)
        if (m_apiService) {
            m_apiService->uploadImage(localPath);
        }

        // ã€é‡è¦ã€‘ç›´æ¥è¿”å›ï¼Œä¸è¦å¾€ä¸‹èµ°äº†ï¼Œç­‰å¾…å¼‚æ­¥å›è°ƒ
        return;
    }

    // =================================================
    // åˆ†æ”¯ B: æ–‡ç”Ÿå›¾ (TextToImage) -> ç›´æ¥å‘é€
    // =================================================
    if (m_currentWorkflowType == WorkflowType::TextToImage) {
        // è·å–åˆ†è¾¨ç‡è®¾ç½®
        QSize size = m_inputPanel->currentResolution();
        if (size.isEmpty()) size = QSize(1024, 1024);

        params["width"] = size.width();
        params["height"] = size.height();

        qDebug() << "è®¾å®šåˆ†è¾¨ç‡:" << size.width() << "x" << size.height();
    }

    // 6. æ„å»ºå·¥ä½œæµ JSON
    QJsonObject workflow = m_wfManager->buildWorkflow(m_currentWorkflowType, params);

    // 7. å‘é€ç»™ ComfyUI
    if (workflow.isEmpty()) {
        qDebug() << "âŒ å·¥ä½œæµæ„å»ºå¤±è´¥";
        setJobRunning(false); // è§£é”
        return;
    }

    if (m_apiService) {
        m_apiService->queuePrompt(workflow);
    } else {
        qDebug() << "âŒ ApiService æœªåˆå§‹åŒ–";
        setJobRunning(false);
    }
}

/**
 * @brief åˆ‡æ¢å·¦ä¾§å®¹å™¨æ˜¾ç¤ºçŠ¶æ€
 *
 * å½“å·¦ä¾§å®¹å™¨ä¸åœ¨åœºæ—¶ï¼Œå‘¼å‡ºå®¹å™¨ï¼›
 * å½“å·¦ä¾§å®¹å™¨åœ¨åœºæ—¶ï¼Œæ”¶èµ·å®¹å™¨ã€‚
 */
void MainWindow::onToggleLeftContainer()
{
    if (m_leftContainerVisible) {
        // æ”¶èµ·å·¦ä¾§å®¹å™¨ - å‘å·¦åŠ¨ç”»æ”¶ç¼©åˆ°0å®½åº¦
        m_leftContainerAnimation->setStartValue(m_leftStack->width());
        m_leftContainerAnimation->setEndValue(0);
        m_leftContainerAnimation->start();

        // è®¾ç½®maximumWidthä¸º0ï¼Œç¡®ä¿å®Œå…¨éšè—
        m_leftStack->setMaximumWidth(0);

        m_leftContainerVisible = false;

        // æ›´æ–°ä¾§è¾¹æ ä½ç½®
        QTimer::singleShot(300, this, [this]() {
            updateSidebarPosition();
        });
    } else {
        // å‘¼å‡ºå·¦ä¾§å®¹å™¨ - å‘å³åŠ¨ç”»æ¢å¤åˆ°åŸå§‹å®½åº¦
        // è®¾ç½®æœ€å¤§å®½åº¦é™åˆ¶ä¸º250
        m_leftStack->setMaximumWidth(250);

        // ä½¿ç”¨ä¿å­˜çš„åˆå§‹å®½åº¦
        m_leftContainerAnimation->setStartValue(0);
        m_leftContainerAnimation->setEndValue(m_leftContainerOriginalWidth);
        m_leftContainerAnimation->start();

        m_leftContainerVisible = true;

        // æ›´æ–°ä¾§è¾¹æ ä½ç½®
        QTimer::singleShot(300, this, [this]() {
            updateSidebarPosition();
        });
    }
}

/**
 * @brief æ›´æ–°ä¾§è¾¹æ ä½ç½®
 *
 * æ ¹æ®å·¦ä¾§å®¹å™¨çš„æ˜¾ç¤ºçŠ¶æ€ï¼Œè°ƒæ•´ä¾§è¾¹æ çš„ä½ç½®ã€‚
 * å·¦ä¾§å®¹å™¨æ˜¾ç¤ºæ—¶ä¾§è¾¹æ åœ¨å®¹å™¨å³ä¾§ä¸Šæ–¹ï¼Œå·¦ä¾§å®¹å™¨éšè—æ—¶ä¾§è¾¹æ åœ¨çª—å£å·¦ä¸Šè§’ã€‚
 */
void MainWindow::updateSidebarPosition()
{
    if (m_leftContainerVisible) {
        // å·¦ä¾§å®¹å™¨æ˜¾ç¤ºæ—¶ï¼Œä¾§è¾¹æ åœ¨å®¹å™¨å³ä¾§ä¸Šæ–¹
        // ä½¿ç”¨å®¹å™¨çš„å®é™…å®½åº¦æ¥è®¡ç®—ä½ç½®
        int containerWidth = m_leftStack->width();
        if (containerWidth <= 0) {
            containerWidth = 250; // é»˜è®¤å®½åº¦
        }
        // ä¾§è¾¹æ æ”¾åœ¨å®¹å™¨å³ä¾§ï¼Œè·ç¦»å®¹å™¨å³è¾¹æ¡†10åƒç´ 
        QPoint pos = m_leftStack->mapToParent(QPoint(containerWidth + 10, 10));
        m_sidebarControl->move(pos);
    } else {
        // å·¦ä¾§å®¹å™¨éšè—æ—¶ï¼Œä¾§è¾¹æ åœ¨çª—å£å·¦ä¸Šè§’
        m_sidebarControl->move(10, 10);
    }

    m_sidebarControl->raise(); // ç¡®ä¿ä¾§è¾¹æ åœ¨æœ€ä¸Šå±‚
}

/**
 * @brief åˆ‡æ¢å·¦ä¾§é¢æ¿
 * @param targetIndex ç›®æ ‡é¡µé¢ç´¢å¼•
 */
void MainWindow::switchLeftPanel(int targetIndex)
{
    if (!m_leftContainerVisible) {
        // å·¦ä¾§å®¹å™¨ä¸åœ¨åœºï¼Œå…ˆå‘¼å‡ºå®¹å™¨
        onToggleLeftContainer();
        // è®¾ç½®å½“å‰é¡µé¢ä¸ºç›®æ ‡é¡µé¢
        m_leftStack->setCurrentIndex(targetIndex);
        m_currentPageIndex = targetIndex;
    } else if (m_currentPageIndex != targetIndex) {
        // å·¦ä¾§å®¹å™¨åœ¨åœºä½†å½“å‰ä¸æ˜¯ç›®æ ‡é¡µé¢ï¼Œåˆ‡æ¢åˆ°ç›®æ ‡é¡µé¢
        m_leftStack->setCurrentIndex(targetIndex);
        m_currentPageIndex = targetIndex;
    } else {
        // å·¦ä¾§å®¹å™¨åœ¨åœºä¸”å½“å‰æ˜¯ç›®æ ‡é¡µé¢ï¼Œæ”¶èµ·å®¹å™¨
        onToggleLeftContainer();
    }
}

/**
 * @brief çª—å£å¤§å°æ”¹å˜äº‹ä»¶å¤„ç†
 * @param event çª—å£å¤§å°æ”¹å˜äº‹ä»¶
 *
 * å½“çª—å£å¤§å°æ”¹å˜æ—¶ï¼Œæ›´æ–°ä¾§è¾¹æ çš„ä½ç½®ã€‚
 */
void MainWindow::resizeEvent(QResizeEvent* event)
{
    QMainWindow::resizeEvent(event);
    updateSidebarPosition();
}

/**
 * @brief åˆ‡æ¢åˆ°ä¼šè¯åˆ—è¡¨é¡µé¢
 *
 * å½“å·¦ä¾§å®¹å™¨ä¸åœ¨åœºæ—¶ï¼Œå‘¼å‡ºå®¹å™¨å¹¶æ˜¾ç¤ºä¼šè¯åˆ—è¡¨ï¼›
 * å½“å·¦ä¾§å®¹å™¨åœ¨åœºæ—¶ï¼Œåˆ‡æ¢åˆ°ä¼šè¯åˆ—è¡¨é¡µé¢ã€‚
 */
void MainWindow::switchToSessionList()
{
    switchLeftPanel(0);
}

/**
 * @brief åˆ‡æ¢åˆ°å†å²è®°å½•é¡µé¢
 *
 * å½“å·¦ä¾§å®¹å™¨ä¸åœ¨åœºæ—¶ï¼Œå‘¼å‡ºå®¹å™¨å¹¶æ˜¾ç¤ºå†å²è®°å½•ï¼›
 * å½“å·¦ä¾§å®¹å™¨åœ¨åœºæ—¶ï¼Œåˆ‡æ¢åˆ°å†å²è®°å½•é¡µé¢ã€‚
 */
void MainWindow::switchToHistoryWindow()
{
    // 1. åˆ‡æ¢ç•Œé¢
    switchLeftPanel(1);

    // 2. æ¯æ¬¡åˆ‡æ¢è¿‡æ¥æ—¶ï¼Œåˆ·æ–°æ•°æ®
    // è¿™æ ·åˆšç”Ÿæˆçš„å›¾ä¹Ÿèƒ½ç«‹åˆ»çœ‹åˆ°
    if (m_leftStack->currentIndex() == 1) {
        m_historyGallery->loadImages();
    }
}

void MainWindow::setJobRunning(bool running)
{
    m_isJobRunning = running;

    // 1. ã€å…³é”®ã€‘é”å®šåº•éƒ¨é¢æ¿çš„æ‰€æœ‰æ“ä½œ (åŒ…æ‹¬æ¯”ä¾‹ã€å·¥ä½œæµã€è¾“å…¥æ¡†ç­‰)
    if (m_inputPanel) {
        m_inputPanel->setLocked(running);
        // è™½ç„¶æŒ‰é’®è¢«ç¦ç”¨äº†ï¼Œä½†æ”¹ä¸ªæ–‡å­—æç¤ºä¸€ä¸‹ç”¨æˆ·å½“å‰çŠ¶æ€è¿˜æ˜¯å‹å¥½çš„
        m_inputPanel->getGenerateBtn()->setText(running ? "ç”Ÿæˆä¸­..." : "ç”Ÿæˆ");
    }

    // 2. é”å®šå·¦ä¾§ä¼šè¯åˆ—è¡¨ (ç¦æ­¢åˆ‡æ¢ã€åˆ é™¤)
    if (m_sessionList) {
        m_sessionList->setEnabled(!running);
    }

    // 3. ã€æ–°å¢ã€‘é”å®šå·¦ä¸Šè§’çš„åˆ‡æ¢æŒ‰é’®å’Œå†å²æŒ‰é’®
    // é˜²æ­¢ç”¨æˆ·åœ¨ç”Ÿæˆæ—¶æŠŠä¾§è¾¹æ æ”¶èµ·æ¥ï¼Œæˆ–è€…è·³åˆ°å†å²è®°å½•é¡µ
    if (m_sidebarControl->toggleBtn()) m_sidebarControl->toggleBtn()->setEnabled(!running);
    if (m_sidebarControl->historyBtn()) m_sidebarControl->historyBtn()->setEnabled(!running);

}


void MainWindow::onInterrogateClicked()
{
    // 1. æ£€æŸ¥å¿™ç¢Œé”
    if (m_isJobRunning) return;

    // 2. ã€ä¿®æ”¹ã€‘ä¸å†æ‰“å¼€æ–‡ä»¶å¯¹è¯æ¡†ï¼Œè€Œæ˜¯ä»å‚è€ƒå›¾é¢æ¿è·å–è·¯å¾„
    QString localPath = m_refPopup->currentPath();

    // 3. æ ¡éªŒï¼šå¦‚æœæ²¡æœ‰é€‰å‚è€ƒå›¾
    if (localPath.isEmpty()) {
        // è‡ªåŠ¨å¼¹å‡ºå‚è€ƒå›¾é¢æ¿ï¼Œå¼•å¯¼ç”¨æˆ·
        QToolButton* btn = m_inputPanel->getRefBtn();
        if (btn) {
            QPoint btnPos = btn->mapToGlobal(QPoint(btn->width() / 2, 0));
            m_refPopup->popup(btnPos);
            // è¿™é‡Œå¯ä»¥åŠ ä¸€ä¸ª ToolTip æˆ–è€…ç®€å•çš„ Message æç¤ºç”¨æˆ·
            // btn->showToolTip("è¯·å…ˆåœ¨è¿™é‡Œä¸Šä¼ å›¾ç‰‡");
        }
        return;
    }

    // ã€æ–°å¢ã€‘å¼€å§‹æ–°ä»»åŠ¡å‰ï¼ŒåŠ¡å¿…æ¸…ç©ºæ–‡æœ¬ç¼“å­˜
    m_accumulatedStreamText.clear();

    // 4. ç•Œé¢åé¦ˆï¼šåœ¨èŠå¤©åŒºæ˜¾ç¤ºè¿™å¼ å›¾
    // è·å– ReferencePopup é‡Œçš„ç¼“å­˜å›¾ç‰‡ (QPixmap) ç›´æ¥æ˜¾ç¤ºï¼Œä¸ç”¨é‡æ–°åŠ è½½æ–‡ä»¶
    QPixmap pix = m_refPopup->currentImage();
    if (!pix.isNull()) {
        if (m_chatArea) m_chatArea->addUserImage(pix); // è¿˜æ˜¯æš‚æ—¶å€Ÿç”¨è¿™ä¸ªæ¥å£
    }

    // 5. ä¸Šé”å¹¶æ ‡è®°çŠ¶æ€
    setJobRunning(true);
    m_isUploadingForInterrogate = true; // æ ‡è®°ï¼šè¿™æ˜¯ä¸ºäº†åæ¨

    // 6. å¼€å§‹ä¸Šä¼ æœ¬åœ°æ–‡ä»¶
    if (m_apiService) {
        m_apiService->uploadImage(localPath);
    }
}

void MainWindow::loadSessionList()
{
    // 1. ä»æ•°æ®åº“æŸ¥æ•°æ® (é€šå¸¸æ˜¯æŒ‰æ—¶é—´å€’åºï¼Œæœ€æ–°çš„åœ¨ç¬¬0ä¸ª)
    QVector<SessionData> sessions = DatabaseManager::instance().getAllSessions();

    // 2. åˆ·æ–°å·¦ä¾§ UI
    m_sessionList->loadSessions(sessions);

    // 3. ã€æ ¸å¿ƒé€»è¾‘ã€‘åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
    if (!sessions.isEmpty()) {
        // --- æƒ…å†µ A: æ•°æ®åº“é‡Œæœ‰å†å²è®°å½• ---

        // è·å–æœ€æ–°çš„ä¼šè¯ ID (å³åˆ—è¡¨ç¬¬ä¸€ä¸ª)
        int firstId = sessions.first().id;

        // 1. è®©å·¦ä¾§åˆ—è¡¨è§†è§‰ä¸Šé€‰ä¸­å®ƒ
        m_sessionList->selectSession(firstId);

        // 2. è®©å³ä¾§èŠå¤©åŒºåŠ è½½å®ƒçš„å†å²è®°å½•
        loadSessionHistory(firstId);

        // 3. ç¡®ä¿å½“å‰ä¼šè¯ ID è¢«æ­£ç¡®è®°å½• (åŒé‡ä¿é™©)
        m_chatArea->setCurrentSessionId(firstId);
    }
    else {
        // --- æƒ…å†µ B: ç¬¬ä¸€æ¬¡å®‰è£…è½¯ä»¶ï¼Œæˆ–è€…æ˜¯ç©ºçš„ ---
        qDebug() << "æ•°æ®åº“ä¸ºç©ºï¼Œè‡ªåŠ¨åˆ›å»ºæ–°ä¼šè¯...";
        createNewSession();
        // createNewSession å†…éƒ¨ä¼šè‡ªåŠ¨åˆ·æ–°åˆ—è¡¨å¹¶é€‰ä¸­æ–°å»ºçš„é‚£ä¸ªï¼Œ
        // æ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†å†™é¢å¤–çš„åŠ è½½é€»è¾‘
    }
}

void MainWindow::createNewSession()
{
    int newId = DatabaseManager::instance().createSession("æ–°ä¼šè¯");
    if (newId != -1) {
        // åˆ·æ–°åˆ—è¡¨
        loadSessionList();
        // æ³¨æ„ï¼šloadSessionList åˆšæ‰è¢«æˆ‘ä»¬æ”¹è¿‡äº†ã€‚
        // å› ä¸ºç°åœ¨æœ‰äº†æ–°ä¼šè¯ï¼Œå®ƒä¼šè¿›å…¥ "æƒ…å†µ A"ï¼Œè‡ªåŠ¨é€‰ä¸­è¿™ä¸ªæ–° IDã€‚
        // æ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†æ‰‹åŠ¨ loadSessionHistory äº†ï¼Œé€»è¾‘é—­ç¯äº†ã€‚

        if (!m_leftContainerVisible) onToggleLeftContainer();
    }
}

QString MainWindow::saveImageToLocal(const QPixmap& img)
{
    // 1. ç¡®å®šä¿å­˜ç›®å½•
    QString dataDir = QStandardPaths::writableLocation(QStandardPaths::AppDataLocation);
    QString outputDir = dataDir + "/outputs";

    QDir dir(outputDir);
    if (!dir.exists()) dir.mkpath(".");

    // 2. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å (æ—¶é—´æˆ³.png)
    QString fileName = QString::number(QDateTime::currentMSecsSinceEpoch()) + ".png";
    QString fullPath = outputDir + "/" + fileName;

    // 3. ä¿å­˜
    if (img.save(fullPath, "PNG")) {
        return fullPath;
    }
    return QString();
}


void MainWindow::loadSessionHistory(int sessionId)
{
    qDebug() << "æ­£åœ¨åŠ è½½ä¼šè¯å†å²:" << sessionId;

    // 1. æ¸…ç©ºå½“å‰ç•Œé¢
    m_chatArea->clear();
    m_chatArea->setCurrentSessionId(sessionId);

    // 2. ä»æ•°æ®åº“æŸ¥æ•°æ®
    QVector<MessageData> messages = DatabaseManager::instance().getMessages(sessionId);

    // 3. éå†å¹¶æ¢å¤æ˜¾ç¤º
    for (const auto& msg : messages) {

        // åˆ¤æ–­è§’è‰²
        // æ³¨æ„ï¼šæ•°æ®åº“å­˜çš„æ˜¯å­—ç¬¦ä¸² "user"/"ai"ï¼ŒMessageDataé‡Œè½¬æˆäº†æšä¸¾
        // æˆ‘ä»¬çš„ ChatBubble ç”¨çš„æ˜¯ ChatRoleï¼Œå¯èƒ½éœ€è¦å¯¹åº”ä¸€ä¸‹
        ChatRole role = (msg.role == MessageRole::User) ? ChatRole::User : ChatRole::AI;

        if (msg.isImage()) {
            // --- å›¾ç‰‡æ¶ˆæ¯ ---
            // msg.imagePath æ˜¯æœ¬åœ°ç»å¯¹è·¯å¾„
            QPixmap pix(msg.imagePath);
            if (!pix.isNull()) {
                if (role == ChatRole::User) {
                    // å¦‚æœä½ ä¹‹å‰å†™äº† addUserImage å°±ç”¨é‚£ä¸ª
                    m_chatArea->addUserImage(pix);
                } else {
                    m_chatArea->addAiImage(pix);
                }
            } else {
                // å›¾ç‰‡æ–‡ä»¶ä¸¢å¤±çš„æƒ…å†µ
                if (role == ChatRole::User) m_chatArea->addUserMessage("[å›¾ç‰‡æ–‡ä»¶å·²ä¸¢å¤±]");
                else m_chatArea->addAiMessage("[å›¾ç‰‡æ–‡ä»¶å·²ä¸¢å¤±]");
            }
        }
        else {
            // --- æ–‡å­—æ¶ˆæ¯ ---
            if (role == ChatRole::User) {
                m_chatArea->addUserMessage(msg.text);
            } else {
                // AI çš„æ–‡å­— (åæ¨ç»“æœ)
                m_chatArea->addAiMessage(msg.text);
            }
        }
    }

    // 4. æ»šåˆ°åº•éƒ¨ (ç»™ç‚¹å»¶æ—¶è®©å¸ƒå±€ç®—å¥½)
    QTimer::singleShot(100, this, [this](){ m_chatArea->scrollToBottom(); });
}

// ã€æ–°å¢å‡½æ•°çš„å®ç°ã€‘
void MainWindow::loadAndConnect()
{
    QSettings settings("CloudArt", "AppConfig");
    QString url = settings.value("Server/Url", "http://127.0.0.1:8000").toString();

    if (url.isEmpty()) return;

    // ã€æ–°å¢ã€‘ç«‹å³æ›´æ–° UI çŠ¶æ€ä¸ºæ­£åœ¨è¿æ¥
    this->setWindowTitle("CloudArt - æ­£åœ¨è¿æ¥... ğŸ”„");
    qDebug() << "æ­£åœ¨å°è¯•è¿æ¥æœåŠ¡å™¨:" << url;

    m_inputPanel->setConnectionStatus(false);

    if (m_apiService) {
        m_apiService->connectToHost(url);
    }
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\MainWindow.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\MainWindow.h ---

/**
 * @file MainWindow.h
 * @brief ä¸»çª—å£å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†MainWindowç±»ï¼Œä½œä¸ºåº”ç”¨ç¨‹åºçš„ä¸»çª—å£ã€‚
 * åŒ…å«ç•Œé¢ç»„ä»¶ç®¡ç†ã€ä¿¡å·æ§½å£°æ˜å’Œæˆå‘˜å˜é‡å®šä¹‰ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once

#include <QMainWindow>
#include <QPropertyAnimation>
#include <QHBoxLayout>
#include <QStackedWidget>
#include "../Model/WorkflowTypes.h"
#include "../Network/ComfyApiService.h"
#include "../Database/DatabaseManager.h"
#include "Components/SettingsDialog.h"


// --- å‰å‘å£°æ˜ (Forward Declarations) ---
// è¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸ç”¨åœ¨è¿™é‡Œ #include æ‰€æœ‰å¤´æ–‡ä»¶ï¼Œç¼–è¯‘æ›´å¿«ï¼Œä¹Ÿä¸å®¹æ˜“æŠ¥é”™
class InputPanel;
class WorkflowSelector;
class ReferencePopup;
class SessionList;
class ChatArea;
class QToolButton;
class ComfyApiService;
class WorkflowManager;
class ChatBubble;
class SidebarControl;
class HistoryGallery;

/**
 * @brief ä¸»çª—å£ç±»
 * 
 * ç»§æ‰¿è‡ªQMainWindowï¼Œä½œä¸ºåº”ç”¨ç¨‹åºçš„ä¸»çª—å£å®¹å™¨ã€‚
 * ç®¡ç†å·¦ä¾§ä¼šè¯åˆ—è¡¨ã€å³ä¾§èŠå¤©åŒºåŸŸå’Œè¾“å…¥é¢æ¿ï¼Œä»¥åŠæµ®åŠ¨çª—å£ç»„ä»¶ã€‚
 */
class MainWindow : public QMainWindow
{
    Q_OBJECT

public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param parent çˆ¶çª—å£æŒ‡é’ˆ
     */
    explicit MainWindow(QWidget *parent = nullptr);
    
    /**
     * @brief ææ„å‡½æ•°
     */
    ~MainWindow();

private slots:
    /**
     * @brief å·¥ä½œæµæŒ‰é’®ç‚¹å‡»æ§½å‡½æ•°
     */
    void onWorkflowBtnClicked();
    
    /**
     * @brief å‚è€ƒå›¾æŒ‰é’®ç‚¹å‡»æ§½å‡½æ•°
     */
    void onRefBtnClicked();
    
    /**
     * @brief å·¥ä½œæµé€‰æ‹©æ§½å‡½æ•°
     * @param info é€‰ä¸­çš„å·¥ä½œæµä¿¡æ¯
     */
    void onWorkflowSelected(const WorkflowInfo& info);
    
    /**
     * @brief ç”ŸæˆæŒ‰é’®ç‚¹å‡»æ§½å‡½æ•°
     * @param prompt ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯
     */
    void onGenerateClicked(const QString& prompt);
    
    /**
     * @brief åˆ‡æ¢å·¦ä¾§å®¹å™¨æ˜¾ç¤ºçŠ¶æ€
     */
    void onToggleLeftContainer();
    
    /**
     * @brief åˆ‡æ¢åˆ°ä¼šè¯åˆ—è¡¨é¡µé¢
     */
    void switchToSessionList();
    
    /**
     * @brief åˆ‡æ¢åˆ°å†å²è®°å½•é¡µé¢
     */
    void switchToHistoryWindow();

    // ã€æ–°å¢ã€‘å¤„ç†åæ¨æŒ‰é’®ç‚¹å‡»
    void onInterrogateClicked();

    void loadAndConnect();

protected:
    /**
     * @brief çª—å£å¤§å°æ”¹å˜äº‹ä»¶å¤„ç†å‡½æ•°
     * @param event å¤§å°æ”¹å˜äº‹ä»¶
     */
    void resizeEvent(QResizeEvent* event) override;

private:
    /**
     * @brief åˆå§‹åŒ–UIå¸ƒå±€
     */
    void setupUi();

    /**
     * @brief æ›´æ–°ä¾§è¾¹æ ä½ç½®
     */
    void updateSidebarPosition();

    // ã€æ–°å¢ã€‘åŠ è½½æ‰€æœ‰å†å²ä¼šè¯
    void loadSessionList();

    // ã€æ–°å¢ã€‘åˆ›å»ºæ–°ä¼šè¯çš„é€»è¾‘
    void createNewSession();

    /**
     * @brief åˆ‡æ¢å·¦ä¾§é¢æ¿
     * @param targetIndex ç›®æ ‡é¡µé¢ç´¢å¼•
     */
    void switchLeftPanel(int targetIndex);

    QString saveImageToLocal(const QPixmap& img);

    // --- æˆå‘˜å˜é‡ (æŒæœ‰å„ä¸ªç»„ä»¶çš„æŒ‡é’ˆ) ---
    // å·¦ä¾§
    QStackedWidget* m_leftStack; ///< å·¦ä¾§å®¹å™¨å †æ ˆ
    SessionList* m_sessionList; ///< ä¼šè¯åˆ—è¡¨ç»„ä»¶

    // å³ä¾§
    ChatArea* m_chatArea; ///< èŠå¤©åŒºåŸŸç»„ä»¶
    InputPanel* m_inputPanel; ///< åº•éƒ¨æ§åˆ¶é¢æ¿ç»„ä»¶

    // æµ®åŠ¨çª—å£ (Popups)
    WorkflowSelector* m_wfSelector; ///< å·¥ä½œæµé€‰æ‹©é¢æ¿ç»„ä»¶
    ReferencePopup* m_refPopup; ///< å‚è€ƒå›¾ä¸Šä¼ é¢æ¿ç»„ä»¶

    // åˆ‡æ¢æŒ‰é’®å’ŒåŠ¨ç”»
    SidebarControl* m_sidebarControl; ///< ä¾§è¾¹æ æ§åˆ¶ç»„ä»¶
    QPropertyAnimation* m_leftContainerAnimation; ///< å·¦ä¾§å®¹å™¨åŠ¨ç”»æ•ˆæœ
    bool m_leftContainerVisible; ///< å·¦ä¾§å®¹å™¨æ˜¯å¦å¯è§
    int m_leftContainerOriginalWidth; ///< å·¦ä¾§å®¹å™¨çš„åˆå§‹å®½åº¦
    int m_currentPageIndex; ///< å½“å‰æ˜¾ç¤ºçš„é¡µé¢ç´¢å¼•
    
    HistoryGallery* m_historyGallery; // ã€æ–°å¢ã€‘æ–°çš„ç±»å‹
    
    /** ä¸»å¸ƒå±€ */
    QHBoxLayout* m_mainLayout;
    
    /** APIæœåŠ¡ */
    ComfyApiService* m_apiService;

    // ã€æ–°å¢ã€‘ä¸šåŠ¡é€»è¾‘ç®¡ç†å™¨
    WorkflowManager* m_wfManager;

    // ã€æ–°å¢ã€‘è®°å½•å½“å‰é€‰ä¸­çš„å·¥ä½œæµç±»å‹ (é»˜è®¤ä¸ºæ–‡ç”Ÿå›¾)
    WorkflowType m_currentWorkflowType = WorkflowType::TextToImage;

    // 1. æš‚å­˜åˆšåˆšåˆ›å»ºçš„åŠ è½½æ°”æ³¡ï¼ˆç­‰å¾… API è¿”å› prompt_idï¼‰
    ChatBubble* m_tempBubbleForId = nullptr;

    // 2. æ˜ å°„è¡¨ï¼šä»»åŠ¡ID -> æ°”æ³¡æŒ‡é’ˆ (ç”¨äºåœ¨å›¾ç‰‡ç”Ÿæˆåæ‰¾åˆ°å¯¹åº”çš„æ°”æ³¡)
    QMap<QString, ChatBubble*> m_pendingBubbles;

    // ã€æ–°å¢ã€‘æ ‡è®°å½“å‰ä¸Šä¼ æ“ä½œæ˜¯å¦ä¸ºäº†é«˜æ¸…ä¿®å¤
    bool m_isUploadingForUpscale = false;

    // ã€æ–°å¢ã€‘æš‚å­˜é«˜æ¸…ä¿®å¤çš„æ°”æ³¡ï¼ˆç”¨äºç»‘å®šIDï¼‰
    ChatBubble* m_tempUpscaleBubble = nullptr;

    // ã€æ–°å¢ã€‘æ˜¯å¦æ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼ˆå¿™ç¢ŒçŠ¶æ€ï¼‰
    bool m_isJobRunning = false;

    // ã€æ–°å¢ã€‘åˆ‡æ¢å¿™ç¢ŒçŠ¶æ€çš„è¾…åŠ©å‡½æ•°
    void setJobRunning(bool running);

    // ã€æ–°å¢ã€‘æ ‡è®°ï¼šå½“å‰ä¸Šä¼ æ˜¯å¦æ˜¯ä¸ºäº†åæ¨æç¤ºè¯ï¼Ÿ
    bool m_isUploadingForInterrogate = false;

    // ã€æ–°å¢ã€‘è®°ä½åæ¨ç”¨çš„å›¾ç‰‡åï¼ˆç»™åç»­å›¾ç”Ÿå›¾å¤‡ç”¨ï¼Œå¯é€‰ï¼‰
    QString m_currentServerRefImg;

    // ã€æ–°å¢ã€‘æ ‡è®°ï¼šå½“å‰ä¸Šä¼ æ˜¯å¦ä¸ºäº†å›¾ç”Ÿå›¾ç”Ÿæˆ
    bool m_isUploadingForI2I = false;

    // ã€æ–°å¢ã€‘æš‚å­˜å›¾ç”Ÿå›¾éœ€è¦çš„å‚æ•° (æç¤ºè¯ã€ç§å­)ï¼Œç­‰ä¸Šä¼ å®Œäº†ä¸€èµ·ç”¨
    QMap<QString, QVariant> m_pendingI2IParams;

    // ã€æ–°å¢ã€‘ç”¨äºæš‚å­˜æµå¼ä¼ è¾“çš„å®Œæ•´æ–‡æœ¬
    QString m_accumulatedStreamText;

    // ã€æ–°å¢ã€‘åŠ è½½æŒ‡å®šä¼šè¯çš„å†å²è®°å½•åˆ°èŠå¤©åŒº
    void loadSessionHistory(int sessionId);


};


--- æ–‡ä»¶ç»“æŸ: src\Ui\MainWindow.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\ChatArea.cpp ---

#include "ChatArea.h"
#include "ChatBubble.h"
#include <QScrollBar>
#include <QTimer>

ChatArea::ChatArea(QWidget *parent) : QWidget(parent)
{
    setupUi();
}

void ChatArea::setupUi()
{
    // 1. ä¸»å¸ƒå±€
    QVBoxLayout* mainLayout = new QVBoxLayout(this);
    mainLayout->setContentsMargins(0, 0, 0, 0);
    mainLayout->setSpacing(0);

    // 2. æ»šåŠ¨åŒºåŸŸ
    m_scrollArea = new QScrollArea(this);
    m_scrollArea->setWidgetResizable(true); // å…³é”®ï¼å¦åˆ™å†…éƒ¨æ— æ³•æ’‘å¼€
    m_scrollArea->setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOff); // åªéœ€å‚ç›´æ»šåŠ¨
    m_scrollArea->setFrameShape(QFrame::NoFrame); // æ— è¾¹æ¡†

    // ç¾åŒ–æ»šåŠ¨æ¡ (å’Œ SessionList ä¸€è‡´)
    m_scrollArea->setStyleSheet(
        "QScrollArea { background: #343541; border: none; }"
        "QScrollBar:vertical { border: none; background: #343541; width: 10px; margin: 0px; }"
        "QScrollBar::handle:vertical { background: #565869; min-height: 20px; border-radius: 5px; }"
        "QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical { height: 0px; }"
        "QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical { background: none; }"
        );

    // 3. æ»šåŠ¨å†…å®¹å®¹å™¨
    m_scrollContent = new QWidget();
    m_scrollContent->setStyleSheet("background-color: transparent;"); // é€æ˜ï¼Œé€å‡º ScrollArea èƒŒæ™¯

    m_contentLayout = new QVBoxLayout(m_scrollContent);
    m_contentLayout->setContentsMargins(20, 20, 20, 20); // ç»™æ°”æ³¡ç•™å‡ºå››å‘¨ç©ºéš™
    m_contentLayout->setSpacing(20); // æ°”æ³¡ä¹‹é—´çš„é—´è·
    m_contentLayout->addStretch();   // åˆå§‹å¼¹ç°§ï¼ŒæŠŠç¬¬ä¸€æ¡æ¶ˆæ¯é¡¶åœ¨æœ€ä¸Šé¢

    m_scrollArea->setWidget(m_scrollContent);
    mainLayout->addWidget(m_scrollArea);
}

void ChatArea::addUserMessage(const QString& text)
{
    ChatBubble* bubble = new ChatBubble(ChatRole::User, text, m_scrollContent);

    // æ’å…¥åˆ°å¼¹ç°§ä¹‹å‰ (count()-1)
    m_contentLayout->insertWidget(m_contentLayout->count() - 1, bubble);

    scrollToBottom();
}

ChatBubble* ChatArea::addLoadingBubble()
{
    // 1. åˆ›å»ºä¸€ä¸ªç©ºå†…å®¹çš„ AI æ°”æ³¡
    // (æˆ‘ä»¬åœ¨ ChatBubble æ„é€ å‡½æ•°é‡Œå¤„ç†äº†ç©ºå­—ç¬¦ä¸² -> Loading æ€)
    ChatBubble* bubble = new ChatBubble(ChatRole::AI, "", m_scrollContent);

    // 2. è¿æ¥å®ƒçš„ä¿¡å·
    // å½“ç”¨æˆ·åœ¨æ°”æ³¡ä¸Šå³é”®ç‚¹å‡»â€œé«˜æ¸…ä¿®å¤â€æ—¶ï¼Œä¿¡å·ä¼šä¸€è·¯ä¼ å‡ºå»
    connect(bubble, &ChatBubble::upscaleRequested, this, &ChatArea::upscaleRequested);

    // 3. æ’å…¥ç•Œé¢
    m_contentLayout->insertWidget(m_contentLayout->count() - 1, bubble);
    scrollToBottom();

    return bubble;
}

// é¡ºä¾¿ä¿®æ”¹ä¸€ä¸‹æ—§çš„ addAiImageï¼Œä¹Ÿè¦è¿ä¿¡å·
void ChatArea::addAiImage(const QPixmap& img)
{
    ChatBubble* bubble = new ChatBubble(ChatRole::AI, img, m_scrollContent);
    connect(bubble, &ChatBubble::upscaleRequested, this, &ChatArea::upscaleRequested); // è¿æ¥ä¿¡å·
    m_contentLayout->insertWidget(m_contentLayout->count() - 1, bubble);
    scrollToBottom();
}

void ChatArea::scrollToBottom()
{
    // ä½¿ç”¨ QTimer::singleShot 0ms å»¶æ—¶
    // åŸå› æ˜¯ï¼šç•Œé¢å¸ƒå±€åˆ·æ–°éœ€è¦æ—¶é—´ï¼Œç›´æ¥ setValue å¯èƒ½æ»šåŠ¨ä¸åˆ°æœ€åº•éƒ¨
    QTimer::singleShot(10, this, [=](){
        QScrollBar* bar = m_scrollArea->verticalScrollBar();
        bar->setValue(bar->maximum());
    });
}

void ChatArea::clear()
{
    // ã€æ ¸å¿ƒä¿®å¤ã€‘
    // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šåªè¦å¸ƒå±€é‡Œçš„å…ƒç´ å¤šäº 1 ä¸ªï¼ˆé‚£ä¸ª 1 å°±æ˜¯æœ€åçš„å¼¹ç°§ï¼‰ï¼Œå°±ä¸€ç›´åˆ ã€‚
    // å¿…é¡»ä» index 0 (ç¬¬ä¸€ä¸ª) å¼€å§‹åˆ ï¼Œè¿™æ ·æ°¸è¿œåˆ çš„æ˜¯æœ€ä¸Šé¢çš„æ°”æ³¡ã€‚
    // æœ€åçš„å¼¹ç°§ä¼šä¸€ç›´ç•™åœ¨é‚£é‡Œï¼Œç›´åˆ°å®ƒå˜æˆ index 0ã€‚

    while (m_contentLayout->count() > 1) {
        // å–å‡ºç¬¬ä¸€ä¸ªå…ƒç´  (æ°”æ³¡)
        QLayoutItem *item = m_contentLayout->takeAt(0);

        if (item->widget()) {
            delete item->widget(); // é”€æ¯æ°”æ³¡æ§ä»¶
        }
        delete item; // é”€æ¯å¸ƒå±€é¡¹
    }

    // é‡ç½®çŠ¶æ€
    m_currentSessionId = -1;
    m_currentStreamBubble = nullptr; // åˆ«å¿˜äº†é‡ç½®è¿™ä¸ª

    this->update();
}


void ChatArea::handleStreamToken(const QString& token, bool finished)
{
    // ã€å…³é”®ä¿®å¤ 1ã€‘å¦‚æœæ˜¯å•çº¯çš„ç»“æŸä¿¡å·ï¼ˆæ²¡æœ‰å†…å®¹ï¼‰ï¼Œä¸”å½“å‰æ²¡æœ‰æ´»è·ƒæ°”æ³¡ï¼Œç›´æ¥å¿½ç•¥
    // è¿™èƒ½é˜²æ­¢â€œå¼ºåˆ¶è§£é”ä¿¡å·â€åˆ›å»ºä¸€ä¸ªç©ºæ°”æ³¡
    if (finished && token.isEmpty() && !m_currentStreamBubble) {
        return;
    }

    // ã€å…³é”®ä¿®å¤ 2ã€‘è¿‡æ»¤ä¸­é—´çš„ç©ºåŒ…
    if (token.isEmpty() && !finished) {
        return;
    }

    // 2. å¦‚æœæ²¡æœ‰æ­£åœ¨æ‰“å­—çš„æ°”æ³¡ï¼Œé€ ä¸€ä¸ªæ–°çš„
    if (!m_currentStreamBubble) {
        // å¦‚æœèƒ½èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜ token è‚¯å®šä¸ä¸ºç©º
        m_currentStreamBubble = new ChatBubble(ChatRole::AI, token, m_scrollContent);
        m_contentLayout->insertWidget(m_contentLayout->count() - 1, m_currentStreamBubble);
    }
    else {
        // 3. è¿½åŠ 
        if (!token.isEmpty()) {
            m_currentStreamBubble->appendText(token);
        }
    }

    // 4. æ»šåŠ¨
    QTimer::singleShot(10, this, [this](){ scrollToBottom(); });

    // 5. ç»“æŸé‡ç½®
    if (finished) {
        m_currentStreamBubble = nullptr;
    }
}

void ChatArea::addUserImage(const QPixmap& img)
{
    ChatBubble* bubble = new ChatBubble(ChatRole::User, img, m_scrollContent);
    // User çš„å›¾é€šå¸¸ä¸éœ€è¦é«˜æ¸…ä¿®å¤ï¼Œæ‰€ä»¥ä¸è¿ upscale ä¿¡å·ä¹Ÿå¯ä»¥
    m_contentLayout->insertWidget(m_contentLayout->count() - 1, bubble);
    scrollToBottom();
}

void ChatArea::addAiMessage(const QString& text)
{
    ChatBubble* bubble = new ChatBubble(ChatRole::AI, text, m_scrollContent);
    m_contentLayout->insertWidget(m_contentLayout->count() - 1, bubble);
    scrollToBottom();
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\ChatArea.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\ChatArea.h ---

/**
 * @file ChatArea.h
 * @brief èŠå¤©åŒºåŸŸç»„ä»¶å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†ChatAreaç±»ï¼Œä½œä¸ºåº”ç”¨ç¨‹åºå³ä¾§çš„èŠå¤©æ˜¾ç¤ºåŒºåŸŸã€‚
 * åŒ…å«ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›¾ç‰‡çš„æ˜¾ç¤ºã€ä¼šè¯åˆ‡æ¢å’Œæ¸…ç©ºåŠŸèƒ½ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once
#include <QWidget>
#include <QScrollArea>
#include <QVBoxLayout>


class ChatBubble;

/**
 * @brief èŠå¤©åŒºåŸŸç±»
 * 
 * ç»§æ‰¿è‡ªQWidgetï¼Œç®¡ç†èŠå¤©æ¶ˆæ¯çš„æ˜¾ç¤ºå’Œä¼šè¯åˆ‡æ¢ã€‚
 * æ”¯æŒç”¨æˆ·æ–‡å­—æ¶ˆæ¯å’ŒAIå›¾ç‰‡æ¶ˆæ¯çš„æ·»åŠ å’Œæ˜¾ç¤ºã€‚
 */
class ChatArea : public QWidget
{
    Q_OBJECT
public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param parent çˆ¶çª—å£æŒ‡é’ˆ
     */
    explicit ChatArea(QWidget *parent = nullptr);

    /**
     * @brief æ¸…ç©ºå½“å‰èŠå¤©ç•Œé¢
     */
    void clear();

    /**
     * @brief è®¾ç½®å½“å‰ä¼šè¯ID
     * @param id ä¼šè¯ID
     */
    void setCurrentSessionId(int id) { m_currentSessionId = id; }
    
    /**
     * @brief è·å–å½“å‰ä¼šè¯ID
     * @return int å½“å‰ä¼šè¯IDï¼Œ-1è¡¨ç¤ºæ— é€‰ä¸­ä¼šè¯
     */
    int currentSessionId() const { return m_currentSessionId; }

    /**
     * @brief æ·»åŠ ç”¨æˆ·æ–‡å­—æ¶ˆæ¯
     * @param text ç”¨æˆ·æ¶ˆæ¯æ–‡æœ¬
     */
    void addUserMessage(const QString& text);

    /**
     * @brief æ·»åŠ AIå›¾ç‰‡æ¶ˆæ¯
     * @param img AIç”Ÿæˆçš„å›¾ç‰‡
     */
    void addAiImage(const QPixmap& img);

    // ã€æ–°å¢ã€‘æ·»åŠ ä¸€ä¸ªåŠ è½½æ€æ°”æ³¡ï¼Œå¹¶è¿”å›æŒ‡é’ˆ
    ChatBubble* addLoadingBubble();

    /**
     * @brief è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
     */
    void scrollToBottom();

    // ã€æ–°å¢ã€‘å¤„ç†æµå¼æ–‡å­—
    void handleStreamToken(const QString& token, bool finished);

    void addUserImage(const QPixmap& img);

    // ã€æ–°å¢ã€‘ç›´æ¥æ·»åŠ  AI æ–‡æœ¬æ¶ˆæ¯ (ç”¨äºåŠ è½½å†å²ï¼Œæ— åŠ¨ç”»)
    void addAiMessage(const QString& text);

signals:
    // ã€æ–°å¢ã€‘è½¬å‘æ°”æ³¡çš„é«˜æ¸…ä¿®å¤è¯·æ±‚ç»™ MainWindow
    void upscaleRequested(const QString& filename, const QPixmap& img);

private:
    /**
     * @brief åˆå§‹åŒ–UIå¸ƒå±€
     */
    void setupUi();
    


private:
    QScrollArea* m_scrollArea; ///< æ»šåŠ¨åŒºåŸŸç»„ä»¶
    QWidget* m_scrollContent; ///< æ»šåŠ¨å†…å®¹ç»„ä»¶
    QVBoxLayout* m_contentLayout; ///< å†…å®¹å¸ƒå±€
    int m_currentSessionId = -1; ///< å½“å‰ä¼šè¯IDï¼Œ-1è¡¨ç¤ºæ— é€‰ä¸­ä¼šè¯
    // ã€æ–°å¢ã€‘è®°å½•å½“å‰æ­£åœ¨â€œæ‰“å­—â€çš„æ°”æ³¡æŒ‡é’ˆ
    ChatBubble* m_currentStreamBubble = nullptr;

};


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\ChatArea.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\ChatBubble.cpp ---

#include "ChatBubble.h"
#include "ImageViewer.h"
#include <QFrame>
#include <QDebug>
#include <QGraphicsDropShadowEffect>
#include <QMouseEvent>
#include <QStandardPaths>
#include <QFileDialog>
#include <QClipboard>
#include <QApplication>

ChatBubble::ChatBubble(ChatRole role, const QVariant& data, QWidget *parent)
    : QWidget(parent)
    , m_role(role)
{
    // å…è®¸è‡ªå®šä¹‰èƒŒæ™¯ï¼ˆè™½ç„¶ Bubble æœ¬èº«é€šå¸¸é€æ˜ï¼‰
    this->setAttribute(Qt::WA_StyledBackground, true);

    m_layout = new QHBoxLayout(this);
    m_layout->setContentsMargins(10, 10, 10, 10);
    m_layout->setSpacing(0); // ç´§å‡‘å¸ƒå±€

    // ã€æ–°å¢ã€‘åˆå§‹åŒ–åŠ è½½åŠ¨ç”»
    // è¯·ç¡®ä¿ qrc é‡Œæœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œå¦åˆ™ä¼šæ˜¾ç¤ºç©ºç™½
    m_loadingMovie = new QMovie(":/images/loading.gif", QByteArray(), this);
    m_loadingMovie->setScaledSize(QSize(40, 40)); // è®¾ç½®åˆé€‚çš„å¤§å°

    setupUi(data);
}

void ChatBubble::setupUi(const QVariant& data)
{
    if (m_role == ChatRole::User) {
        m_layout->addStretch(); // å¼¹ç°§åœ¨å·¦ï¼Œå†…å®¹åœ¨å³

        // ã€ä¿®æ”¹ã€‘è®© User ä¹Ÿèƒ½å‘å›¾
        if (data.canConvert<QPixmap>()) {
            initImageBubble(data.value<QPixmap>());
        } else {
            initTextBubble(data.toString());
        }
    }
    else {
        // AI æ°”æ³¡é€»è¾‘
        if (data.canConvert<QPixmap>()) {
            initImageBubble(data.value<QPixmap>());
        }
        // ã€æ–°å¢ã€‘å¦‚æœæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œè¯´æ˜æ˜¯å ä½æ°”æ³¡
        else if (data.typeId() == QMetaType::QString && data.toString().isEmpty()) {
            initImageBubble(QPixmap()); // ä¼ ç©ºå›¾åˆå§‹åŒ–
            setLoading(true);           // å¼€å¯è½¬åœˆ
        }
        else {
            initTextBubble(data.toString()); // å®¹é”™
        }
        m_layout->addStretch();
    }
}

void ChatBubble::initTextBubble(const QString& text)
{
    QFrame* frame = new QFrame(this);

    // æ ·å¼è®¾ç½®
    QString style = (m_role == ChatRole::User)
                        ? "background-color: #444654; border-radius: 8px; color: #ECECF1; padding: 10px;" // ç”¨æˆ·æ ·å¼
                        : "background-color: #2A2B32; border-radius: 8px; color: #ECECF1; padding: 10px; border: 1px solid #444;";
    frame->setStyleSheet(style);

    QHBoxLayout* frameLayout = new QHBoxLayout(frame);
    frameLayout->setContentsMargins(0, 0, 0, 0);

    // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šè¿™é‡Œä¸è¦å®šä¹‰å±€éƒ¨å˜é‡ QLabel* lblTextï¼Œç›´æ¥ç”¨æˆå‘˜å˜é‡ m_contentLabel
    // ä¹‹å‰å†™é”™çš„ä»£ç æ˜¯ï¼šQLabel* lblText = new QLabel(text, frame);
    m_contentLabel = new QLabel(text, frame);

    m_contentLabel->setWordWrap(true);
    m_contentLabel->setStyleSheet("border: none; background: transparent;");
    m_contentLabel->setTextInteractionFlags(Qt::TextSelectableByMouse);
    m_contentLabel->setMaximumWidth(600);

    // å³é”®èœå•ç­–ç•¥
    m_contentLabel->setContextMenuPolicy(Qt::CustomContextMenu);

    // è¿æ¥ä¿¡å· (æŠŠ lblText æ”¹ä¸º m_contentLabel)
    connect(m_contentLabel, &QLabel::customContextMenuRequested, this, [=](const QPoint& pos){
        QMenu menu;
        menu.setStyleSheet(
            "QMenu { background: #2D2D2D; color: white; border: 1px solid #555; padding: 5px; }"
            "QMenu::item { padding: 5px 20px; }"
            "QMenu::item:selected { background-color: #40414F; }"
            );

        QAction* actCopyAll = menu.addAction("ğŸ“‹ å¤åˆ¶å…¨éƒ¨å†…å®¹");
        connect(actCopyAll, &QAction::triggered, [=](){
            QClipboard *clipboard = QApplication::clipboard();
            // è¿™é‡Œè¦ç”¨ m_contentLabel->text() è·å–æœ€æ–°æ–‡æœ¬
            clipboard->setText(m_contentLabel->text());
        });

        if (m_contentLabel->hasSelectedText()) {
            QAction* actCopySelected = menu.addAction("âœ‚ï¸ å¤åˆ¶é€‰ä¸­å†…å®¹");
            connect(actCopySelected, &QAction::triggered, [=](){
                QClipboard *clipboard = QApplication::clipboard();
                clipboard->setText(m_contentLabel->selectedText());
            });
        }

        menu.exec(m_contentLabel->mapToGlobal(pos));
    });

    frameLayout->addWidget(m_contentLabel);
    m_layout->addWidget(frame);
}

void ChatBubble::initImageBubble(const QPixmap& originalImg)
{
    m_currentImage = originalImg;

    // åˆ›å»º Label å¹¶ä¿å­˜åˆ°æˆå‘˜å˜é‡
    m_contentLabel = new QLabel(this);
    m_contentLabel->setStyleSheet("border-radius: 8px; border: 2px solid #444;");

    if (!originalImg.isNull()) {
        // æœ‰å›¾ï¼šæ­£å¸¸æ˜¾ç¤º
        QSize maxDisplaySize(512, 512);
        QPixmap scaledImg = originalImg.scaled(maxDisplaySize, Qt::KeepAspectRatio, Qt::SmoothTransformation);
        m_contentLabel->setPixmap(scaledImg);
        m_contentLabel->setFixedSize(scaledImg.size());

        // å¼€å¯äº¤äº’
        m_contentLabel->setCursor(Qt::PointingHandCursor);
        m_contentLabel->installEventFilter(this);
    } else {
        // æ— å›¾ï¼ˆLoadingæ€ï¼‰ï¼šè®¾ç½®ä¸€ä¸ªå›ºå®šå¤§å°çš„å ä½
        m_contentLabel->setFixedSize(200, 200);
        m_contentLabel->setAlignment(Qt::AlignCenter);
    }

    // é˜´å½±
    auto *shadow = new QGraphicsDropShadowEffect(this);
    shadow->setBlurRadius(15);
    shadow->setColor(QColor(0, 0, 0, 80));
    shadow->setOffset(0, 5);
    m_contentLabel->setGraphicsEffect(shadow);

    m_layout->addWidget(m_contentLabel);
}

void ChatBubble::showViewer() {
    // åˆ›å»ºæŸ¥çœ‹å™¨å¹¶æ˜¾ç¤ºï¼ˆéæ¨¡æ€æˆ–æ¨¡æ€çš†å¯ï¼Œè¿™é‡Œç”¨æ¨¡æ€ç®€å•ç‚¹ï¼‰
    ImageViewer* viewer = new ImageViewer(m_currentImage, this);
    viewer->exec(); // æ¨¡æ€è¿è¡Œï¼Œå…³é—­åè‡ªåŠ¨é‡Šæ”¾
    delete viewer;
}

void ChatBubble::saveImage() {
    // è·å–ç³»ç»Ÿçš„å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„
    QString desktopPath = QStandardPaths::writableLocation(QStandardPaths::PicturesLocation);
    QString fileName = QFileDialog::getSaveFileName(this, "ä¿å­˜å›¾ç‰‡",
                                                    desktopPath + "/cloudart_gen.png",
                                                    "Images (*.png *.jpg)");
    if (!fileName.isEmpty()) {
        m_currentImage.save(fileName);
    }
}

// ã€æ–°å¢ã€‘åˆ‡æ¢åŠ è½½çŠ¶æ€
void ChatBubble::setLoading(bool loading)
{
    if (!m_contentLabel) return;

    if (loading) {
        m_contentLabel->setMovie(m_loadingMovie);
        m_loadingMovie->start();
    } else {
        m_loadingMovie->stop();
        m_contentLabel->setMovie(nullptr); // æ¸…é™¤ Movie ç»‘å®š
    }
}

// ã€æ–°å¢ã€‘ç”Ÿæˆå®Œæˆåæ›´æ–°å›¾ç‰‡
void ChatBubble::updateImage(const QPixmap& img, const QString& serverFileName)
{
    setLoading(false); // åœæ­¢è½¬åœˆ

    m_currentImage = img;
    m_serverFileName = serverFileName; // è®°ä½æœåŠ¡å™¨æ–‡ä»¶å (å…³é”®ï¼)

    // é‡æ–°è®¡ç®—å¤§å°å¹¶æ˜¾ç¤º
    QSize maxDisplaySize(512, 512);
    QPixmap scaledImg = img.scaled(maxDisplaySize, Qt::KeepAspectRatio, Qt::SmoothTransformation);

    m_contentLabel->setPixmap(scaledImg);
    m_contentLabel->setFixedSize(scaledImg.size());

    // æ¿€æ´»äº¤äº’ï¼ˆå› ä¸ºåˆå§‹åŒ–ä¸ºç©ºæ—¶å¯èƒ½æ²¡æ¿€æ´»ï¼‰
    m_contentLabel->setCursor(Qt::PointingHandCursor);
    m_contentLabel->removeEventFilter(this); // é˜²æ­¢é‡å¤å®‰è£…
    m_contentLabel->installEventFilter(this);
}

bool ChatBubble::eventFilter(QObject *watched, QEvent *event)
{
    if (qobject_cast<QLabel*>(watched) && event->type() == QEvent::MouseButtonPress) {
        QMouseEvent* mouseEvent = static_cast<QMouseEvent*>(event);

        if (mouseEvent->button() == Qt::LeftButton) {
            if (!m_currentImage.isNull()) showViewer(); // å·¦é”®çœ‹å¤§å›¾
            return true;
        }
        else if (mouseEvent->button() == Qt::RightButton) {
            // --- å³é”®èœå•é€»è¾‘å¼€å§‹ ---
            QMenu menu;
            // ç»Ÿä¸€æ·±è‰²é£æ ¼
            menu.setStyleSheet(
                "QMenu { background: #2D2D2D; color: white; border: 1px solid #555; padding: 5px; }"
                "QMenu::item { padding: 5px 20px; }"
                "QMenu::item:selected { background-color: #40414F; }"
                );

            // åªè¦æœ‰å›¾ç‰‡ï¼Œå°±æ˜¾ç¤ºè¿™ä¸‰ä¸ªé›·æ‰“ä¸åŠ¨çš„é€‰é¡¹
            if (!m_currentImage.isNull()) {

                // 1. å¤åˆ¶
                QAction* actCopy = menu.addAction("â å¤åˆ¶å›¾ç‰‡");
                connect(actCopy, &QAction::triggered, this, [=](){
                    QClipboard *clipboard = QApplication::clipboard();
                    clipboard->setPixmap(m_currentImage);
                });

                // 2. å¦å­˜ä¸º
                QAction* actSave = menu.addAction("ğŸ’¾ å¦å­˜ä¸º...");
                connect(actSave, &QAction::triggered, this, &ChatBubble::saveImage);

                menu.addSeparator();

                // 3. é«˜æ¸…ä¿®å¤ (æ— æ¡ä»¶æ˜¾ç¤º)
                // å³ä½¿æ˜¯å†å²è®°å½•æˆ–ç”¨æˆ·å‘çš„å›¾ï¼Œåªè¦å®ƒæ˜¯å¼ å›¾ï¼Œå°±èƒ½ç‚¹è¿™ä¸ª
                QAction* actUpscale = menu.addAction("âœ¨ é«˜æ¸…ä¿®å¤ (1.5x)");
                connect(actUpscale, &QAction::triggered, this, [=](){
                    // å‘é€ä¿¡å·
                    // å¦‚æœ m_serverFileName ä¸ºç©ºä¹Ÿæ²¡å…³ç³»ï¼ŒMainWindow ä¼šè´Ÿè´£é‡æ–°ä¸Šä¼  m_currentImage
                    emit upscaleRequested(m_serverFileName, m_currentImage);
                });
            }

            // å¦‚æœæ˜¯çº¯æ–‡æœ¬æ°”æ³¡ï¼Œé€»è¾‘ä¿æŒä¸å˜ (å¤åˆ¶æ–‡å­—)
            else if (m_contentLabel && !m_contentLabel->text().isEmpty()) {
                QAction* actCopyText = menu.addAction("ğŸ“‹ å¤åˆ¶å†…å®¹");
                connect(actCopyText, &QAction::triggered, [=](){
                    QApplication::clipboard()->setText(m_contentLabel->text());
                });
            }

            menu.exec(mouseEvent->globalPosition().toPoint());
            return true;
            // --- å³é”®èœå•é€»è¾‘ç»“æŸ ---
        }
    }
    return QWidget::eventFilter(watched, event);
}


void ChatBubble::appendText(const QString& text)
{
    // å¦‚æœè¿˜æ²¡åˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–
    if (!m_contentLabel) {
        initTextBubble("");
    }

    // ã€ä¼˜åŒ–ã€‘å¤„ç†ä¸€ä¸‹ Loading æ€çš„æ®‹ç•™ (å¦‚æœä¹‹å‰æ˜¯è½¬åœˆå›¾ç‰‡)
    if (m_loadingMovie && m_loadingMovie->state() == QMovie::Running) {
        setLoading(false);
        // å¦‚æœæ˜¯ä»å›¾ç‰‡åˆ‡å›æ¥çš„ï¼Œå¯èƒ½éœ€è¦é‡æ–°å¸ƒå±€ï¼Œæœ€ç®€å•çš„æ˜¯ initTextBubble
        // ä½†è¿™é‡Œæˆ‘ä»¬å‡è®¾æµå¼æ°”æ³¡ä¸€å¼€å§‹å°±æ˜¯ TextBubble
    }

    // è¿½åŠ æ–‡æœ¬
    QString current = m_contentLabel->text();
    m_contentLabel->setText(current + text);
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\ChatBubble.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\ChatBubble.h ---

/**
 * @file ChatBubble.h
 * @brief èŠå¤©æ°”æ³¡ç»„ä»¶å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†ChatBubbleç±»ï¼Œä½œä¸ºèŠå¤©åŒºåŸŸä¸­çš„æ¶ˆæ¯æ°”æ³¡ã€‚
 * æ”¯æŒç”¨æˆ·æ–‡æœ¬æ¶ˆæ¯å’ŒAIå›¾ç‰‡æ¶ˆæ¯çš„æ˜¾ç¤ºï¼ŒåŒ…å«ä¿å­˜å’ŒæŸ¥çœ‹åŠŸèƒ½ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once
#include <QWidget>
#include <QLabel>
#include <QHBoxLayout>
#include <QMenu>
#include <QMovie>

/**
 * @brief èŠå¤©è§’è‰²æšä¸¾
 * 
 * å®šä¹‰æ¶ˆæ¯å‘é€è€…çš„è§’è‰²ç±»å‹ã€‚
 */
enum class ChatRole {
    User, ///< ç”¨æˆ·è§’è‰²ï¼ˆé å³æ˜¾ç¤ºï¼Œæ–‡æœ¬æ¶ˆæ¯ï¼‰
    AI    ///< AIè§’è‰²ï¼ˆé å·¦æ˜¾ç¤ºï¼Œå›¾ç‰‡æ¶ˆæ¯ï¼‰
};

/**
 * @brief èŠå¤©æ°”æ³¡ç±»
 * 
 * ç»§æ‰¿è‡ªQWidgetï¼Œè¡¨ç¤ºèŠå¤©åŒºåŸŸä¸­çš„å•ä¸ªæ¶ˆæ¯æ°”æ³¡ã€‚
 * æ”¯æŒä¸åŒè§’è‰²çš„æ¶ˆæ¯æ˜¾ç¤ºã€å›¾ç‰‡ä¿å­˜å’ŒæŸ¥çœ‹åŠŸèƒ½ã€‚
 */
class ChatBubble : public QWidget
{
    Q_OBJECT
public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param role æ¶ˆæ¯è§’è‰²
     * @param data æ¶ˆæ¯æ•°æ®ï¼ˆæ–‡æœ¬æˆ–å›¾ç‰‡ï¼‰
     * @param parent çˆ¶çª—å£æŒ‡é’ˆ
     */
    explicit ChatBubble(ChatRole role, const QVariant& data, QWidget *parent = nullptr);

    // ã€æ–°å¢ã€‘æ§åˆ¶åŠ è½½åŠ¨ç”»
    void setLoading(bool loading);

    // ã€æ–°å¢ã€‘æ›´æ–°å›¾ç‰‡æ•°æ®ï¼ˆç”Ÿæˆå®Œæˆåè°ƒç”¨ï¼‰
    void updateImage(const QPixmap& img, const QString& serverFileName);

    // ã€æ–°å¢ã€‘è·å–æœåŠ¡å™¨æ–‡ä»¶åï¼ˆç»™é«˜æ¸…ä¿®å¤ç”¨ï¼‰
    QString serverFileName() const { return m_serverFileName; }

    // ã€æ–°å¢ã€‘å¾€æ°”æ³¡é‡Œè¿½åŠ æ–‡å­—
    void appendText(const QString& text);

signals:
    // ã€æ–°å¢ã€‘å³é”®èœå•è§¦å‘çš„ä¿¡å·
    void upscaleRequested(const QString& fileName, const QPixmap& img);

protected:
    /**
     * @brief äº‹ä»¶è¿‡æ»¤å™¨å¤„ç†
     * @param watched è¢«ç›‘è§†çš„å¯¹è±¡
     * @param event äº‹ä»¶
     * @return bool æ˜¯å¦å¤„ç†äº‹ä»¶
     */
    bool eventFilter(QObject *watched, QEvent *event) override;

private:
    /**
     * @brief åˆå§‹åŒ–UIå¸ƒå±€
     * @param data æ¶ˆæ¯æ•°æ®
     */
    void setupUi(const QVariant& data);

    /**
     * @brief åˆå§‹åŒ–æ–‡æœ¬æ°”æ³¡
     * @param text æ–‡æœ¬å†…å®¹
     */
    void initTextBubble(const QString& text);
    
    /**
     * @brief åˆå§‹åŒ–å›¾ç‰‡æ°”æ³¡
     * @param img å›¾ç‰‡æ•°æ®
     */
    void initImageBubble(const QPixmap& img);
    
    /**
     * @brief ä¿å­˜å›¾ç‰‡
     */
    void saveImage();
    
    /**
     * @brief æ˜¾ç¤ºå›¾ç‰‡æŸ¥çœ‹å™¨
     */
    void showViewer();

private:
    ChatRole m_role; ///< æ¶ˆæ¯è§’è‰²
    QHBoxLayout* m_layout; ///< æ°´å¹³å¸ƒå±€
    QPixmap m_currentImage; ///< å½“å‰å›¾ç‰‡æ•°æ®
    // ã€æ–°å¢ã€‘æˆå‘˜å˜é‡
    QLabel* m_contentLabel = nullptr; // ç»Ÿä¸€ç®¡ç†æ˜¾ç¤ºå†…å®¹çš„ Label
    QMovie* m_loadingMovie = nullptr; // åŠ è½½åŠ¨ç”»å¯¹è±¡
    QString m_serverFileName;         // æœåŠ¡å™¨ä¸Šçš„åŸå§‹æ–‡ä»¶å
};


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\ChatBubble.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\HistoryGallery.cpp ---

#include "HistoryGallery.h"
#include "../../Database/DatabaseManager.h"
#include <QScrollArea>
#include <QMouseEvent>
#include <QFileInfo>
#include <QScrollBar>
#include <QPainter>
#include <QDebug>
#include <QMenu>          // ã€æ–°å¢ã€‘èœå•
#include <QClipboard>     // ã€æ–°å¢ã€‘å‰ªè´´æ¿
#include <QApplication>   // ã€æ–°å¢ã€‘è·å–å…¨å±€å‰ªè´´æ¿

// =========================================================
// å†…éƒ¨ç±»ï¼šå•ä¸ªå›¾ç‰‡å¡ç‰‡ (æ”¯æŒå·¦é”®æŸ¥çœ‹ï¼Œå³é”®å¤åˆ¶)
// =========================================================
class GalleryItem : public QLabel
{
public:
    QString imagePath; // å­˜å‚¨åŸå›¾è·¯å¾„
    std::function<void(QString)> onClick; // ç‚¹å‡»å›è°ƒ

    GalleryItem(const QString& path, int targetWidth, QWidget* parent = nullptr)
        : QLabel(parent), imagePath(path)
    {
        // 1. æ ·å¼è®¾ç½®
        this->setStyleSheet(
            "QLabel { "
            "  background-color: black; "
            "  border: 1px solid #333; "
            "  border-radius: 6px; "
            "}"
            "QLabel:hover { "
            "  border: 1px solid #19C37D; " // æ‚¬åœå˜ç»¿
            "  cursor: pointer; "
            "}"
            );
        this->setAlignment(Qt::AlignCenter);

        // 2. åŠ è½½å¹¶ç¼©æ”¾å›¾ç‰‡ (ä»…æ˜¾ç¤ºç¼©ç•¥å›¾ä»¥èŠ‚çœå†…å­˜)
        QPixmap pix(path);
        if (!pix.isNull()) {
            // å®½åº¦å›ºå®šï¼Œé«˜åº¦æŒ‰æ¯”ä¾‹è‡ªåŠ¨ç¼©æ”¾ï¼Œä½¿ç”¨å¹³æ»‘ç®—æ³•
            QPixmap scaled = pix.scaledToWidth(targetWidth, Qt::SmoothTransformation);
            this->setPixmap(scaled);
            this->setFixedSize(scaled.size());
        } else {
            this->setText("âŒ å›¾ç‰‡ä¸¢å¤±");
            this->setFixedSize(targetWidth, 60);
            this->setStyleSheet("color: #666; border: 1px dashed #444; border-radius: 6px;");
        }
    }

protected:
    // æ•è·é¼ æ ‡ç‚¹å‡»äº‹ä»¶
    void mousePressEvent(QMouseEvent* event) override {
        // --- æƒ…å†µ A: å·¦é”®ç‚¹å‡» -> æŸ¥çœ‹å¤§å›¾ ---
        if (event->button() == Qt::LeftButton) {
            if (onClick) onClick(imagePath);
        }
        // --- æƒ…å†µ B: å³é”®ç‚¹å‡» -> å¼¹å‡ºèœå• ---
        else if (event->button() == Qt::RightButton) {
            showContextMenu(event->globalPosition().toPoint());
        }

        QLabel::mousePressEvent(event);
    }

private:
    void showContextMenu(const QPoint& pos) {
        QMenu menu;
        // ç»Ÿä¸€æ·±è‰²é£æ ¼æ ·å¼
        menu.setStyleSheet(
            "QMenu { background-color: #2D2D2D; color: white; border: 1px solid #555; padding: 5px; }"
            "QMenu::item { padding: 5px 20px; }"
            "QMenu::item:selected { background-color: #40414F; }"
            );

        // åŠ¨ä½œ 1: å¤åˆ¶å›¾ç‰‡
        QAction* actCopy = menu.addAction("â å¤åˆ¶å›¾ç‰‡");
        QObject::connect(actCopy, &QAction::triggered, [this](){
            // ã€å…³é”®ã€‘ä»è·¯å¾„é‡æ–°åŠ è½½åŸå›¾ï¼Œè€Œä¸æ˜¯å¤åˆ¶ç¼©ç•¥å›¾
            QPixmap originalPix(imagePath);
            if (!originalPix.isNull()) {
                QClipboard *clipboard = QApplication::clipboard();
                clipboard->setPixmap(originalPix);
                qDebug() << "å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿:" << imagePath;
            }
        });

        // åŠ¨ä½œ 2: å¤åˆ¶æ–‡ä»¶è·¯å¾„ (å¯é€‰ï¼Œæ–¹ä¾¿è°ƒè¯•)
        QAction* actPath = menu.addAction("ğŸ“‚ å¤åˆ¶è·¯å¾„");
        QObject::connect(actPath, &QAction::triggered, [this](){
            QClipboard *clipboard = QApplication::clipboard();
            clipboard->setText(imagePath);
        });

        menu.exec(pos);
    }
};

// =========================================================
// HistoryGallery ä¸»é€»è¾‘ (æ— éœ€æ”¹åŠ¨ï¼Œä¿æŒåŸæ ·å³å¯)
// =========================================================

HistoryGallery::HistoryGallery(QWidget *parent) : QWidget(parent)
{
    setupUi();
}

void HistoryGallery::setupUi()
{
    // 1. é¢æ¿åŸºç¡€æ ·å¼
    this->setFixedWidth(260);
    this->setStyleSheet("background-color: #202123; border-right: 1px solid #4D4D4F;");

    QVBoxLayout* mainLayout = new QVBoxLayout(this);
    mainLayout->setContentsMargins(0, 20, 0, 0);
    mainLayout->setSpacing(10);

    // 2. æ ‡é¢˜
    QLabel* title = new QLabel("ğŸ¨ ç”Ÿæˆå†å²", this);
    title->setStyleSheet("color: #ECECF1; font-weight: bold; font-size: 14px; padding-left: 15px; border: none;");
    mainLayout->addWidget(title);

    // 3. åˆ›å»ºæ»šåŠ¨åŒºåŸŸ
    m_scrollArea = new QScrollArea(this);
    m_scrollArea->setWidgetResizable(true);
    m_scrollArea->setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOff); // æ°´å¹³æ°¸è¿œå…³

    // ã€ä¿®æ”¹ç‚¹ 1ã€‘å¼ºåˆ¶å‚ç›´æ»šåŠ¨æ¡æ€»æ˜¯æ˜¾ç¤ºï¼ˆå³ä½¿å†…å®¹å¾ˆå°‘ä¹Ÿèƒ½çœ‹åˆ°è½¨é“ï¼‰
    m_scrollArea->setVerticalScrollBarPolicy(Qt::ScrollBarAlwaysOn);

    m_scrollArea->setFrameShape(QFrame::NoFrame);

    // 4. ä¼˜åŒ–æ»šè½®é€Ÿåº¦
    m_scrollArea->verticalScrollBar()->setSingleStep(20);

    // 5. ã€ä¿®æ”¹ç‚¹ 2ã€‘é«˜å¯¹æ¯”åº¦æ ·å¼ï¼ŒåŠ å®½æ»šåŠ¨æ¡
    m_scrollArea->setStyleSheet(
        "QScrollArea { "
        "   background: transparent; "
        "   border: none; "
        "}"

        // --- æ»šåŠ¨æ¡è½¨é“ (æ§½) ---
        "QScrollBar:vertical { "
        "    border: none; "
        "    background: #111111; "  // æ”¹æˆæ¥è¿‘é»‘è‰²ï¼Œå’Œé¢æ¿çš„æ·±ç°åŒºåˆ†å¼€
        "    width: 14px; "          // åŠ å®½åˆ° 14pxï¼Œéå¸¸æ˜æ˜¾
        "    margin: 0px; "
        "}"

        // --- æ»šåŠ¨æ»‘å— (é‚£ä¸ªæ‹–åŠ¨çš„å—) ---
        "QScrollBar::handle:vertical { "
        "    background: #666666; "  // æ˜æ˜¾çš„ç°è‰²
        "    min-height: 30px; "     // æœ€å°é«˜åº¦è®¾å¤§ä¸€ç‚¹
        "    border-radius: 7px; "   // åœ†è§’
        "    margin: 2px; "          // ç•™è¾¹è·ï¼Œè®©æ»‘å—æ‚¬æµ®åœ¨è½¨é“é‡Œ
        "}"

        // --- é¼ æ ‡æ‚¬åœå˜äº® ---
        "QScrollBar::handle:vertical:hover { "
        "    background: #999999; "  // æ‚¬åœå˜ç™½ä¸€ç‚¹
        "}"

        // --- éšè—ä¸Šä¸‹ç®­å¤´ (å¦‚æœä¸éšè—ï¼Œå¯èƒ½ä¼šå æ®ç©ºé—´æ˜¾ç¤ºä¸å‡ºæ¥) ---
        "QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical { "
        "    height: 0px; "
        "}"
        "QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical { "
        "    background: none; "
        "}"
        );

    // 6. æ»šåŠ¨å®¹å™¨ & å¸ƒå±€
    m_scrollContent = new QWidget();
    m_scrollContent->setStyleSheet("background: transparent;");

    m_scrollLayout = new QVBoxLayout(m_scrollContent);
    // è¿™é‡Œçš„è¾¹è·è¦æ³¨æ„ï¼šå³è¾¹è·å¯ä»¥ç¨å¾®æ”¹å°ä¸€ç‚¹(æ¯”å¦‚5)ï¼Œå› ä¸ºæ»šåŠ¨æ¡å äº†12pxç©ºé—´
    m_scrollLayout->setContentsMargins(15, 10, 5, 10);
    m_scrollLayout->setSpacing(15);
    m_scrollLayout->setAlignment(Qt::AlignTop); // å¿…é¡»ç½®é¡¶

    m_scrollArea->setWidget(m_scrollContent);
    mainLayout->addWidget(m_scrollArea);
}

void HistoryGallery::clearLayout()
{
    QLayoutItem* item;
    while ((item = m_scrollLayout->takeAt(0)) != nullptr) {
        if (item->widget()) {
            delete item->widget();
        }
        delete item;
    }
}

void HistoryGallery::loadImages()
{
    clearLayout();

    QVector<QString> paths = DatabaseManager::instance().getAllAiImages();

    if (paths.isEmpty()) {
        QLabel* empty = new QLabel("æš‚æ— è®°å½•", m_scrollContent);
        empty->setStyleSheet("color: #666; font-size: 12px; margin-top: 20px; border:none;");
        empty->setAlignment(Qt::AlignHCenter);
        m_scrollLayout->addWidget(empty);
        return;
    }

    int cardWidth = 220; // é€‚é…å®½åº¦çš„ç¼©ç•¥å›¾å°ºå¯¸

    for (const QString& path : paths) {
        if (!QFileInfo::exists(path)) continue;

        GalleryItem* item = new GalleryItem(path, cardWidth, m_scrollContent);

        // ç»‘å®šå·¦é”®ç‚¹å‡»
        item->onClick = [this](QString p){
            emit imageClicked(p);
        };

        m_scrollLayout->addWidget(item);
    }
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\HistoryGallery.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\HistoryGallery.h ---

#pragma once

#include <QWidget>
#include <QScrollArea>
#include <QVBoxLayout>
#include <QLabel>
#include <QVector>

class HistoryGallery : public QWidget
{
    Q_OBJECT
public:
    explicit HistoryGallery(QWidget *parent = nullptr);

    // åˆ·æ–°æ˜¾ç¤ºå›¾ç‰‡
    void loadImages();

signals:
    // å½“ç‚¹å‡»æŸå¼ å›¾ç‰‡æ—¶è§¦å‘ä¿¡å·
    void imageClicked(const QString& imagePath);

private:
    void setupUi();
    // æ¸…é™¤å½“å‰çš„åˆ—è¡¨é¡¹
    void clearLayout();

private:
    // ä½¿ç”¨ ScrollArea å®ç°æ»šè½®å’Œé•¿åˆ—è¡¨
    QScrollArea* m_scrollArea;
    QWidget* m_scrollContent;    // æ»šåŠ¨åŒºåŸŸé‡Œçš„å®ä½“å®¹å™¨
    QVBoxLayout* m_scrollLayout; // å‚ç›´å¸ƒå±€ï¼ˆå•åˆ—ï¼‰
};


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\HistoryGallery.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\ImageViewer.cpp ---

#include "ImageViewer.h"
#include <QVBoxLayout>
#include <QResizeEvent>
#include <QScreen>
#include <QApplication>
#include <QTimer>

ImageViewer::ImageViewer(const QPixmap& pixmap, QWidget* parent) : QDialog(parent) {
    this->setWindowTitle("æŸ¥çœ‹å›¾ç‰‡ (æ»šè½®ç¼©æ”¾/å·¦é”®æ‹–æ‹½/åŒå‡»è¿˜åŸ)");
    this->setWindowFlags(Qt::Window | Qt::WindowMinMaxButtonsHint | Qt::WindowCloseButtonHint);

    // 1. è®¾ç½®åˆç†çš„åˆå§‹çª—å£å¤§å° (å±å¹•çš„ 70%)
    QScreen *screen = QGuiApplication::primaryScreen();
    QSize screenSize = screen->availableGeometry().size();
    this->resize(screenSize * 0.7);

    // 2. åˆå§‹åŒ– Graphics ä½“ç³»
    QVBoxLayout* layout = new QVBoxLayout(this);
    layout->setContentsMargins(0, 0, 0, 0);

    m_scene = new QGraphicsScene(this);
    m_view = new QGraphicsView(m_scene, this);

    // --- å…³é”®è®¾ç½® ---
    // å¼€å¯æŠ—é”¯é½¿ï¼Œè®©å›¾ç‰‡ç¼©æ”¾åä¾ç„¶å¹³æ»‘
    m_view->setRenderHints(QPainter::Antialiasing | QPainter::SmoothPixmapTransform);
    // å¼€å¯â€œæŠ“æ‰‹â€æ¨¡å¼ï¼šå·¦é”®æŒ‰ä½æ‹–æ‹½
    m_view->setDragMode(QGraphicsView::ScrollHandDrag);
    // éšè—æ»šåŠ¨æ¡ (æˆ‘ä»¬ç”¨æ— é™ç”»å¸ƒæ¨¡å¼ï¼Œé€šå¸¸ä¸éœ€è¦æ»šåŠ¨æ¡)
    m_view->setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOff);
    m_view->setVerticalScrollBarPolicy(Qt::ScrollBarAlwaysOff);
    // è®¾ç½®èƒŒæ™¯è‰²ä¸ºæ·±ç°
    m_view->setStyleSheet("background-color: #1e1e1e; border: none;");
    // ç¼©æ”¾æ—¶çš„é”šç‚¹ï¼šä»¥é¼ æ ‡ä¸ºä¸­å¿ƒç¼©æ”¾ï¼Œä½“éªŒæœ€å¥½
    m_view->setTransformationAnchor(QGraphicsView::AnchorUnderMouse);
    m_view->setResizeAnchor(QGraphicsView::AnchorUnderMouse);

    // å®‰è£…äº‹ä»¶è¿‡æ»¤å™¨ç”¨äºç›‘å¬æ»šè½®ï¼ˆå› ä¸º QGraphicsView å¯èƒ½ä¼šåƒæ‰æ»šè½®äº‹ä»¶ï¼‰
    m_view->viewport()->installEventFilter(this);

    // æ·»åŠ å›¾ç‰‡
    m_item = new QGraphicsPixmapItem(pixmap);
    m_scene->addItem(m_item);

    layout->addWidget(m_view);

    // 3. åˆå§‹çŠ¶æ€ï¼šé€‚åº”çª—å£
    // ä½¿ç”¨ Timer å»¶æ—¶ 0ms è°ƒç”¨ï¼Œç¡®ä¿ layout å®Œæˆåå†è®¡ç®—å¤§å°
    QTimer::singleShot(0, this, [=](){
        fitImageToWindow();
    });
}

// æ ¸å¿ƒé€»è¾‘ï¼šè‡ªåŠ¨é€‚é…
void ImageViewer::fitImageToWindow() {
    if (!m_item || !m_view) return;

    // Qt ç¥æŠ€ï¼šè‡ªåŠ¨æŠŠ item ç¼©æ”¾åˆ° view çš„å¤§å°ï¼Œå¹¶ä¿æŒæ¯”ä¾‹
    m_view->fitInView(m_item, Qt::KeepAspectRatio);

    // æ ‡è®°ä¸º"è‡ªé€‚åº”æ¨¡å¼"
    m_isFitWindow = true;
}

// äº‹ä»¶1: çª—å£å¤§å°æ”¹å˜
void ImageViewer::resizeEvent(QResizeEvent *event) {
    QDialog::resizeEvent(event);

    // å¦‚æœç”¨æˆ·è¿˜æ²¡æ‰‹åŠ¨ç¼©æ”¾è¿‡ï¼Œé‚£ä¹ˆçª—å£å˜å¤§ï¼Œå›¾ç‰‡ä¹Ÿè·Ÿç€å˜å¤§
    if (m_isFitWindow) {
        fitImageToWindow();
    }
}

// äº‹ä»¶2: åŒå‡»è¿˜åŸ
void ImageViewer::mouseDoubleClickEvent(QMouseEvent *event) {
    Q_UNUSED(event);
    // åŒå‡»ä»»æ„åœ°æ–¹ï¼Œæ¢å¤åˆ°â€œé€‚åº”çª—å£â€çŠ¶æ€
    fitImageToWindow();
}

// äº‹ä»¶3: æ»šè½®ç¼©æ”¾
bool ImageViewer::eventFilter(QObject *watched, QEvent *event) {
    if (watched == m_view->viewport() && event->type() == QEvent::Wheel) {
        QWheelEvent* wheelEvent = static_cast<QWheelEvent*>(event);

        // åªè¦ç”¨æˆ·åŠ¨äº†æ»šè½®ï¼Œå°±é€€å‡ºâ€œè‡ªé€‚åº”æ¨¡å¼â€
        m_isFitWindow = false;

        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
        double angle = wheelEvent->angleDelta().y();
        double factor;
        if (angle > 0) {
            factor = 1.15; // æ”¾å¤§ 15%
        } else {
            factor = 1.0 / 1.15; // ç¼©å°
        }

        // æ‰§è¡Œç¼©æ”¾
        m_view->scale(factor, factor);

        return true; // äº‹ä»¶å·²å¤„ç†ï¼Œä¸å†å‘ä¸‹ä¼ é€’
    }
    return QDialog::eventFilter(watched, event);
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\ImageViewer.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\ImageViewer.h ---

/**
 * @file ImageViewer.h
 * @brief å›¾ç‰‡æŸ¥çœ‹å™¨ç»„ä»¶å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†ImageViewerç±»ï¼Œæä¾›å›¾ç‰‡æŸ¥çœ‹åŠŸèƒ½ï¼Œæ”¯æŒè‡ªé€‚åº”æ˜¾ç¤ºã€ç¼©æ”¾å’ŒåŒå‡»è¿˜åŸã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once
#include <QDialog>
#include <QGraphicsView>
#include <QGraphicsScene>
#include <QGraphicsPixmapItem>

/**
 * @brief å›¾ç‰‡æŸ¥çœ‹å™¨ç±»
 * 
 * ç»§æ‰¿è‡ªQDialogï¼Œæä¾›å›¾ç‰‡æŸ¥çœ‹åŠŸèƒ½ï¼Œæ”¯æŒè‡ªé€‚åº”æ˜¾ç¤ºã€é¼ æ ‡æ»šè½®ç¼©æ”¾å’ŒåŒå‡»è¿˜åŸæ“ä½œã€‚
 */
class ImageViewer : public QDialog {
    Q_OBJECT
public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param pixmap è¦æ˜¾ç¤ºçš„å›¾ç‰‡
     * @param parent çˆ¶çª—å£æŒ‡é’ˆ
     */
    explicit ImageViewer(const QPixmap& pixmap, QWidget* parent = nullptr);

protected:
    /**
     * @brief çª—å£å¤§å°å˜åŒ–äº‹ä»¶å¤„ç†
     * @param event å¤§å°å˜åŒ–äº‹ä»¶
     * 
     * å®ç°å›¾ç‰‡è‡ªé€‚åº”çª—å£å¤§å°åŠŸèƒ½ã€‚
     */
    void resizeEvent(QResizeEvent *event) override;
    
    /**
     * @brief äº‹ä»¶è¿‡æ»¤å™¨å¤„ç†
     * @param watched è¢«ç›‘è§†çš„å¯¹è±¡
     * @param event äº‹ä»¶
     * @return bool æ˜¯å¦å¤„ç†äº‹ä»¶
     * 
     * ç›‘å¬é¼ æ ‡æ»šè½®äº‹ä»¶ï¼Œå®ç°å›¾ç‰‡ç¼©æ”¾åŠŸèƒ½ã€‚
     */
    bool eventFilter(QObject *watched, QEvent *event) override;
    
    /**
     * @brief é¼ æ ‡åŒå‡»äº‹ä»¶å¤„ç†
     * @param event é¼ æ ‡äº‹ä»¶
     * 
     * ç›‘å¬åŒå‡»äº‹ä»¶ï¼Œå®ç°å›¾ç‰‡è¿˜åŸåˆ°è‡ªé€‚åº”æ¨¡å¼ã€‚
     */
    void mouseDoubleClickEvent(QMouseEvent *event) override;

private:
    /**
     * @brief å›¾ç‰‡è‡ªé€‚åº”çª—å£åŠŸèƒ½
     * 
     * æ ¸å¿ƒåŠŸèƒ½ï¼šå°†å›¾ç‰‡é€‚é…åˆ°å½“å‰çª—å£å¤§å°ã€‚
     */
    void fitImageToWindow();

private:
    QGraphicsView* m_view;          ///< å›¾å½¢è§†å›¾çª—å£
    QGraphicsScene* m_scene;        ///< å›¾å½¢åœºæ™¯å®¹å™¨
    QGraphicsPixmapItem* m_item;    ///< å›¾ç‰‡å›¾å…ƒå¯¹è±¡

    /**
     * @brief è‡ªé€‚åº”çª—å£æ¨¡å¼æ ‡è®°
     * 
     * true: çª—å£å˜å¤§ï¼Œå›¾ç‰‡è·Ÿç€å˜å¤§ï¼ˆè‡ªé€‚åº”æ¨¡å¼ï¼‰
     * false: ç”¨æˆ·å·²æ‰‹åŠ¨ç¼©æ”¾ï¼Œçª—å£å˜å¤§ä¸å†å½±å“å›¾ç‰‡æ¯”ä¾‹
     */
    bool m_isFitWindow = true;
};


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\ImageViewer.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\InputPanel.cpp ---

#include "InputPanel.h"
#include <QHBoxLayout>
#include <QLabel>
#include <QActionGroup>
#include <QScrollBar> // å¼•å…¥æ»šåŠ¨æ¡å¤´æ–‡ä»¶ä»¥ä¾¿ç¾åŒ–
#include <QKeyEvent>

InputPanel::InputPanel(QWidget *parent) : QWidget(parent) {
    m_currentResolution = QSize(1024, 1024);

    // è®¾ç½®åº•éƒ¨é¢æ¿çš„èƒŒæ™¯å’Œè¾¹æ¡†
    this->setStyleSheet("InputPanel { background-color: #343541; border-top: 1px solid #5D5D67; }");

    // è®¾ç½®ä¸€ä¸ªåˆç†çš„åˆå§‹é«˜åº¦ç­–ç•¥
    this->setSizePolicy(QSizePolicy::Preferred, QSizePolicy::Minimum);

    QHBoxLayout* layout = new QHBoxLayout(this);
    // å¯¹é½æ–¹å¼è®¾ä¸º Bottomï¼Œè¿™æ ·å½“è¾“å…¥æ¡†å˜é«˜æ—¶ï¼ŒæŒ‰é’®ä¿æŒåœ¨åº•éƒ¨å¯¹é½ï¼ˆå¯é€‰ï¼Œçœ‹ä½ å–œå¥½ï¼‰
    layout->setAlignment(Qt::AlignBottom);
    layout->setContentsMargins(20, 20, 20, 20);
    layout->setSpacing(15);

    // 1. [æ–°å¢] å‚è€ƒå›¾æŒ‰é’® (ä½¿ç”¨ QToolButton)
    m_btnRef = new QToolButton(this);
    m_btnRef->setText("ğŸ“"); // æš‚æ—¶ç”¨æ–‡å­—ä»£æ›¿å›¾æ ‡ï¼Œä»¥åæ¢ QIcon
    m_btnRef->setFixedSize(40, 40);
    // æ ·å¼ï¼šæ­£å¸¸æ˜¯ç™½è‰²ï¼Œç¦ç”¨æ˜¯ç°è‰²
    m_btnRef->setStyleSheet(
        "QToolButton { background-color: transparent; border: 1px solid #555; border-radius: 20px; color: white; font-size: 20px; }"
        "QToolButton:hover { background-color: #444; }"
        "QToolButton:disabled { color: #555; border-color: #333; }" // ç¦ç”¨æ ·å¼
        );
    layout->addWidget(m_btnRef);

    // =================================================
    // ã€æ–°å¢ã€‘åæ¨æŒ‰é’® (é­”æ³•æ£’)
    // =================================================
    m_btnInterrogate = new QToolButton(this);
    m_btnInterrogate->setText("ğŸª„"); // é­”æ³•æ£’å›¾æ ‡
    m_btnInterrogate->setFixedSize(40, 40);
    m_btnInterrogate->setToolTip("ä¸Šä¼ å›¾ç‰‡åæ¨æç¤ºè¯");
    m_btnInterrogate->setStyleSheet(
        "QToolButton { background-color: transparent; border: 1px solid #555; border-radius: 20px; color: white; font-size: 20px; }"
        "QToolButton:hover { background-color: #444; }"
        );
    layout->addWidget(m_btnInterrogate);
    // =================================================


    // =========================================================
    // ã€æ–°å¢ã€‘2. ç”»å¹…æ¯”ä¾‹æŒ‰é’®
    // =========================================================
    m_btnRatio = new QToolButton(this);
    m_btnRatio->setText("1:1"); // é»˜è®¤æ–‡å­—
    m_btnRatio->setFixedSize(60, 40); // ç¨å¾®å®½ä¸€ç‚¹æ”¾æ–‡å­—
    m_btnRatio->setPopupMode(QToolButton::InstantPopup); // ç‚¹å‡»ç›´æ¥å¼¹èœå•
    m_btnRatio->setStyleSheet(
        "QToolButton { background-color: transparent; border: 1px solid #555; border-radius: 4px; color: white; font-weight: bold; }"
        "QToolButton:hover { background-color: #444; }"
        "QToolButton::menu-indicator { image: none; }" // éšè—è‡ªå¸¦çš„å°ä¸‰è§’
        );

    setupRatioMenu();
    layout->addWidget(m_btnRatio);
    // =========================================================

    // 2. å·¥ä½œæµæŒ‰é’®
    m_btnWorkflow = new QPushButton("ğŸ¨ é€‰æ‹©å·¥ä½œæµ", this);
    m_btnWorkflow->setFixedSize(120, 40);
    m_btnWorkflow->setStyleSheet(
        "QPushButton { background-color: #40414F; color: white; border-radius: 4px; }"
        "QPushButton:hover { background-color: #50515F; }"
    );
    layout->addWidget(m_btnWorkflow);

    m_inputEdit = new QPlainTextEdit(this);
    m_inputEdit->setPlaceholderText("è¾“å…¥æç¤ºè¯... (Shift+Enter æ¢è¡Œ)");

    // è®¾ç½®åˆå§‹æ ·å¼
    m_inputEdit->setStyleSheet(
        "QPlainTextEdit { "
        "   background-color: #40414F; "
        "   color: white; "
        "   border: 1px solid #555; "
        "   border-radius: 4px; "
        "   padding: 8px; " // å†…è¾¹è·å¤§ä¸€ç‚¹æ›´å¥½çœ‹
        "   font-size: 14px; "
        "}"
        "QPlainTextEdit:focus { border-color: #19C37D; }"

        // éšè—/ç¾åŒ–æ»šåŠ¨æ¡ (å’Œä¹‹å‰ HistoryGallery ç±»ä¼¼)
        "QScrollBar:vertical { width: 8px; background: transparent; }"
        "QScrollBar::handle:vertical { background: #666; border-radius: 4px; }"
        );

    // åˆå§‹é«˜åº¦è®¾ä¸ºä¸€è¡Œçš„é«˜åº¦ (çº¦40px)
    m_inputEdit->setFixedHeight(40);
    m_inputEdit->setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Fixed);

    // å®‰è£…äº‹ä»¶è¿‡æ»¤å™¨ (ç”¨äºæ‹¦æˆªå›è½¦)
    m_inputEdit->installEventFilter(this);

    // ç›‘å¬æ–‡å­—å˜åŒ–ï¼Œè‡ªåŠ¨è°ƒæ•´é«˜åº¦
    connect(m_inputEdit, &QPlainTextEdit::textChanged, this, &InputPanel::adjustInputHeight);

    layout->addWidget(m_inputEdit);

    // 4. ç”ŸæˆæŒ‰é’®
    m_btnGenerate = new QPushButton("ç”Ÿæˆ", this);
    m_btnGenerate->setFixedSize(80, 40); // æŒ‰é’®é«˜åº¦å›ºå®š
    m_btnGenerate->setStyleSheet(
        "QPushButton { background-color: #19C37D; color: white; border-radius: 4px; font-weight: bold; }"
        "QPushButton:hover { background-color: #1AD48A; }"
        "QPushButton:disabled { background-color: #2A2B32; color: #888; }"
        );
    layout->addWidget(m_btnGenerate);

    // è¿æ¥ä¿¡å·
    connect(m_btnGenerate, &QPushButton::clicked, this, &InputPanel::onGenerateClicked);

}



bool InputPanel::eventFilter(QObject *obj, QEvent *e)
{
    if (obj == m_inputEdit && e->type() == QEvent::KeyPress) {
        QKeyEvent *keyEvent = static_cast<QKeyEvent*>(e);

        // å¦‚æœæŒ‰ä¸‹çš„æ˜¯ Enter (Key_Return)
        if (keyEvent->key() == Qt::Key_Return || keyEvent->key() == Qt::Key_Enter) {
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº† Shift
            if (keyEvent->modifiers() & Qt::ShiftModifier) {
                // Shift + Enter -> å…è®¸æ¢è¡Œ (é»˜è®¤è¡Œä¸ºï¼Œä¸åšå¤„ç†ï¼Œè¿”å› false è®©æ§ä»¶è‡ªå·±å¤„ç†)
                return false;
            } else {
                // å•ç‹¬æŒ‰ Enter -> å‘é€æ¶ˆæ¯
                onGenerateClicked();
                return true; // äº‹ä»¶å·²å¤„ç†ï¼Œä¸å†ä¼ é€’ç»™æ§ä»¶(é˜²æ­¢äº§ç”Ÿæ¢è¡Œ)
            }
        }
    }
    return QWidget::eventFilter(obj, e);
}

// ã€æ–°å¢ã€‘è‡ªåŠ¨è°ƒæ•´é«˜åº¦é€»è¾‘
void InputPanel::adjustInputHeight()
{
    QTextDocument *doc = m_inputEdit->document();
    // è°ƒæ•´æ–‡æ¡£å¸ƒå±€å®½åº¦ä»¥åŒ¹é…æ§ä»¶å®½åº¦ (é˜²æ­¢æ¢è¡Œè®¡ç®—é”™è¯¯)
    doc->setTextWidth(m_inputEdit->viewport()->width());

    // è®¡ç®—å†…å®¹æ€»é«˜åº¦
    int contentHeight = doc->size().height();

    // åŠ ä¸Šä¸Šä¸‹çš„ padding (CSSé‡Œè®¾ç½®äº† padding: 8pxï¼Œä¸Šä¸‹åŠ èµ·æ¥çº¦16ï¼Œå¾®è°ƒä¸€ä¸‹)
    int margins = 16;
    int totalHeight = contentHeight + margins;

    // è®¾å®šé™åˆ¶
    int minHeight = 40;  // 1è¡Œçš„é«˜åº¦
    int maxHeight = 120; // çº¦ 4-5 è¡Œçš„é«˜åº¦

    // é™åˆ¶åœ¨ min å’Œ max ä¹‹é—´
    int finalHeight = qBound(minHeight, totalHeight, maxHeight);

    if (m_inputEdit->height() != finalHeight) {
        m_inputEdit->setFixedHeight(finalHeight);

        // å¦‚æœä½ çš„ InputPanel ä¹‹å‰è®¾ç½®äº† fixedHeightï¼Œè¿™é‡Œéœ€è¦è®©çˆ¶æ§ä»¶ä¹Ÿ updateGeometry
        // å› ä¸ºæˆ‘ä»¬å»æ‰äº† setFixedHeightï¼Œè¿™é‡Œä¼šè‡ªåŠ¨è§¦å‘å¸ƒå±€é‡ç®—
    }

    // åªæœ‰å½“å†…å®¹è¶…è¿‡æœ€å¤§é«˜åº¦æ—¶ï¼Œæ‰æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡
    if (totalHeight > maxHeight) {
        m_inputEdit->setVerticalScrollBarPolicy(Qt::ScrollBarAsNeeded);
    } else {
        m_inputEdit->setVerticalScrollBarPolicy(Qt::ScrollBarAlwaysOff);
    }
}

void InputPanel::onGenerateClicked() {
    // è·å–çº¯æ–‡æœ¬
    QString prompt = m_inputEdit->toPlainText().trimmed();
    if (!prompt.isEmpty()) {
        emit generateClicked(prompt);
        // æ¸…ç©ºå¹¶é‡ç½®é«˜åº¦
        m_inputEdit->clear();
        adjustInputHeight();
    }
}





void InputPanel::setupRatioMenu()
{
    m_ratioMenu = new QMenu(this);
    m_ratioMenu->setStyleSheet("QMenu { background-color: #2D2D2D; color: white; border: 1px solid #555; } QMenu::item:selected { background-color: #40414F; }");

    QActionGroup* group = new QActionGroup(this);

    // å®šä¹‰ SDXL ç”œç‚¹åˆ†è¾¨ç‡ (æ€»åƒç´ çº¦ 1024*1024)
    struct Ratio { QString name; int w; int h; };
    QList<Ratio> ratios = {
        {"1:1 (æ–¹å›¾)", 1024, 1024},
        {"3:4 (ç«–å›¾)", 896, 1152},
        {"4:3 (æ¨ªå›¾)", 1152, 896},
        {"9:16 (æ‰‹æœº)", 832, 1216},
        {"16:9 (ç”µè„‘)", 1216, 832}
    };

    for (const auto& r : ratios) {
        QAction* action = m_ratioMenu->addAction(r.name);
        action->setData(QSize(r.w, r.h)); // æŠŠå®½é«˜å­˜å…¥ data
        action->setCheckable(true);
        group->addAction(action);

        if (r.name.startsWith("1:1")) {
            action->setChecked(true);
            m_currentResolution = QSize(r.w, r.h);
        }
    }

    connect(m_ratioMenu, &QMenu::triggered, this, &InputPanel::onRatioSelected);
    m_btnRatio->setMenu(m_ratioMenu);
}

void InputPanel::onRatioSelected(QAction* action)
{
    QSize size = action->data().toSize();
    m_currentResolution = size;

    // æ›´æ–°æŒ‰é’®æ–‡å­—ï¼Œå–å†’å·å‰çš„éƒ¨åˆ† (ä¾‹å¦‚ "16:9")
    QString text = action->text().split(" ").first();
    m_btnRatio->setText(text);

    emit resolutionChanged(size.width(), size.height());
}

void InputPanel::updateState(WorkflowType type) {
    if (type == WorkflowType::TextToImage) {
        // --- æ–‡ç”Ÿå›¾æ¨¡å¼ ---
        // 1. ç¦ç”¨å‚è€ƒå›¾ä¸Šä¼ ï¼ˆå› ä¸ºçº¯æ–‡ç”Ÿå›¾ä¸éœ€è¦ï¼‰
        m_btnRef->setEnabled(false);

        // 2. å¯ç”¨ç”»å¹…æ¯”ä¾‹é€‰æ‹©
        m_btnRatio->setEnabled(true);

        // 3. ã€æ–°å¢ã€‘ç¦ç”¨åæ¨æŒ‰é’®ï¼ˆå› ä¸ºæ²¡æœ‰å›¾ç‰‡å¯ä»¥åæ¨ï¼‰
        if (m_btnInterrogate) m_btnInterrogate->setEnabled(false);

    } else {
        // --- å›¾ç”Ÿå›¾/å…¶ä»–æ¨¡å¼ ---
        // 1. å¯ç”¨å‚è€ƒå›¾ä¸Šä¼ 
        m_btnRef->setEnabled(true);

        // 2. ç¦ç”¨ç”»å¹…æ¯”ä¾‹ï¼ˆé€šå¸¸è·ŸéšåŸå›¾å°ºå¯¸ï¼‰
        m_btnRatio->setEnabled(false);
        m_btnRatio->setText("Auto");

        // 3. ã€æ–°å¢ã€‘å¯ç”¨åæ¨æŒ‰é’®
        if (m_btnInterrogate) m_btnInterrogate->setEnabled(true);
    }
}

QSize InputPanel::currentResolution() const {
    return m_currentResolution;
}



// setLocked å‡½æ•°ä¹Ÿè¦ä¿®æ”¹ä¸€ä¸‹ï¼Œå› ä¸ºæ§ä»¶ç±»å‹å˜äº†
void InputPanel::setLocked(bool locked)
{
    bool enabled = !locked;

    m_btnRef->setEnabled(enabled);
    m_btnInterrogate->setEnabled(enabled);
    m_btnRatio->setEnabled(enabled);
    m_btnWorkflow->setEnabled(enabled);

    // QPlainTextEdit ä¹Ÿæœ‰ setEnabledï¼Œæˆ–è€…ç”¨ setReadOnly
    m_inputEdit->setEnabled(enabled);
    if (locked) {
        m_inputEdit->setPlaceholderText("ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...");
    } else {
        m_inputEdit->setPlaceholderText("è¾“å…¥æç¤ºè¯... (Shift+Enter æ¢è¡Œ)");
    }

    m_btnGenerate->setEnabled(enabled);
}

void InputPanel::setConnectionStatus(bool isConnected)
{
    // 1. å¤ç”¨ setLocked çš„é€»è¾‘æ¥ ç¦ç”¨/å¯ç”¨ æŒ‰é’®
    // å¦‚æœ isConnected ä¸º false (æœªè¿æ¥)ï¼Œåˆ™ locked ä¸º true (é”å®š)
    // ä½†è¿™é‡Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼Œå› ä¸º setLocked ä¼šæ”¹æ–‡å­—ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨è®¾ enabled

    bool enable = isConnected;

    m_btnGenerate->setEnabled(enable);
    m_btnWorkflow->setEnabled(enable);
    m_btnRef->setEnabled(enable);
    m_inputEdit->setEnabled(enable);

    if (m_btnInterrogate) m_btnInterrogate->setEnabled(enable);
    // æ³¨æ„ï¼šæ¯”ä¾‹æŒ‰é’®åœ¨æ–‡ç”Ÿå›¾æ¨¡å¼ä¸‹æ‰å¯ç”¨ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼Œ updateState ä¼šè‡ªåŠ¨ä¿®æ­£
    if (m_btnRatio) m_btnRatio->setEnabled(enable);

    // 2. ã€å…³é”®ã€‘è®¾ç½®ä¸“å±çš„æç¤ºæ–‡å­—
    if (isConnected) {
        m_inputEdit->setPlaceholderText("è¾“å…¥æç¤ºè¯... (Shift+Enter æ¢è¡Œ)");
        m_btnGenerate->setText("ç”Ÿæˆ");
    } else {
        m_inputEdit->setPlaceholderText("âš ï¸ æœªè¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç‚¹å‡»å·¦ä¸‹è§’è®¾ç½®è¿›è¡Œè¿æ¥...");
        m_btnGenerate->setText("æœªè¿æ¥");
    }
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\InputPanel.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\InputPanel.h ---

/**
 * @file InputPanel.h
 * @brief è¾“å…¥é¢æ¿ç»„ä»¶å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†InputPanelç±»ï¼Œä½œä¸ºåº”ç”¨ç¨‹åºåº•éƒ¨çš„è¾“å…¥æ§åˆ¶é¢æ¿ã€‚
 * åŒ…å«å·¥ä½œæµæŒ‰é’®ã€å‚è€ƒå›¾æŒ‰é’®å’ŒçŠ¶æ€æ›´æ–°åŠŸèƒ½ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once
#include <QWidget>
#include <QPushButton>
#include <QToolButton> // ä½¿ç”¨ ToolButton åšçº¯å›¾æ ‡æŒ‰é’®æ›´åˆé€‚
#include <QLineEdit>
#include <QMenu>
#include <QPlainTextEdit>
#include "../../Model/WorkflowTypes.h"

/**
 * @brief è¾“å…¥é¢æ¿ç±»
 * 
 * ç»§æ‰¿è‡ªQWidgetï¼Œæä¾›å·¥ä½œæµé€‰æ‹©ã€å‚è€ƒå›¾ä¸Šä¼ å’Œæ–‡æœ¬è¾“å…¥åŠŸèƒ½ã€‚
 * åŒ…å«æŒ‰é’®ç»„ä»¶ã€è¾“å…¥æ¡†å’ŒçŠ¶æ€ç®¡ç†åŠŸèƒ½ã€‚
 */
class InputPanel : public QWidget {
    Q_OBJECT
public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param parent çˆ¶çª—å£æŒ‡é’ˆ
     */
    explicit InputPanel(QWidget *parent = nullptr);

    /**
     * @brief è·å–å·¥ä½œæµæŒ‰é’®
     * @return QPushButton* å·¥ä½œæµæŒ‰é’®æŒ‡é’ˆ
     */
    QPushButton* getWorkflowBtn() const { return m_btnWorkflow; }
    
    /**
     * @brief è·å–å‚è€ƒå›¾æŒ‰é’®
     * @return QToolButton* å‚è€ƒå›¾æŒ‰é’®æŒ‡é’ˆ
     */
    QToolButton* getRefBtn() const { return m_btnRef; }

    /**
     * @brief è·å–ç”ŸæˆæŒ‰é’®
     * @return QPushButton* ç”ŸæˆæŒ‰é’®æŒ‡é’ˆ
     */
    QPushButton* getGenerateBtn() const { return m_btnGenerate; }

    /**
     * @brief è·å–è¾“å…¥æ¡†
     * @return QLineEdit* è¾“å…¥æ¡†æŒ‡é’ˆ
     */
    QPlainTextEdit* getInputEdit() const { return m_inputEdit; }

    /**
     * @brief æ ¹æ®å·¥ä½œæµç±»å‹æ›´æ–°UIçŠ¶æ€
     * @param type å·¥ä½œæµç±»å‹
     */
    void updateState(WorkflowType type);

    // ã€æ–°å¢ã€‘è·å–å½“å‰é€‰æ‹©çš„åˆ†è¾¨ç‡
    QSize currentResolution() const;

    // ã€æ–°å¢ã€‘è·å–åæ¨æŒ‰é’®
    QToolButton* getInterrogateBtn() const { return m_btnInterrogate; }

    // ã€æ–°å¢ã€‘é”å®š/è§£é”é¢æ¿æ‰€æœ‰æ§ä»¶
    void setLocked(bool locked);

    // ã€æ–°å¢ã€‘è®¾ç½®è¿æ¥çŠ¶æ€ (ä¸“é—¨ç”¨äºç½‘ç»œæ–­å¼€æ—¶çš„é”å®š)
    void setConnectionStatus(bool isConnected);

signals:
    /**
     * @brief ç”ŸæˆæŒ‰é’®ç‚¹å‡»ä¿¡å·
     * @param prompt è¾“å…¥çš„æç¤ºè¯æ–‡æœ¬
     */
    void generateClicked(const QString& prompt);

    // ã€æ–°å¢ã€‘æ¯”ä¾‹æ”¹å˜ä¿¡å·ï¼ˆå¯é€‰ï¼Œå¦‚æœMainWindowéœ€è¦ç«‹å³çŸ¥é“ï¼‰
    void resolutionChanged(int w, int h);

protected:
    // ã€æ–°å¢ã€‘é‡å†™äº‹ä»¶è¿‡æ»¤å™¨ï¼Œå¤„ç†å›è½¦é”®
    bool eventFilter(QObject *obj, QEvent *e) override;

private slots:
    /**
     * @brief å¤„ç†ç”ŸæˆæŒ‰é’®ç‚¹å‡»
     */
    void onGenerateClicked();

    // ã€æ–°å¢ã€‘å¤„ç†æ¯”ä¾‹é€‰æ‹©
    void onRatioSelected(QAction* action);

    // ã€æ–°å¢ã€‘æ–‡æœ¬å˜åŒ–æ—¶è°ƒæ•´é«˜åº¦
    void adjustInputHeight();

private:
    void setupRatioMenu(); // åˆå§‹åŒ–èœå•

private:
    QPushButton* m_btnWorkflow;
    QToolButton* m_btnRef;

    // ã€æ–°å¢ã€‘æ¯”ä¾‹æŒ‰é’®
    QToolButton* m_btnRatio;
    QMenu* m_ratioMenu;
    QSize m_currentResolution; // å½“å‰é€‰ä¸­çš„åˆ†è¾¨ç‡

    QPlainTextEdit* m_inputEdit;
    QPushButton* m_btnGenerate;

    QToolButton* m_btnInterrogate; // ã€æ–°å¢ã€‘
};


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\InputPanel.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\ReferencePopup.cpp ---

#include "ReferencePopup.h"
#include <QVBoxLayout>
#include <QHBoxLayout>
#include <QLabel>
#include <QPushButton>
#include <QDragEnterEvent>
#include <QMimeData>
#include <QFileDialog>
#include <QStackedLayout>
#include <QPainter>
#include <QPainterPath>
#include <QStandardPaths>
#include <QFileInfo>

ReferencePopup::ReferencePopup(QWidget *parent) : QWidget(parent) {
    // ã€é‡è¦ã€‘ï¼šå…è®¸æ‹–æ‹½
    this->setAcceptDrops(true);

    // è®¾ç½®çª—å£å±æ€§
    // ä½¿ç”¨ Qt::Tool è€Œä¸æ˜¯ Popupï¼Œé˜²æ­¢ç‚¹å‡»å¤–éƒ¨æ—¶çª—å£è‡ªåŠ¨å…³é—­
    // åŒæ—¶é…åˆ Qt::FramelessWindowHint å»æ‰è¾¹æ¡†
    this->setWindowFlags(Qt::Tool | Qt::FramelessWindowHint | Qt::WindowStaysOnTopHint);
    this->setAttribute(Qt::WA_TranslucentBackground);
    
    // è®¾ç½®ç„¦ç‚¹ç­–ç•¥ï¼Œå…è®¸çª—å£è·å–ç„¦ç‚¹
    this->setFocusPolicy(Qt::StrongFocus);

    this->setFixedSize(320, 240); //ç¨å¾®å¤§ä¸€ç‚¹

    // åˆå§‹åŒ–æˆå‘˜å˜é‡ï¼Œç¡®ä¿èƒ½è®°ä½å·²æ·»åŠ çš„å‚è€ƒå›¾
    m_currentImage = QPixmap();
    m_currentPath.clear();

    setupUi();
}

void ReferencePopup::setupUi() {
    QVBoxLayout* mainLayout = new QVBoxLayout(this);
    mainLayout->setContentsMargins(0, 0, 0, 0);

    // 1. ä¸»å®¹å™¨ï¼ˆæ·±è‰²åœ†è§’èƒŒæ™¯ï¼‰
    QWidget* container = new QWidget(this);
    container->setStyleSheet(
        "QWidget { background-color: #2D2D2D; border: 1px solid #444; border-radius: 8px; }"
        );
    // ç»™ container åŠ é˜´å½±ä¼šæ›´å¥½çœ‹ï¼ˆè¿™é‡Œçœç•¥ï¼Œä¿æŒç®€æ´ï¼‰

    QVBoxLayout* containerLayout = new QVBoxLayout(container);
    containerLayout->setContentsMargins(15, 15, 15, 15);

    // 2. æ ‡é¢˜æ 
    QLabel* title = new QLabel("å‚è€ƒå›¾ (Reference)", container);
    title->setStyleSheet("color: #ECECF1; font-weight: bold; border: none;");
    containerLayout->addWidget(title);

    // 3. å †æ ˆå¸ƒå±€ (æ ¸å¿ƒï¼šåˆ‡æ¢ç©ºçŠ¶æ€å’Œé¢„è§ˆçŠ¶æ€)
    m_stackLayout = new QStackedLayout();

    // --- é¡µé¢ A: ç©ºçŠ¶æ€ (æ‹–æ‹½åŒº + æŒ‰é’®) ---
    m_pageEmpty = new QWidget(container);
    m_pageEmpty->setStyleSheet("background: transparent; border: none;");
    QVBoxLayout* emptyLayout = new QVBoxLayout(m_pageEmpty);
    emptyLayout->setContentsMargins(0, 10, 0, 0);

    // è™šçº¿æ¡† Label
    QLabel* lblDropZone = new QLabel("æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„\n\næˆ–", m_pageEmpty);
    lblDropZone->setAlignment(Qt::AlignCenter);
    lblDropZone->setStyleSheet(
        "QLabel { "
        "  border: 2px dashed #555; "
        "  border-radius: 6px; "
        "  color: #888; "
        "  background-color: #343541; "
        "}"
        );

    // ä¸Šä¼ æŒ‰é’®
    QPushButton* btnUpload = new QPushButton("é€‰æ‹©æœ¬åœ°æ–‡ä»¶", m_pageEmpty);
    btnUpload->setCursor(Qt::PointingHandCursor);
    btnUpload->setFixedHeight(36);
    btnUpload->setStyleSheet(
        "QPushButton { background-color: #40414F; color: white; border-radius: 4px; border: none; }"
        "QPushButton:hover { background-color: #50515F; }"
        );
    connect(btnUpload, &QPushButton::clicked, this, [=](){
        QString path = QFileDialog::getOpenFileName(this, "é€‰æ‹©å‚è€ƒå›¾",
                                                    QStandardPaths::writableLocation(QStandardPaths::PicturesLocation),
                                                    "Images (*.png *.jpg *.jpeg *.bmp)");
        if (!path.isEmpty()) {
            loadImage(path);
        }
    });

    emptyLayout->addWidget(lblDropZone);
    emptyLayout->addWidget(btnUpload);

    // --- é¡µé¢ B: é¢„è§ˆçŠ¶æ€ (å›¾ç‰‡ + åˆ é™¤æŒ‰é’®) ---
    m_pagePreview = new QWidget(container);
    m_pagePreview->setStyleSheet("background: transparent; border: none;");
    QVBoxLayout* previewLayout = new QVBoxLayout(m_pagePreview);
    previewLayout->setContentsMargins(0, 10, 0, 0);

    // å›¾ç‰‡é¢„è§ˆåŒº
    m_lblPreview = new QLabel(m_pagePreview);
    m_lblPreview->setAlignment(Qt::AlignCenter);
    m_lblPreview->setStyleSheet("border: 1px solid #444; border-radius: 4px; background-color: #000;");
    m_lblPreview->setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Expanding);

    // åˆ é™¤æŒ‰é’®
    QPushButton* btnRemove = new QPushButton("ğŸ—‘ ç§»é™¤å‚è€ƒå›¾", m_pagePreview);
    btnRemove->setCursor(Qt::PointingHandCursor);
    btnRemove->setFixedHeight(36);
    btnRemove->setStyleSheet(
        "QPushButton { background-color: #7f1d1d; color: #fecaca; border-radius: 4px; border: none; }"
        "QPushButton:hover { background-color: #991b1b; }"
        );
    connect(btnRemove, &QPushButton::clicked, this, [=](){
        m_currentImage = QPixmap(); // æ¸…ç©º
        m_currentPath.clear();
        updateUiState(); // å›åˆ°ç©ºçŠ¶æ€
    });

    previewLayout->addWidget(m_lblPreview);
    previewLayout->addWidget(btnRemove);

    // å°†ä¸¤ä¸ªé¡µé¢åŠ å…¥å †æ ˆ
    m_stackLayout->addWidget(m_pageEmpty);
    m_stackLayout->addWidget(m_pagePreview);

    // æŠŠå †æ ˆåŠ å…¥ä¸»å¸ƒå±€
    containerLayout->addLayout(m_stackLayout);
    mainLayout->addWidget(container);

    // åˆå§‹çŠ¶æ€
    updateUiState();
}

void ReferencePopup::popup(const QPoint& pos) {
    // æ°´å¹³å±…ä¸­ï¼Œå‚ç›´åœ¨æŒ‰é’®ä¸Šæ–¹
    int x = pos.x() - (this->width() / 2);
    int y = pos.y() - this->height() - 10;
    this->move(x, y);
    this->show();
    this->raise(); // ç¡®ä¿åœ¨æœ€ä¸Šå±‚
    this->setFocus(); // è·å–ç„¦ç‚¹ï¼Œç”¨äºå¤„ç†ç„¦ç‚¹å¤±å»äº‹ä»¶
}

void ReferencePopup::hide() {
    QWidget::hide();
    // æ¸…é™¤ç„¦ç‚¹ï¼Œé¿å…å¹²æ‰°å…¶ä»–çª—å£
    this->clearFocus();
}

// ---------------------------------------------------------
// æ‹–æ‹½æ ¸å¿ƒé€»è¾‘
// ---------------------------------------------------------

void ReferencePopup::dragEnterEvent(QDragEnterEvent *event) {
    // 1. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
    if (event->mimeData()->hasUrls()) {
        QList<QUrl> urls = event->mimeData()->urls();
        if (urls.isEmpty()) return;

        // 2. æ£€æŸ¥åç¼€åæ˜¯å¦æ˜¯å›¾ç‰‡
        QString filePath = urls.first().toLocalFile();
        QFileInfo info(filePath);
        QString suffix = info.suffix().toLower();

        if (suffix == "jpg" || suffix == "jpeg" || suffix == "png" || suffix == "bmp" || suffix == "webp") {
            // æ˜¯å›¾ç‰‡ï¼Œå…è®¸æ‹–å…¥
            event->acceptProposedAction();
        }
    }
}

void ReferencePopup::dropEvent(QDropEvent *event) {
    const QMimeData* mime = event->mimeData();
    if (mime->hasUrls()) {
        QString filePath = mime->urls().first().toLocalFile();
        loadImage(filePath);
        event->acceptProposedAction();
    }
}

// ---------------------------------------------------------
// å›¾ç‰‡åŠ è½½ä¸æ¸²æŸ“
// ---------------------------------------------------------

void ReferencePopup::loadImage(const QString& path) {
    QPixmap img(path);
    if (img.isNull()) return;

    m_currentPath = path;
    m_currentImage = img;

    // ä¸ºäº†ç¾è§‚ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ® Label çš„å¤§å°å¯¹å›¾ç‰‡è¿›è¡Œç¼©æ”¾ï¼ˆä¿æŒæ¯”ä¾‹ï¼‰
    // æ³¨æ„ï¼šè¿™é‡Œç®€å•å¤„ç†ï¼Œå®é™…æ¸²æŸ“å¯èƒ½éœ€è¦ resizeEvent é…åˆ
    QSize targetSize = m_lblPreview->size();
    if (targetSize.isEmpty()) targetSize = QSize(280, 150); // å…œåº•å°ºå¯¸

    // ç¼©æ”¾å›¾ç‰‡
    QPixmap scaled = img.scaled(targetSize, Qt::KeepAspectRatio, Qt::SmoothTransformation);
    m_lblPreview->setPixmap(scaled);

    updateUiState();
}

void ReferencePopup::updateUiState() {
    if (m_currentImage.isNull()) {
        m_stackLayout->setCurrentWidget(m_pageEmpty);
    } else {
        m_stackLayout->setCurrentWidget(m_pagePreview);

        // å¦‚æœæ˜¯åœ¨é¢„è§ˆé¡µï¼Œè¿™é‡Œä¹Ÿå¯ä»¥å†æ¬¡è§¦å‘ä¸€ä¸‹ç¼©æ”¾ï¼Œé˜²æ­¢ label å¤§å°æœªæ›´æ–°
        if (!m_currentImage.isNull()) {
            QSize s = QSize(280, 150);
            m_lblPreview->setPixmap(m_currentImage.scaled(s, Qt::KeepAspectRatio, Qt::SmoothTransformation));
        }
    }
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\ReferencePopup.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\ReferencePopup.h ---

/**
 * @file ReferencePopup.h
 * @brief å‚è€ƒå›¾ä¸Šä¼ å¼¹çª—ç»„ä»¶å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†ReferencePopupç±»ï¼Œä½œä¸ºå‚è€ƒå›¾ä¸Šä¼ çš„æµ®åŠ¨çª—å£ã€‚
 * æ”¯æŒæ‹–æ‹½ä¸Šä¼ å›¾ç‰‡ã€å›¾ç‰‡é¢„è§ˆå’ŒçŠ¶æ€ç®¡ç†åŠŸèƒ½ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once
#include <QWidget>
#include <QPixmap>

class QLabel;
class QStackedLayout;

/**
 * @brief å‚è€ƒå›¾ä¸Šä¼ å¼¹çª—ç±»
 * 
 * ç»§æ‰¿è‡ªQWidgetï¼Œæä¾›å‚è€ƒå›¾ä¸Šä¼ åŠŸèƒ½ï¼Œæ”¯æŒæ‹–æ‹½æ“ä½œã€‚
 * åŒ…å«å›¾ç‰‡é¢„è§ˆã€çŠ¶æ€åˆ‡æ¢å’Œæ•°æ®ç®¡ç†åŠŸèƒ½ã€‚
 */
class ReferencePopup : public QWidget {
    Q_OBJECT

public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param parent çˆ¶çª—å£æŒ‡é’ˆ
     */
    explicit ReferencePopup(QWidget *parent = nullptr);

    /**
     * @brief æ˜¾ç¤ºå¼¹çª—
     * @param pos å¼¹çª—æ˜¾ç¤ºä½ç½®
     */
    void popup(const QPoint& pos);
    
    /**
     * @brief éšè—å¼¹çª—
     */
    void hide();

    /**
     * @brief è·å–å½“å‰å›¾ç‰‡
     * @return QPixmap å½“å‰å›¾ç‰‡
     */
    QPixmap currentImage() const { return m_currentImage; }
    
    /**
     * @brief è·å–å›¾ç‰‡è·¯å¾„
     * @return QString å›¾ç‰‡æ–‡ä»¶è·¯å¾„
     */
    QString currentPath() const { return m_currentPath; }
    
    /**
     * @brief æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡
     * @return bool æ˜¯å¦æœ‰å›¾ç‰‡
     */
    bool hasImage() const { return !m_currentImage.isNull(); }

protected:
    /**
     * @brief æ‹–æ‹½è¿›å…¥äº‹ä»¶å¤„ç†
     * @param event æ‹–æ‹½è¿›å…¥äº‹ä»¶
     */
    void dragEnterEvent(QDragEnterEvent *event) override;
    
    /**
     * @brief æ‹–æ‹½é‡Šæ”¾äº‹ä»¶å¤„ç†
     * @param event æ‹–æ‹½é‡Šæ”¾äº‹ä»¶
     */
    void dropEvent(QDropEvent *event) override;

    // ç„¦ç‚¹å¤±å»æ—¶éšè—ï¼ˆæ¨¡æ‹Ÿ Popup è¡Œä¸ºï¼‰
    // void focusOutEvent(QFocusEvent *event) override;

private:
    /**
     * @brief åˆå§‹åŒ–UIå¸ƒå±€
     */
    void setupUi();
    
    /**
     * @brief åŠ è½½å›¾ç‰‡å¤„ç†é€»è¾‘
     * @param path å›¾ç‰‡æ–‡ä»¶è·¯å¾„
     */
    void loadImage(const QString& path);
    
    /**
     * @brief åˆ‡æ¢UIçŠ¶æ€
     */
    void updateUiState();

private:
    // æ•°æ®
    QPixmap m_currentImage; ///< å½“å‰å›¾ç‰‡æ•°æ®
    QString m_currentPath; ///< å½“å‰å›¾ç‰‡è·¯å¾„

    // UI ç»„ä»¶
    QStackedLayout* m_stackLayout; ///< å †å å¸ƒå±€ï¼Œç”¨äºç•Œé¢åˆ‡æ¢
    QWidget* m_pageEmpty; ///< ç©ºçŠ¶æ€é¡µé¢
    QWidget* m_pagePreview; ///< é¢„è§ˆçŠ¶æ€é¡µé¢

    QLabel* m_lblPreview; ///< å›¾ç‰‡é¢„è§ˆæ ‡ç­¾
};


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\ReferencePopup.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\SessionItem.cpp ---

#include "SessionItem.h"
#include <QApplication>
#include <QClipboard>
#include <QInputDialog>
#include <QMessageBox>
#include <QFontMetrics>
#include <QResizeEvent>

SessionItem::SessionItem(int id, const QString& title, QWidget *parent)
    : QWidget(parent), m_id(id), m_fullTitle(title)
{
    this->setAttribute(Qt::WA_StyledBackground, true);
    this->setFixedHeight(50);
    // é»˜è®¤é€æ˜
    this->setStyleSheet("SessionItem { background-color: transparent; border-radius: 6px; border: none; }");
    setupUi();
}

void SessionItem::setupUi()
{
    QHBoxLayout* layout = new QHBoxLayout(this);
    layout->setContentsMargins(10, 0, 5, 0);
    layout->setSpacing(0);

    // 1. æ ‡é¢˜
    m_lblTitle = new QLabel(this);
    m_lblTitle->setStyleSheet("color: #ECECF1; font-size: 13px; background: transparent;border: none;");
    m_lblTitle->setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Preferred);
    m_lblTitle->setAttribute(Qt::WA_TransparentForMouseEvents, true);

    // 2. èœå•æŒ‰é’®
    m_btnOption = new QToolButton(this);
    m_btnOption->setText("Â·Â·Â·");
    m_btnOption->setFixedSize(30, 30);
    m_btnOption->setCursor(Qt::PointingHandCursor);

    // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šåŠ ä¸Š border: none; æ¶ˆé™¤é‚£ä¸ªç°çº¿
    // é»˜è®¤çŠ¶æ€ï¼šå®Œå…¨é€æ˜ï¼Œè¿è¾¹æ¡†éƒ½ä¸è¦
    m_btnOption->setStyleSheet(
        "QToolButton { "
        "    border: none; "             // <--- è¿™ä¸€è¡Œå»æ‰ç°çº¿
        "    background: transparent; "  // <--- èƒŒæ™¯é€æ˜
        "    color: transparent; "       // <--- æ–‡å­—é€æ˜(çœ‹èµ·æ¥åƒéšè—äº†)
        "}"
        );

    connect(m_btnOption, &QToolButton::clicked, this, &SessionItem::showMenu);

    layout->addWidget(m_lblTitle);
    layout->addWidget(m_btnOption);

    updateTitleText();
}

void SessionItem::enterEvent(QEnterEvent *event)
{
    if (!m_isSelected) {
        this->setStyleSheet("SessionItem { background-color: #2A2B32; border-radius: 6px; }");
    }

    // æ‚¬æµ®æ—¶ï¼šæ–‡å­—å˜ç™½ï¼ŒèƒŒæ™¯å˜æ·±ç°
    // åŒæ ·è®°å¾—å¸¦ä¸Š border: noneï¼Œå¦åˆ™æ‚¬æµ®æ—¶çº¿åˆå‡ºæ¥äº†
    m_btnOption->setStyleSheet(
        "QToolButton { "
        "    color: #ECECF1; "
        "    background-color: #40414F; "
        "    border-radius: 4px; "
        "    border: none; "          // <--- ä¿æŒæ— è¾¹æ¡†
        "    font-weight: bold; "
        "}"
        "QToolButton:hover { color: white; background-color: #50515F; }" // æŒ‰é’®è‡ªå·±çš„hoveræ•ˆæœ
        );

    QWidget::enterEvent(event);
}

void SessionItem::leaveEvent(QEvent *event)
{
    if (!m_isSelected) {
        this->setStyleSheet("SessionItem { background-color: transparent; border-radius: 6px; border: none; }");
    }

    // ç¦»å¼€æ—¶ï¼šå˜å›å®Œå…¨é€æ˜ï¼ˆå ä½ä½†ä¸æ˜¾ç¤ºï¼‰
    // ä¾ç„¶è¦å¸¦ä¸Š border: none
    m_btnOption->setStyleSheet(
        "QToolButton { "
        "    border: none; "
        "    background: transparent; "
        "    color: transparent; "
        "}"
        );

    QWidget::leaveEvent(event);
}

void SessionItem::mousePressEvent(QMouseEvent *event)
{
    if (event->button() == Qt::LeftButton) {
        // å‘é€ this æŒ‡é’ˆï¼Œæ–¹ä¾¿ SessionList ç›´æ¥æ“ä½œ
        emit itemClicked(this);
    }
    QWidget::mousePressEvent(event);
}

void SessionItem::setSelected(bool selected)
{
    m_isSelected = selected;
    if (selected) {
        // é€‰ä¸­æ€
        this->setStyleSheet("SessionItem { background-color: #343541; border-radius: 6px; border: 1px solid #565869; }");
    } else {
        // éé€‰ä¸­æ€
        this->setStyleSheet("SessionItem { background-color: transparent; border-radius: 6px; border: none; }");
    }
}

void SessionItem::setTitle(const QString& newTitle)
{
    m_fullTitle = newTitle;
    updateTitleText();
}

void SessionItem::resizeEvent(QResizeEvent *event)
{
    updateTitleText();
    QWidget::resizeEvent(event);
}

void SessionItem::updateTitleText()
{
    // è®¡ç®—å®½åº¦ï¼šæ€»å®½ - æŒ‰é’®å®½ - å·¦å³è¾¹è·ä½™é‡
    int availableWidth = this->width() - m_btnOption->width() - 20;
    if (availableWidth <= 0) return;

    QFontMetrics metrics(m_lblTitle->font());
    QString elidedText = metrics.elidedText(m_fullTitle, Qt::ElideRight, availableWidth);
    m_lblTitle->setText(elidedText);

    // è¿™æ ·æ— è®ºé¼ æ ‡ä»€ä¹ˆæ—¶å€™ç§»ä¸Šæ¥ï¼ŒTooltip æ—©å°±å‡†å¤‡å¥½äº†
    if (elidedText != m_fullTitle) {
        this->setToolTip(m_fullTitle);
    } else {
        this->setToolTip(""); // æ²¡æˆªæ–­å°±æ¸…ç©ºï¼Œé˜²æ­¢æ˜¾ç¤ºå¤šä½™çš„æç¤º
    }
}

// å¼¹å‡ºå³é”®èœå•
void SessionItem::showMenu()
{
    QMenu menu(this);
    // è®¾ç½® QMenu çš„æ ·å¼ï¼Œè®©å®ƒåŒ¹é…é»‘æš—ä¸»é¢˜
    menu.setStyleSheet("QMenu { background-color: #2D2D2D; color: white; border: 1px solid #555; border-radius: 8px }"
                       "QMenu::item:selected { background-color: #40414F; }");

    // 1. æ·»åŠ é‡å‘½ååŠ¨ä½œ
    QAction* actRename = menu.addAction("âœ é‡å‘½å");
    connect(actRename, &QAction::triggered, this, [=](){
        bool ok;
        // å¼¹å‡ºè¾“å…¥æ¡†
        QString text = QInputDialog::getText(this, "é‡å‘½åä¼šè¯",
                                             "è¯·è¾“å…¥æ–°åç§°:", QLineEdit::Normal,
                                             m_fullTitle, &ok);
        // å¦‚æœç”¨æˆ·ç‚¹äº†OKä¸”è¾“å…¥ä¸ä¸ºç©º
        if (ok && !text.isEmpty()) {
            setTitle(text); // æ›´æ–° UI
            emit itemRenamed(m_id, text); // é€šçŸ¥å¤–éƒ¨/æ•°æ®åº“
        }
    });

    // 2. æ·»åŠ å¤åˆ¶åŠ¨ä½œ
    QAction* actCopy = menu.addAction("â å¤åˆ¶æ ‡é¢˜");
    connect(actCopy, &QAction::triggered, this, [=](){
        // è·å–ç³»ç»Ÿå‰ªè´´æ¿å¹¶å†™å…¥
        QClipboard *clipboard = QApplication::clipboard();
        clipboard->setText(m_fullTitle);
    });

    // åŠ ä¸€æ¡æ¨ªçº¿åˆ†éš”
    menu.addSeparator();

    // 3. æ·»åŠ åˆ é™¤åŠ¨ä½œ
    QAction* actDelete = menu.addAction("ğŸ—‘ åˆ é™¤ä¼šè¯");
    connect(actDelete, &QAction::triggered, this, [=](){
        // åˆ é™¤æ˜¯å±é™©æ“ä½œï¼Œå¿…é¡»äºŒæ¬¡ç¡®è®¤
        QMessageBox::StandardButton reply;
        reply = QMessageBox::question(this, "ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",
                                      QMessageBox::Yes|QMessageBox::No);
        if (reply == QMessageBox::Yes) {
            emit itemDeleted(m_id); // å‘é€åˆ é™¤ä¿¡å·
        }
    });

    // åœ¨æŒ‰é’®çš„æ­£ä¸‹æ–¹å¼¹å‡ºèœå•
    // mapToGlobal: æŠŠæŒ‰é’®ç›¸å¯¹äºçª—å£çš„åæ ‡(0, height)è½¬æ¢æˆå±å¹•ç»å¯¹åæ ‡
    menu.exec(m_btnOption->mapToGlobal(QPoint(0, m_btnOption->height())));
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\SessionItem.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\SessionItem.h ---

/**
 * @file SessionItem.h
 * @brief ä¼šè¯é¡¹ç»„ä»¶å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†SessionItemç±»ï¼Œä½œä¸ºä¼šè¯åˆ—è¡¨ä¸­çš„å•ä¸ªä¼šè¯é¡¹ã€‚
 * åŒ…å«ä¼šè¯æ ‡é¢˜æ˜¾ç¤ºã€é€‰ä¸­çŠ¶æ€ã€å³é”®èœå•å’Œäº‹ä»¶å¤„ç†åŠŸèƒ½ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once

#include <QWidget>
#include <QLabel>
#include <QToolButton>
#include <QHBoxLayout>
#include <QMenu>

class QLabel;
class QToolButton;

/**
 * @brief ä¼šè¯é¡¹ç±»
 * 
 * ç»§æ‰¿è‡ªQWidgetï¼Œè¡¨ç¤ºä¼šè¯åˆ—è¡¨ä¸­çš„å•ä¸ªä¼šè¯é¡¹ç›®ã€‚
 * æ”¯æŒé€‰ä¸­çŠ¶æ€ã€æ ‡é¢˜ç¼–è¾‘ã€åˆ é™¤å’Œé‡å‘½åæ“ä½œã€‚
 */
class SessionItem : public QWidget
{
    Q_OBJECT
public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param id ä¼šè¯ID
     * @param title ä¼šè¯æ ‡é¢˜
     * @param parent çˆ¶çª—å£æŒ‡é’ˆ
     */
    explicit SessionItem(int id, const QString& title, QWidget *parent = nullptr);

    /**
     * @brief è·å–ä¼šè¯ID
     * @return int ä¼šè¯ID
     */
    int id() const { return m_id; }

    /**
     * @brief è®¾ç½®é€‰ä¸­çŠ¶æ€
     * @param selected æ˜¯å¦é€‰ä¸­
     */
    void setSelected(bool selected);

    /**
     * @brief æ›´æ–°æ ‡é¢˜
     * @param newTitle æ–°æ ‡é¢˜
     */
    void setTitle(const QString& newTitle);



signals:
    /**
     * @brief é¡¹ç‚¹å‡»ä¿¡å·
     * @param item è¢«ç‚¹å‡»çš„ä¼šè¯é¡¹æŒ‡é’ˆ
     */
    void itemClicked(SessionItem* item);
    
    /**
     * @brief é¡¹åˆ é™¤ä¿¡å·
     * @param id è¢«åˆ é™¤çš„ä¼šè¯ID
     */
    void itemDeleted(int id);
    
    /**
     * @brief é¡¹é‡å‘½åä¿¡å·
     * @param id è¢«é‡å‘½åçš„ä¼šè¯ID
     * @param newName æ–°ä¼šè¯åç§°
     */
    void itemRenamed(int id, const QString& newName);

protected:
    /**
     * @brief é¼ æ ‡è¿›å…¥äº‹ä»¶å¤„ç†
     * @param event é¼ æ ‡è¿›å…¥äº‹ä»¶
     */
    void enterEvent(QEnterEvent *event) override;
    
    /**
     * @brief é¼ æ ‡ç¦»å¼€äº‹ä»¶å¤„ç†
     * @param event é¼ æ ‡ç¦»å¼€äº‹ä»¶
     */
    void leaveEvent(QEvent *event) override;
    
    /**
     * @brief é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶å¤„ç†
     * @param event é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
     */
    void mousePressEvent(QMouseEvent *event) override;
    
    /**
     * @brief çª—å£å¤§å°æ”¹å˜äº‹ä»¶å¤„ç†
     * @param event å¤§å°æ”¹å˜äº‹ä»¶
     */
    void resizeEvent(QResizeEvent *event) override;

private:
    /**
     * @brief åˆå§‹åŒ–UIå¸ƒå±€
     */
    void setupUi();
    
    /**
     * @brief æ›´æ–°æ ‡é¢˜æ–‡æœ¬æ˜¾ç¤º
     */
    void updateTitleText();
    
    /**
     * @brief æ˜¾ç¤ºå³é”®èœå•
     */
    void showMenu();

private:
    int m_id; ///< ä¼šè¯ID
    QString m_fullTitle; ///< å®Œæ•´æ ‡é¢˜
    bool m_isSelected = false; ///< æ˜¯å¦é€‰ä¸­çŠ¶æ€

    QLabel *m_lblTitle; ///< æ ‡é¢˜æ ‡ç­¾
    QToolButton *m_btnOption; ///< é€‰é¡¹æŒ‰é’®
};


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\SessionItem.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\SessionList.cpp ---

#include "SessionList.h"
#include "SessionItem.h"
#include <QPushButton>
#include <QLabel>
#include <QScrollArea>
#include <QScrollBar> // ç”¨äºç¾åŒ–æ»šåŠ¨æ¡

SessionList::SessionList(QWidget *parent)
    : QWidget(parent)
    , m_currentSessionItem(nullptr)
{
    setupUi();
}

void SessionList::setupUi()
{
    // 1. è®¾ç½®ä¾§è¾¹æ åŸºæœ¬å±æ€§
    this->setFixedWidth(260);
    this->setStyleSheet("background-color: #202123; border-right: 1px solid #4D4D4F;");

    // 2. æœ€å¤–å±‚å¸ƒå±€ (å‚ç›´)
    QVBoxLayout* rootLayout = new QVBoxLayout(this);
    rootLayout->setContentsMargins(0, 20, 0, 0); // é¡¶éƒ¨ç•™ç™½ï¼Œå·¦å³ä¸‹è´´è¾¹
    rootLayout->setSpacing(10);

    // 3. å›ºå®šåœ¨é¡¶éƒ¨çš„â€œæ–°å»ºä¼šè¯â€æŒ‰é’®
    // ä¸ºäº†è®©æŒ‰é’®å·¦å³æœ‰é—´è·ï¼Œæˆ‘ä»¬ç»™å®ƒåŒ…ä¸€å±‚å®¹å™¨ï¼Œæˆ–è€…ç›´æ¥è®¾ç½® margin
    QWidget* topContainer = new QWidget(this);
    QVBoxLayout* topLayout = new QVBoxLayout(topContainer);
    topLayout->setContentsMargins(10, 0, 10, 0); // æŒ‰é’®å·¦å³ç•™ç™½

    m_btnNew = new QPushButton("+ æ–°å»ºä¼šè¯", this);
    m_btnNew->setFixedHeight(45);
    m_btnNew->setCursor(Qt::PointingHandCursor);
    m_btnNew->setStyleSheet(
        "QPushButton { "
        "   background-color: transparent; "
        "   border: 1px solid #565869; "
        "   border-radius: 5px; "
        "   color: white; "
        "   text-align: left; "
        "   padding-left: 15px;"
        "}"
        "QPushButton:hover { background-color: #2A2B32; }"
        );
    connect(m_btnNew, &QPushButton::clicked, this, &SessionList::createNewSessionRequest);

    topLayout->addWidget(m_btnNew);
    rootLayout->addWidget(topContainer);

    // 4. åˆ›å»ºæ»šåŠ¨åŒºåŸŸ (QScrollArea)
    QScrollArea* scrollArea = new QScrollArea(this);
    scrollArea->setWidgetResizable(true); // å…³é”®ï¼šè®©å†…éƒ¨å®¹å™¨å®½åº¦è‡ªé€‚åº” ScrollArea
    scrollArea->setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOff); // åªè¦å‚ç›´æ»šåŠ¨ï¼Œä¸è¦æ°´å¹³
    scrollArea->setFrameShape(QFrame::NoFrame); // å»æ‰ ScrollArea è‡ªå¸¦çš„è¾¹æ¡†

    // ç¾åŒ–æ»šåŠ¨æ¡ (QSS) - è¿™ä¸€å¤§æ®µæ˜¯ä¸ºäº†è®©æ»šåŠ¨æ¡å˜ç»†ã€å˜æ·±è‰²
    scrollArea->setStyleSheet(
        "QScrollArea { "
        "   background: transparent; "
        "   border: none; "
        "}"

        // --- æ»šåŠ¨æ¡è½¨é“ (æ§½) ---
        "QScrollBar:vertical { "
        "    border: none; "
        "    background: #111111; "  // æ”¹æˆæ¥è¿‘é»‘è‰²ï¼Œå’Œé¢æ¿çš„æ·±ç°åŒºåˆ†å¼€
        "    width: 14px; "          // åŠ å®½åˆ° 14pxï¼Œéå¸¸æ˜æ˜¾
        "    margin: 0px; "
        "}"

        // --- æ»šåŠ¨æ»‘å— (é‚£ä¸ªæ‹–åŠ¨çš„å—) ---
        "QScrollBar::handle:vertical { "
        "    background: #666666; "  // æ˜æ˜¾çš„ç°è‰²
        "    min-height: 30px; "     // æœ€å°é«˜åº¦è®¾å¤§ä¸€ç‚¹
        "    border-radius: 7px; "   // åœ†è§’
        "    margin: 2px; "          // ç•™è¾¹è·ï¼Œè®©æ»‘å—æ‚¬æµ®åœ¨è½¨é“é‡Œ
        "}"

        // --- é¼ æ ‡æ‚¬åœå˜äº® ---
        "QScrollBar::handle:vertical:hover { "
        "    background: #999999; "  // æ‚¬åœå˜ç™½ä¸€ç‚¹
        "}"

        // --- éšè—ä¸Šä¸‹ç®­å¤´ (å¦‚æœä¸éšè—ï¼Œå¯èƒ½ä¼šå æ®ç©ºé—´æ˜¾ç¤ºä¸å‡ºæ¥) ---
        "QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical { "
        "    height: 0px; "
        "}"
        "QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical { "
        "    background: none; "
        "}"
        );

    // 5. åˆ›å»ºæ»šåŠ¨åŒºåŸŸå†…éƒ¨çš„â€œå®¹å™¨ç”»å¸ƒâ€
    QWidget* scrollContent = new QWidget();
    scrollContent->setStyleSheet("background: transparent;"); // å¿…é¡»é€æ˜ï¼Œå¦åˆ™ä¼šæŒ¡ä½èƒŒæ™¯

    // 6. å†…éƒ¨å¸ƒå±€ (ç”¨æ¥æ”¾ Label å’Œ SessionItem)
    m_scrollLayout = new QVBoxLayout(scrollContent);
    m_scrollLayout->setContentsMargins(10, 10, 10, 10); // å†…å®¹çš„è¾¹è·
    m_scrollLayout->setSpacing(5);

    // æ·»åŠ æ ‡é¢˜
    QLabel* labelTitle = new QLabel("æœ€è¿‘å†å²", scrollContent);
    labelTitle->setStyleSheet("color: #8E8EA0; font-size: 12px; margin-bottom: 5px; border: none;");
    m_scrollLayout->addWidget(labelTitle);

    // 7. ç»„è£…ï¼šæŠŠå®¹å™¨å¡è¿› ScrollAreaï¼ŒæŠŠ ScrollArea å¡è¿›æœ€å¤–å±‚å¸ƒå±€
    scrollArea->setWidget(scrollContent);
    rootLayout->addWidget(scrollArea);

    // 8. æ·»åŠ å¼¹ç°§ (Stretch)
    // æŠŠå®ƒæ”¾åœ¨å†…éƒ¨å¸ƒå±€çš„æœ€åï¼ŒæŠŠ Item å¾€ä¸Šé¡¶
    m_scrollLayout->addStretch();
}

void SessionList::addSession(int id, const QString& title)
{
    SessionItem* item = new SessionItem(id, title, this);

    // --- ä¿¡å·è¿æ¥éƒ¨åˆ†ä¿æŒä¸å˜ ---
    connect(item, &SessionItem::itemClicked, this, [=](SessionItem* clickedItem){
        handleItemSelection(clickedItem);
        emit sessionSwitchRequest(clickedItem->id());
    });

    connect(item, &SessionItem::itemRenamed, this, [=](int itemId, const QString& newName){
        emit sessionRenameRequest(itemId, newName);
    });

    connect(item, &SessionItem::itemDeleted, this, [=](int deletedId){
        if (m_currentSessionItem == item) {
            m_currentSessionItem = nullptr;
        }
        emit sessionDeleteRequest(deletedId);

        // ã€æ³¨æ„ã€‘è¿™é‡Œè¦ä» m_scrollLayout ç§»é™¤ï¼Œè€Œä¸æ˜¯ m_mainLayout
        m_scrollLayout->removeWidget(item);
        item->deleteLater();
    });

    // ---------------------------------------------------------
    // æ’å…¥ UI
    // ---------------------------------------------------------

    // ã€æ–°å¢ã€‘åŠ å…¥ç®¡ç†åˆ—è¡¨
    m_items.append(item);

    // ã€æ³¨æ„ã€‘æ’å…¥åˆ° m_scrollLayoutï¼Œä¸”åœ¨å¼¹ç°§ä¹‹å‰
    m_scrollLayout->insertWidget(m_scrollLayout->count() - 1, item);

    if (m_currentSessionItem == nullptr) {
        handleItemSelection(item);
    }
}

// handleItemSelection ä¿æŒä¸å˜...
void SessionList::handleItemSelection(SessionItem* clickedItem)
{
    if (m_currentSessionItem == clickedItem) return;
    if (m_currentSessionItem) m_currentSessionItem->setSelected(false);
    if (clickedItem) clickedItem->setSelected(true);
    m_currentSessionItem = clickedItem;
}


void SessionList::clear()
{
    m_currentSessionItem = nullptr;

    for (auto* item : m_items) {
        m_scrollLayout->removeWidget(item);
        delete item;
    }
    m_items.clear();
}

void SessionList::loadSessions(const QVector<SessionData>& sessions)
{
    clear(); // å…ˆæ¸…ç©ºæ—§çš„

    for (const auto& s : sessions) {
        addSession(s.id, s.name);
    }
}

void SessionList::selectSession(int id)
{
    // éå†æ‰€æœ‰ Item æ‰¾åˆ°åŒ¹é…çš„ ID
    for (SessionItem* item : m_items) {
        if (item->id() == id) {
            handleItemSelection(item); // è°ƒç”¨å†…éƒ¨å‡½æ•°è®¾ç½®é«˜äº®æ ·å¼
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªæ”¹å˜æ ·å¼ï¼Œä¸å‘é€ä¿¡å·ï¼Œé¿å…æ­»å¾ªç¯
            // æ•°æ®çš„åŠ è½½ç”± MainWindow ä¸»åŠ¨è°ƒç”¨ loadSessionHistory
            return;
        }
    }
}

int SessionList::getFirstSessionId() const
{
    if (m_items.isEmpty()) return -1;
    // å› ä¸ºæ˜¯å‚ç›´å¸ƒå±€ï¼Œä¸” addSession æ˜¯ append åˆ°å¸ƒå±€æœ«å°¾
    // ä½†æ•°æ®æºé€šå¸¸æ˜¯å€’åºçš„ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰ï¼Œæ‰€ä»¥åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå°±æ˜¯æœ€æ–°çš„
    // è¿™é‡Œçš„ 0 ç´¢å¼•å¯¹åº” UI ä¸Šæœ€é¡¶éƒ¨çš„å…ƒç´ 
    return m_items.first()->id();
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\SessionList.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\SessionList.h ---

/**
 * @file SessionList.h
 * @brief ä¼šè¯åˆ—è¡¨ç»„ä»¶å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†SessionListç±»ï¼Œä½œä¸ºåº”ç”¨ç¨‹åºå·¦ä¾§çš„ä¼šè¯ç®¡ç†é¢æ¿ã€‚
 * åŒ…å«ä¼šè¯é¡¹çš„æ·»åŠ ã€é€‰æ‹©ã€åˆ é™¤ã€é‡å‘½åç­‰åŠŸèƒ½ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once

#include <QWidget>
#include <QVBoxLayout>
#include <QList>
#include <QScrollArea>
#include "../../Model/DataModels.h" // ã€æ–°å¢ã€‘å¼•å…¥æ•°æ®æ¨¡å‹

class SessionItem;
class QPushButton;

/**
 * @brief ä¼šè¯åˆ—è¡¨ç±»
 * 
 * ç»§æ‰¿è‡ªQWidgetï¼Œç®¡ç†å¤šä¸ªä¼šè¯é¡¹ï¼Œæä¾›ä¼šè¯çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ã€‚
 * æ”¯æŒä¼šè¯åˆ‡æ¢ã€åˆ é™¤ã€é‡å‘½åå’Œæ–°å»ºæ“ä½œã€‚
 */
class SessionList : public QWidget
{
    Q_OBJECT
public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param parent çˆ¶çª—å£æŒ‡é’ˆ
     */
    explicit SessionList(QWidget *parent = nullptr);
    
    /**
     * @brief æ·»åŠ æ–°ä¼šè¯
     * @param id ä¼šè¯ID
     * @param title ä¼šè¯æ ‡é¢˜
     */
    void addSession(int id, const QString& title);

    // ã€æ–°å¢ã€‘æ¸…ç©ºåˆ—è¡¨
    void clear();

    // ã€æ–°å¢ã€‘åŠ è½½ä¼šè¯åˆ—è¡¨æ•°æ®
    void loadSessions(const QVector<SessionData>& sessions);

    // ã€æ–°å¢ã€‘é€šè¿‡ ID é€‰ä¸­æŒ‡å®šä¼šè¯ï¼ˆç”¨äºåˆå§‹åŒ–æ—¶é«˜äº®ï¼‰
    void selectSession(int id);

    // ã€æ–°å¢ã€‘è·å–åˆ—è¡¨é‡Œçš„ç¬¬ä¸€ä¸ªä¼šè¯IDï¼ˆå¦‚æœæ²¡æœ‰åˆ™è¿”å› -1ï¼‰
    int getFirstSessionId() const;


signals:
    /**
     * @brief ä¼šè¯åˆ‡æ¢è¯·æ±‚ä¿¡å·
     * @param id ç›®æ ‡ä¼šè¯ID
     */
    void sessionSwitchRequest(int id);
    
    /**
     * @brief ä¼šè¯åˆ é™¤è¯·æ±‚ä¿¡å·
     * @param id ç›®æ ‡ä¼šè¯ID
     */
    void sessionDeleteRequest(int id);
    
    /**
     * @brief ä¼šè¯é‡å‘½åè¯·æ±‚ä¿¡å·
     * @param id ç›®æ ‡ä¼šè¯ID
     * @param newName æ–°ä¼šè¯åç§°
     */
    void sessionRenameRequest(int id, const QString& newName);
    
    /**
     * @brief æ–°å»ºä¼šè¯è¯·æ±‚ä¿¡å·
     */
    void createNewSessionRequest();


private:
    /**
     * @brief åˆå§‹åŒ–UIå¸ƒå±€
     */
    void setupUi();

    /**
     * @brief å¤„ç†ä¼šè¯é¡¹é€‰æ‹©äº‹ä»¶
     * @param clickedItem è¢«ç‚¹å‡»çš„ä¼šè¯é¡¹æŒ‡é’ˆ
     */
    void handleItemSelection(SessionItem* clickedItem);

private:
    QVBoxLayout* m_mainLayout; ///< ä¸»å¸ƒå±€
    QVBoxLayout* m_scrollLayout; ///< æ»šåŠ¨åŒºåŸŸå¸ƒå±€
    QPushButton* m_btnNew; ///< æ–°å»ºä¼šè¯æŒ‰é’®

    SessionItem* m_currentSessionItem = nullptr; ///< å½“å‰é€‰ä¸­çš„ä¼šè¯é¡¹æŒ‡é’ˆ

    QList<SessionItem*> m_items; // ã€æ–°å¢ã€‘ç®¡ç†æ‰€æœ‰ Item æŒ‡é’ˆ
};


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\SessionList.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\SettingsDialog.cpp ---

#include "SettingsDialog.h"
#include <QVBoxLayout>
#include <QDialogButtonBox>
#include <QLabel>
#include <QSettings> // å¿…é¡»å¼•ç”¨è¿™ä¸ª

SettingsDialog::SettingsDialog(QWidget *parent) : QDialog(parent) {
    setWindowTitle("æœåŠ¡å™¨è®¾ç½®");
    setFixedSize(400, 200); // ç¨å¾®æ”¹å¤§ä¸€ç‚¹

    // 1. è¯»å–ä¿å­˜çš„é…ç½® (å¦‚æœæ²¡æœ‰ä¿å­˜è¿‡ï¼Œé»˜è®¤å°±æ˜¯æœ¬åœ° 8000)
    QSettings settings("CloudArt", "AppConfig");
    QString savedUrl = settings.value("Server/Url", "http://127.0.0.1:8000").toString();

    QVBoxLayout* mainLayout = new QVBoxLayout(this);

    // è¾“å…¥æ¡†
    QLabel* lbl = new QLabel("åœ°å€:", this);
    m_editUrl = new QLineEdit(savedUrl, this);
    m_editUrl->setPlaceholderText("ä¾‹å¦‚: http://frp-fly.top:12345");

    mainLayout->addWidget(lbl);
    mainLayout->addWidget(m_editUrl);

    // æç¤ºä¿¡æ¯
    QLabel* tip = new QLabel("å¤åˆ¶å®Œæ•´çš„ç©¿é€é“¾æ¥å¡«å…¥", this);
    tip->setStyleSheet("color: #666; font-size: 12px; margin-top: 5px;");
    tip->setWordWrap(true);
    mainLayout->addWidget(tip);

    mainLayout->addStretch();

    // æŒ‰é’®
    QDialogButtonBox* buttons = new QDialogButtonBox(QDialogButtonBox::Ok | QDialogButtonBox::Cancel, this);
    connect(buttons, &QDialogButtonBox::accepted, this, [=](){
        // ã€å…³é”®ã€‘ç‚¹å‡»ç¡®å®šæ—¶ï¼Œä¿å­˜é…ç½®
        QSettings settings("CloudArt", "AppConfig");
        settings.setValue("Server/Url", m_editUrl->text().trimmed());
        accept();
    });
    connect(buttons, &QDialogButtonBox::rejected, this, &QDialog::reject);
    mainLayout->addWidget(buttons);
}

QString SettingsDialog::getUrl() const {
    return m_editUrl->text().trimmed();
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\SettingsDialog.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\SettingsDialog.h ---

#pragma once
#include <QDialog>
#include <QLineEdit>

class SettingsDialog : public QDialog {
    Q_OBJECT
public:
    explicit SettingsDialog(QWidget *parent = nullptr);

    // ã€ä¿®æ”¹ã€‘åªç•™ä¸€ä¸ªè·å– URL çš„å‡½æ•°
    QString getUrl() const;

private:
    // ã€ä¿®æ”¹ã€‘åªç•™ä¸€ä¸ªè¾“å…¥æ¡†æŒ‡é’ˆ
    QLineEdit* m_editUrl;
};


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\SettingsDialog.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\SidebarControl.cpp ---

#include "SidebarControl.h"

#include <QVBoxLayout>
#include <QToolButton>
#include <QIcon>

SidebarControl::SidebarControl(QWidget* parent)
    : QWidget(parent)
    , m_layout(nullptr)
    , m_toggleBtn(nullptr)
    , m_historyBtn(nullptr)
    , m_settingsBtn(nullptr)
{
    setAttribute(Qt::WA_TranslucentBackground);
    
    m_layout = new QVBoxLayout(this);
    m_layout->setSpacing(20);
    m_layout->setContentsMargins(0, 10, 0, 10);
    
    m_toggleBtn = createBtn(":/images/HideConversation.png", "å¯¹è¯è®°å½•");
    m_historyBtn = createBtn(":/images/historypic.png", "ç”Ÿæˆè®°å½•");
    
    m_layout->addWidget(m_toggleBtn);
    m_layout->addWidget(m_historyBtn);
    
    // ã€æ–°å¢ã€‘æ·»åŠ ä¸€ä¸ªå¼¹ç°§ï¼ŒæŠŠè®¾ç½®æŒ‰é’®é¡¶åˆ°æœ€åº•éƒ¨
    m_layout->addStretch();

    // ã€æ–°å¢ã€‘åˆ›å»ºè®¾ç½®æŒ‰é’®
    // æ³¨æ„ï¼šè¿™é‡Œæš‚æ—¶å¤ç”¨ 'HideConversation.png' å›¾æ ‡ï¼Œä½ å¯ä»¥ä»¥åæ¢æˆé½¿è½®å›¾æ ‡
    m_settingsBtn = createBtn(":/images/setting.png", "æœåŠ¡å™¨è®¾ç½®");

    // å¦‚æœæƒ³åŒºåˆ†ï¼Œå¯ä»¥æš‚æ—¶ç»™å®ƒå˜ä¸ªè‰²æˆ–è€…æ ·å¼ï¼Œè¿™é‡Œå…ˆä¿æŒä¸€è‡´
    m_layout->addWidget(m_settingsBtn);

    setFixedWidth(40);
    adjustSize();
}

SidebarControl::~SidebarControl()
{
}

QToolButton* SidebarControl::toggleBtn() const
{
    return m_toggleBtn;
}

QToolButton* SidebarControl::historyBtn() const
{
    return m_historyBtn;
}

void SidebarControl::updateToggleState(bool isExpanded)
{
    if (m_toggleBtn) {
        m_toggleBtn->setToolTip(isExpanded ? "å¯¹è¯è®°å½•" : "å¯¹è¯è®°å½•");
    }
}

QToolButton* SidebarControl::createBtn(const QString& iconPath, const QString& tooltip)
{
    QToolButton* btn = new QToolButton(this);
    btn->setIcon(QIcon(iconPath));
    btn->setIconSize(QSize(24, 24));
    btn->setFixedSize(32, 32);
    btn->setCursor(Qt::PointingHandCursor);
    btn->setStyleSheet(
        "QToolButton { "
        "  background-color: #40414F; "
        "  border: none; "
        "  border-radius: 4px; "
        "}"
        "QToolButton:hover { "
        "  background-color: #50515F; "
        "}"
    );
    btn->setToolTip(tooltip);
    return btn;
}

QToolButton* SidebarControl::settingsBtn() const
{
    return m_settingsBtn;
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\SidebarControl.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\SidebarControl.h ---

#pragma once

#include <QWidget>
#include <QToolButton>

class QVBoxLayout;

class SidebarControl : public QWidget
{
    Q_OBJECT

public:
    explicit SidebarControl(QWidget* parent = nullptr);
    ~SidebarControl();

    QToolButton* toggleBtn() const;
    QToolButton* historyBtn() const;
    void updateToggleState(bool isExpanded);
    // ã€æ–°å¢ã€‘è·å–è®¾ç½®æŒ‰é’®çš„æŒ‡é’ˆ
    QToolButton* settingsBtn() const;

private:
    QToolButton* createBtn(const QString& iconPath, const QString& tooltip);

    QVBoxLayout* m_layout;
    QToolButton* m_toggleBtn;
    QToolButton* m_historyBtn;
    // ã€æ–°å¢ã€‘è®¾ç½®æŒ‰é’®å˜é‡
    QToolButton* m_settingsBtn;
};


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\SidebarControl.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\WorkflowCard.cpp ---

/**
 * @file WorkflowCard.cpp
 * @brief å·¥ä½œæµå¡ç‰‡ç»„ä»¶å®ç°æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®ç°äº†WorkflowCardç±»ï¼Œç”¨äºæ˜¾ç¤ºå·¥ä½œæµå¡ç‰‡ï¼Œæ”¯æŒé™æ€å›¾ç‰‡å’ŒGIFåŠ¨ç”»èƒŒæ™¯ï¼Œ
 * åŒ…å«é¼ æ ‡æ‚¬åœæ•ˆæœã€ç¼©æ”¾åŠ¨ç”»å’Œæ–‡å­—ä¿¡æ¯å±•ç¤ºåŠŸèƒ½ã€‚
 * 
 * @author ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
 * @version 1.0
 * @date 2024
 */

#include "WorkflowCard.h"
#include <QVBoxLayout>
#include <QHBoxLayout>
#include <QPainter>
#include <QEnterEvent>
#include <QMouseEvent>
#include <QDebug>
#include <QLinearGradient>
#include <QPixmap>
#include <QFile>
#include <QPainterPath>
#include <QMovie>

/**
 * @brief WorkflowCardæ„é€ å‡½æ•°
 * @param info å·¥ä½œæµä¿¡æ¯ç»“æ„ä½“ï¼ŒåŒ…å«åç§°ã€æè¿°ã€å›¾ç‰‡è·¯å¾„ç­‰
 * @param parent çˆ¶çª—å£æŒ‡é’ˆ
 * 
 * åˆå§‹åŒ–å·¥ä½œæµå¡ç‰‡ï¼Œè®¾ç½®UIå¸ƒå±€ã€åŠ¨ç”»æ•ˆæœå’Œäº‹ä»¶å¤„ç†ã€‚
 * æ”¯æŒGIFåŠ¨ç”»çš„å»¶è¿Ÿåˆå§‹åŒ–ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚
 */
WorkflowCard::WorkflowCard(const WorkflowInfo& info, QWidget* parent)
    : QWidget(parent)
    , m_info(info)
    , m_scale(1.0)
    , m_currentScale(1.0)
    , m_isHovering(false)
    , m_backgroundLabel(nullptr)
{
    setupUi();
    
    // è®¾ç½®ç¼©æ”¾åŠ¨ç”»
    m_scaleAnimation->setDuration(200);
    m_scaleAnimation->setEasingCurve(QEasingCurve::OutCubic);
    
    // åˆå§‹åŒ–GIFåŠ¨ç”» - å»¶è¿Ÿåˆå§‹åŒ–
    if (!m_info.gifPath.isEmpty()) {
        m_movie = nullptr; // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåœ¨enterEventä¸­åˆ›å»º
        qDebug() << "GIFè·¯å¾„å·²è®¾ç½®ï¼Œå°†å»¶è¿Ÿåˆå§‹åŒ–:" << m_info.gifPath;
    }
    
    // æ·»åŠ é˜´å½±æ•ˆæœ
    auto *shadowEffect = new QGraphicsDropShadowEffect(this);
    shadowEffect->setBlurRadius(15);
    shadowEffect->setColor(QColor(0, 0, 0, 80));
    shadowEffect->setOffset(0, 5);
    this->setGraphicsEffect(shadowEffect);
    
    // è®¾ç½®é¼ æ ‡è·Ÿè¸ª
    this->setMouseTracking(true);
}

/**
 * @brief è®¾ç½®UIç•Œé¢
 * 
 * åˆ›å»ºå¡ç‰‡çš„ä¸»è¦UIç»„ä»¶ï¼ŒåŒ…æ‹¬èƒŒæ™¯å›¾ç‰‡ã€æ–‡å­—å®¹å™¨ã€åç§°å’Œæè¿°æ ‡ç­¾ã€‚
 * è®¾ç½®16:9æ¯”ä¾‹çš„å¡ç‰‡å¤§å°ï¼Œå¹¶é…ç½®æ ·å¼è¡¨å’Œå¸ƒå±€ã€‚
 */
void WorkflowCard::setupUi()
{
    // è®¾ç½®16:9æ¯”ä¾‹çš„å¡ç‰‡å¤§å° (320x180)
    this->setFixedSize(320, 180);
    this->setStyleSheet(
        "WorkflowCard {"
        "    background-color: #252525;"
        "    border: 1px solid #444444;"
        "    border-radius: 12px;"
        "}"
        "WorkflowCard:hover {"
        "    border: 1px solid #666666;"
        "}"
    );
    
    // ä¸»å¸ƒå±€
    QVBoxLayout *mainLayout = new QVBoxLayout(this);
    mainLayout->setContentsMargins(0, 0, 0, 0);
    mainLayout->setSpacing(0);
    
    // åˆ›å»ºèƒŒæ™¯å›¾ç‰‡æ ‡ç­¾
    m_backgroundLabel = new QLabel(this);
    m_backgroundLabel->setFixedSize(320, 180);
    m_backgroundLabel->setScaledContents(true);
    m_backgroundLabel->lower(); // ç¡®ä¿èƒŒæ™¯åœ¨æœ€åº•å±‚
    
    // æ–‡å­—å®¹å™¨ï¼ˆåœ¨æœ€å·¦ä¸Šè§’ï¼‰
    QWidget *textContainer = new QWidget(m_backgroundLabel);
    textContainer->setStyleSheet(
        "background: rgba(0, 0, 0, 120);"
        "border-radius: 8px;"
    );
    textContainer->setGeometry(0, 0, 288, 80); // å¢åŠ é«˜åº¦ä»¥å®¹çº³æ›´å¤§çš„æ–‡å­—
    
    QVBoxLayout *textLayout = new QVBoxLayout(textContainer);// è®¾ç½®å¸ƒå±€è¾¹è·å’Œé—´è·
    textLayout->setContentsMargins(8, 8, 8, 8); // è°ƒæ•´è¾¹è·ä»¥é€‚åº”æ›´å¤§çš„å®¹å™¨
    textLayout->setSpacing(6); // å¢åŠ é—´è·ä»¥é€‚åº”æ›´å¤§çš„æ–‡å­—
    textLayout->setAlignment(Qt::AlignTop | Qt::AlignLeft);
    
    // åç§°æ ‡ç­¾
    m_nameLabel = new QLabel(m_info.name, textContainer);
    m_nameLabel->setStyleSheet(
        "font-size: 18px;"
        "font-weight: 600;"
        "color: white;"
        "background: transparent;"
        "padding: 0;"
        "margin: 0;"
        "border: none"
    );
    
    // æè¿°æ ‡ç­¾
    m_descriptionLabel = new QLabel(m_info.description, textContainer);
    m_descriptionLabel->setStyleSheet(
        "font-size: 14px;"
        "font-weight: 400;"
        "color: #cccccc;"
        "background: transparent;"
        "padding: 0;"
        "margin: 0;"
        "border: none;"
        "min-height: 40px;" // å¢åŠ æœ€å°é«˜åº¦
    );
    m_descriptionLabel->setWordWrap(true);
    m_descriptionLabel->setMaximumWidth(250);
    m_descriptionLabel->setMinimumHeight(40); // è®¾ç½®æœ€å°é«˜åº¦
    
    textLayout->addWidget(m_nameLabel);
    textLayout->addWidget(m_descriptionLabel);
    
    mainLayout->addWidget(m_backgroundLabel);
    
    // åˆ›å»ºç¼©æ”¾åŠ¨ç”»
    m_scaleAnimation = new QPropertyAnimation(this, "scale", this);
    
    // è®¾ç½®åˆå§‹é™æ€å›¾ç‰‡
    updateBackgroundImage();
}

/**
 * @brief æ›´æ–°èƒŒæ™¯å›¾ç‰‡
 * 
 * æ ¹æ®å½“å‰çŠ¶æ€æ›´æ–°èƒŒæ™¯å›¾ç‰‡ï¼Œä¼˜å…ˆä½¿ç”¨GIFåŠ¨ç”»çš„å½“å‰å¸§ï¼Œ
 * å¦‚æœæ²¡æœ‰GIFåŠ¨ç”»åˆ™ä½¿ç”¨é™æ€å›¾ç‰‡ï¼Œå¦‚æœéƒ½æ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤èƒŒæ™¯ã€‚
 */
void WorkflowCard::updateBackgroundImage()
{
    // å¦‚æœæœ‰GIFåŠ¨ç”»æ­£åœ¨æ’­æ”¾ï¼Œä½¿ç”¨GIFå½“å‰å¸§
    if (m_movie && m_movie->isValid() && m_movie->state() == QMovie::Running) {
        QPixmap currentFrame = m_movie->currentPixmap();
        if (!currentFrame.isNull()) {
            m_backgroundLabel->setPixmap(currentFrame);
            m_backgroundLabel->setVisible(true);
            qDebug() << "æ›´æ–°èƒŒæ™¯å›¾ç‰‡ä¸ºGIFå½“å‰å¸§";
        } else {
            qDebug() << "GIFå½“å‰å¸§ä¸ºç©º";
        }
    } else {
        // ä½¿ç”¨é™æ€å›¾ç‰‡
        if (!m_info.imagePath.isEmpty()) {
            QPixmap pixmap(m_info.imagePath);
            if (!pixmap.isNull()) {
                m_backgroundLabel->setPixmap(pixmap);
                m_backgroundLabel->setVisible(true);
                qDebug() << "æ›´æ–°èƒŒæ™¯å›¾ç‰‡ä¸ºé™æ€å›¾ç‰‡:" << m_info.imagePath;
            } else {
                qDebug() << "æ— æ³•åŠ è½½é™æ€å›¾ç‰‡:" << m_info.imagePath;
                // ä½¿ç”¨é»˜è®¤èƒŒæ™¯
                QPixmap defaultPixmap(320, 180);
                defaultPixmap.fill(QColor(40, 40, 40));
                m_backgroundLabel->setPixmap(defaultPixmap);
            }
        } else {
            m_backgroundLabel->clear();
            m_backgroundLabel->setVisible(false);
            qDebug() << "èƒŒæ™¯å›¾ç‰‡è·¯å¾„ä¸ºç©ºï¼Œéšè—èƒŒæ™¯";
        }
    }
}

/**
 * @brief è®¾ç½®å¡ç‰‡ç¼©æ”¾æ¯”ä¾‹
 * @param scale ç¼©æ”¾æ¯”ä¾‹å€¼
 * 
 * è®¾ç½®å¡ç‰‡çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œé™åˆ¶åœ¨0.5åˆ°2.0ä¹‹é—´ï¼Œ
 * è§¦å‘é‡ç»˜å¹¶å‘å‡ºç¼©æ”¾å˜åŒ–ä¿¡å·ã€‚
 */
void WorkflowCard::setScale(qreal scale)
{
    // é™åˆ¶ç¼©æ”¾èŒƒå›´åœ¨0.5åˆ°2.0ä¹‹é—´
    qreal boundedScale = qBound(0.5, scale, 2.0);
    
    if (m_scale != boundedScale) {
        m_scale = boundedScale;
        m_currentScale = boundedScale;
        
        // è§¦å‘é‡ç»˜ä»¥åº”ç”¨æ–°çš„ç¼©æ”¾
        this->update();
        
        // å¯é€‰ï¼šå‘å‡ºç¼©æ”¾å˜åŒ–ä¿¡å·
        emit scaleChanged(m_scale);
    }
}

/**
 * @brief é¼ æ ‡è¿›å…¥äº‹ä»¶å¤„ç†
 * @param event é¼ æ ‡è¿›å…¥äº‹ä»¶
 * 
 * å¤„ç†é¼ æ ‡æ‚¬åœæ•ˆæœï¼Œå¼€å§‹GIFåŠ¨ç”»ï¼Œæ›´æ–°èƒŒæ™¯å›¾ç‰‡å’Œé¼ æ ‡æ ·å¼ã€‚
 */
void WorkflowCard::enterEvent(QEnterEvent *event)
{
    m_isHovering = true;
    
    // ç§»é™¤ç¼©æ”¾åŠ¨ç”»ï¼Œä¿æŒå¡ç‰‡åŸå§‹å¤§å°
    // å¼€å§‹GIFåŠ¨ç”»
    startGifAnimation();
    
    // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
    updateBackgroundImage();
    
    // æ›´æ–°é¼ æ ‡æ ·å¼
    this->setCursor(Qt::PointingHandCursor);
    
    QWidget::enterEvent(event);
}

/**
 * @brief é¼ æ ‡ç¦»å¼€äº‹ä»¶å¤„ç†
 * @param event é¼ æ ‡ç¦»å¼€äº‹ä»¶
 * 
 * å¤„ç†é¼ æ ‡ç¦»å¼€æ•ˆæœï¼Œåœæ­¢GIFåŠ¨ç”»ï¼Œæ¢å¤èƒŒæ™¯å›¾ç‰‡å’Œé¼ æ ‡æ ·å¼ã€‚
 */
void WorkflowCard::leaveEvent(QEvent *event)
{
    m_isHovering = false;
    
    // åœæ­¢GIFåŠ¨ç”»
    stopGifAnimation();
    
    // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
    updateBackgroundImage();
    
    // æ¢å¤é¼ æ ‡æ ·å¼
    this->setCursor(Qt::ArrowCursor);
    
    QWidget::leaveEvent(event);
}

/**
 * @brief é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶å¤„ç†
 * @param event é¼ æ ‡äº‹ä»¶
 * 
 * å¤„ç†é¼ æ ‡ç‚¹å‡»äº‹ä»¶ï¼Œå½“å·¦é”®ç‚¹å‡»æ—¶å‘å‡ºclickedä¿¡å·ã€‚
 */
void WorkflowCard::mousePressEvent(QMouseEvent *event)
{
    if (event->button() == Qt::LeftButton) {
        emit clicked(m_info);
    }
    QWidget::mousePressEvent(event);
}

/**
 * @brief çª—å£å¤§å°æ”¹å˜äº‹ä»¶å¤„ç†
 * @param event å¤§å°æ”¹å˜äº‹ä»¶
 * 
 * å¤„ç†çª—å£å¤§å°æ”¹å˜ï¼Œè§¦å‘é‡ç»˜ä»¥ç¡®ä¿UIæ­£ç¡®æ˜¾ç¤ºã€‚
 */
void WorkflowCard::resizeEvent(QResizeEvent *event)
{
    QWidget::resizeEvent(event);
    this->update(); // ç›´æ¥è°ƒç”¨update()è§¦å‘é‡ç»˜
}

/**
 * @brief ç»˜åˆ¶äº‹ä»¶å¤„ç†
 * @param event ç»˜åˆ¶äº‹ä»¶
 * 
 * é‡å†™ç»˜åˆ¶äº‹ä»¶ï¼Œæ˜ç¡®ä¸å¤„ç†èƒŒæ™¯ç»˜åˆ¶ï¼Œå®Œå…¨ç”±QLabelè´Ÿè´£ã€‚
 * æ­¤æ–¹æ³•ä»…ä¿ç•™ä½œä¸ºå ä½ï¼Œç¡®ä¿ä¸ä¼šæ„å¤–ç»˜åˆ¶èƒŒæ™¯ã€‚
 */
void WorkflowCard::paintEvent(QPaintEvent *event)
{
    // æ˜ç¡®ä¸å¤„ç†èƒŒæ™¯ç»˜åˆ¶ï¼Œå®Œå…¨ç”±QLabelè´Ÿè´£
    // æ­¤æ–¹æ³•ä»…ä¿ç•™ä½œä¸ºå ä½ï¼Œç¡®ä¿ä¸ä¼šæ„å¤–ç»˜åˆ¶èƒŒæ™¯
    QWidget::paintEvent(event);
}

/**
 * @brief å¼€å§‹GIFåŠ¨ç”»
 * 
 * å»¶è¿Ÿåˆå§‹åŒ–GIFåŠ¨ç”»ï¼Œè¿æ¥å¸§æ›´æ–°ä¿¡å·ï¼Œå¯åŠ¨åŠ¨ç”»æ’­æ”¾ã€‚
 * æ”¯æŒGIFåŠ¨ç”»çš„ç¼“å­˜å’Œé”™è¯¯å¤„ç†ã€‚
 */
void WorkflowCard::startGifAnimation()
{
    // å»¶è¿Ÿåˆå§‹åŒ–GIF
    if (!m_info.gifPath.isEmpty() && !m_movie) {
        qDebug() << "å»¶è¿Ÿåˆå§‹åŒ–GIF:" << m_info.gifPath;
        m_movie = new QMovie(m_info.gifPath, QByteArray(), this);
        m_movie->setCacheMode(QMovie::CacheAll);
        
        if (!m_movie->isValid()) {
            qDebug() << "æ— æ³•åŠ è½½GIF:" << m_info.gifPath << "é”™è¯¯:" << m_movie->lastErrorString();
            delete m_movie;
            m_movie = nullptr;
            return;
        }
        
        qDebug() << "æˆåŠŸåŠ è½½GIF:" << m_info.gifPath << "å¸§æ•°:" << m_movie->frameCount();
        
        // è¿æ¥GIFå¸§æ›´æ–°ä¿¡å·ï¼Œè§¦å‘é‡ç»˜
        connect(m_movie, &QMovie::frameChanged, this, [this](int frameNumber) {
            Q_UNUSED(frameNumber)
            updateBackgroundImage();
        });
    }
    
    if (m_movie && m_movie->isValid()) {
        qDebug() << "å¯åŠ¨GIFåŠ¨ç”»:" << m_info.gifPath;
        m_movie->start();
        
        // ç¡®ä¿GIFæ­£åœ¨æ’­æ”¾
        if (m_movie->state() != QMovie::Running) {
            qDebug() << "GIFæœªèƒ½å¯åŠ¨ï¼ŒçŠ¶æ€:" << m_movie->state();
        }
        
        // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
        updateBackgroundImage();
    } else {
        qDebug() << "æ— æ³•å¯åŠ¨GIFåŠ¨ç”»ï¼Œmovieæ— æ•ˆæˆ–è·¯å¾„ä¸ºç©º";
    }
}

/**
 * @brief åœæ­¢GIFåŠ¨ç”»
 * 
 * åœæ­¢GIFåŠ¨ç”»æ’­æ”¾ï¼Œé‡ç½®åˆ°ç¬¬ä¸€å¸§ï¼Œç¡®ä¿ä¸‹æ¬¡æ’­æ”¾ä»å¤´å¼€å§‹ã€‚
 */
void WorkflowCard::stopGifAnimation()
{
    if (m_movie && m_movie->isValid()) {
        qDebug() << "åœæ­¢GIFåŠ¨ç”»:" << m_info.gifPath;
        m_movie->stop();
        
        // é‡ç½®GIFåˆ°ç¬¬ä¸€å¸§ï¼Œç¡®ä¿ä¸‹æ¬¡æ’­æ”¾ä»å¤´å¼€å§‹
        m_movie->jumpToFrame(0);
        
        // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
        updateBackgroundImage();
    }
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\WorkflowCard.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\WorkflowCard.h ---

/**
 * @file WorkflowCard.h
 * @brief å·¥ä½œæµå¡ç‰‡ç»„ä»¶å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†WorkflowCardç±»ï¼Œç”¨äºæ˜¾ç¤ºå·¥ä½œæµå¡ç‰‡ï¼Œæ”¯æŒé™æ€å›¾ç‰‡å’ŒGIFåŠ¨ç”»èƒŒæ™¯ï¼Œ
 * åŒ…å«é¼ æ ‡æ‚¬åœæ•ˆæœã€ç¼©æ”¾åŠ¨ç”»å’Œæ–‡å­—ä¿¡æ¯å±•ç¤ºåŠŸèƒ½ã€‚
 * 
 * @author ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
 * @version 1.0
 * @date 2024
 */

#pragma once
#include <QWidget>
#include <QLabel>
#include <QMovie>
#include <QPropertyAnimation>
#include <QGraphicsDropShadowEffect>
#include "../../Model/WorkflowTypes.h"

/**
 * @class WorkflowCard
 * @brief å·¥ä½œæµå¡ç‰‡ç»„ä»¶ç±»
 * 
 * è¯¥ç±»å®ç°äº†ä¸€ä¸ªå¯äº¤äº’çš„å·¥ä½œæµå¡ç‰‡ï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š
 * - æ˜¾ç¤ºå·¥ä½œæµåç§°å’Œæè¿°
 * - æ”¯æŒé™æ€å›¾ç‰‡å’ŒGIFåŠ¨ç”»èƒŒæ™¯
 * - é¼ æ ‡æ‚¬åœæ—¶æ’­æ”¾GIFåŠ¨ç”»
 * - ç¼©æ”¾åŠ¨ç”»æ•ˆæœ
 * - ç‚¹å‡»äº‹ä»¶å¤„ç†
 */
class WorkflowCard : public QWidget {
    Q_OBJECT
    // æ·»åŠ ä¸€ä¸ªå±æ€§ç”¨äºç¼©æ”¾åŠ¨ç”»
    Q_PROPERTY(qreal scale READ scale WRITE setScale)

public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param info å·¥ä½œæµä¿¡æ¯ç»“æ„ä½“
     * @param parent çˆ¶çª—å£æŒ‡é’ˆ
     */
    explicit WorkflowCard(const WorkflowInfo& info, QWidget* parent = nullptr);
    
    /**
     * @brief è·å–å·¥ä½œæµä¿¡æ¯
     * @return å·¥ä½œæµä¿¡æ¯ç»“æ„ä½“å¼•ç”¨
     */
    const WorkflowInfo& workflowInfo() const { return m_info; }
    
    /**
     * @brief è·å–å½“å‰ç¼©æ”¾æ¯”ä¾‹
     * @return ç¼©æ”¾æ¯”ä¾‹å€¼
     */
    qreal scale() const { return m_scale; }
    
    /**
     * @brief è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
     * @param scale ç¼©æ”¾æ¯”ä¾‹å€¼
     */
    void setScale(qreal scale);

signals:
    /**
     * @brief å¡ç‰‡ç‚¹å‡»ä¿¡å·
     * @param info è¢«ç‚¹å‡»çš„å·¥ä½œæµä¿¡æ¯
     */
    void clicked(const WorkflowInfo& info);
    
    /**
     * @brief ç¼©æ”¾å˜åŒ–ä¿¡å·
     * @param scale æ–°çš„ç¼©æ”¾æ¯”ä¾‹å€¼
     */
    void scaleChanged(qreal scale);

protected:
    /**
     * @brief ç»˜åˆ¶äº‹ä»¶å¤„ç†
     * @param event ç»˜åˆ¶äº‹ä»¶
     */
    void paintEvent(QPaintEvent* event) override;
    
    /**
     * @brief é¼ æ ‡è¿›å…¥äº‹ä»¶å¤„ç†
     * @param event é¼ æ ‡è¿›å…¥äº‹ä»¶
     */
    void enterEvent(QEnterEvent* event) override;
    
    /**
     * @brief é¼ æ ‡ç¦»å¼€äº‹ä»¶å¤„ç†
     * @param event é¼ æ ‡ç¦»å¼€äº‹ä»¶
     */
    void leaveEvent(QEvent* event) override;
    
    /**
     * @brief é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶å¤„ç†
     * @param event é¼ æ ‡äº‹ä»¶
     */
    void mousePressEvent(QMouseEvent* event) override;
    
    /**
     * @brief çª—å£å¤§å°æ”¹å˜äº‹ä»¶å¤„ç†
     * @param event å¤§å°æ”¹å˜äº‹ä»¶
     */
    void resizeEvent(QResizeEvent* event) override;

private:
    /**
     * @brief è®¾ç½®UIç•Œé¢
     */
    void setupUi();
    
    /**
     * @brief å¼€å§‹GIFåŠ¨ç”»
     */
    void startGifAnimation();
    
    /**
     * @brief åœæ­¢GIFåŠ¨ç”»
     */
    void stopGifAnimation();
    
    /**
     * @brief æ›´æ–°èƒŒæ™¯å›¾ç‰‡
     */
    void updateBackgroundImage();

private:
    WorkflowInfo m_info;              ///< å·¥ä½œæµä¿¡æ¯
    qreal m_scale = 1.0;              ///< å½“å‰ç¼©æ”¾æ¯”ä¾‹
    qreal m_currentScale = 1.0;       ///< å®é™…ç¼©æ”¾æ¯”ä¾‹
    bool m_isHovering = false;        ///< é¼ æ ‡æ‚¬åœçŠ¶æ€
    
    // UIç»„ä»¶
    QLabel* m_nameLabel = nullptr;        ///< åç§°æ ‡ç­¾
    QLabel* m_descriptionLabel = nullptr; ///< æè¿°æ ‡ç­¾
    QLabel* m_backgroundLabel = nullptr;  ///< èƒŒæ™¯å›¾ç‰‡æ ‡ç­¾
    
    // åŠ¨ç”»ç›¸å…³
    QMovie* m_movie = nullptr;                ///< GIFåŠ¨ç”»å¯¹è±¡
    QPropertyAnimation* m_scaleAnimation = nullptr; ///< ç¼©æ”¾åŠ¨ç”»å¯¹è±¡
    
    // é™æ€å›¾ç‰‡å’ŒGIFè·¯å¾„
    QString m_imagePath; ///< é™æ€å›¾ç‰‡è·¯å¾„
    QString m_gifPath;   ///< GIFåŠ¨ç”»è·¯å¾„
};

--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\WorkflowCard.h ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\WorkflowSelector.cpp ---

/**
 * @file WorkflowSelector.cpp
 * @brief å·¥ä½œæµé€‰æ‹©å™¨ç»„ä»¶å®ç°æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®ç°äº†WorkflowSelectorç±»ï¼Œç”¨äºæ˜¾ç¤ºå·¥ä½œæµé€‰æ‹©å¼¹å‡ºçª—å£ã€‚
 * åŒ…å«å·¥ä½œæµå¡ç‰‡çš„å¸ƒå±€ç®¡ç†ã€çª—å£æ ·å¼è®¾ç½®ã€äº‹ä»¶å¤„ç†ç­‰åŠŸèƒ½ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#include "WorkflowSelector.h"
#include "WorkflowCard.h"
#include <QVBoxLayout>
#include <QScrollArea>
#include <QPainter>
#include <QApplication>
#include <QScreen>
#include <QLabel>
#include <QMouseEvent>

/**
 * @brief æ„é€ å‡½æ•°
 * @param parent çˆ¶çª—å£æŒ‡é’ˆ
 * 
 * åˆå§‹åŒ–å·¥ä½œæµé€‰æ‹©å™¨çª—å£ï¼Œè®¾ç½®çª—å£å±æ€§å¹¶åˆ›å»ºUIç•Œé¢ã€‚
 * é¢„ç½®äº†å››ç§å·¥ä½œæµç±»å‹ï¼šæ–‡ç”Ÿå›¾ã€å›¾ç”Ÿå›¾ã€å±€éƒ¨é‡ç»˜ã€å›¾åƒæ”¾å¤§ã€‚
 */
WorkflowSelector::WorkflowSelector(QWidget* parent) : QWidget(parent) {
    // è®¾ç½®çª—å£å±æ€§ï¼šPopup ç±»å‹(æ— æ ‡é¢˜æ )ï¼Œé€æ˜èƒŒæ™¯
    setWindowFlags(Qt::Popup | Qt::FramelessWindowHint);
    setAttribute(Qt::WA_TranslucentBackground);
    
    // åˆå§‹åŒ–æµ‹è¯•å·¥ä½œæµæ•°æ®
    m_workflows.append(WorkflowInfo(1, "æ–‡ç”Ÿå›¾", ":/images/æ–‡ç”Ÿå›¾æ¼”ç¤º.png", ":/images/æ–‡ç”Ÿå›¾æ¼”ç¤º.gif", "åŸºç¡€ç”Ÿæˆæ¨¡å¼ï¼Œä»æ–‡å­—åˆ›å»ºå›¾åƒ", WorkflowType::TextToImage));
    m_workflows.append(WorkflowInfo(2, "å›¾ç”Ÿå›¾", ":/images/å›¾ç”Ÿå›¾æ¼”ç¤º.png", ":/images/å›¾ç”Ÿå›¾æ¼”ç¤º.gif", "åŸºäºå‚è€ƒå›¾ç”Ÿæˆæ–°å›¾åƒ", WorkflowType::ImageToImage));
    
    setupUi();
}

/**
 * @brief ææ„å‡½æ•°
 * 
 * Qtä¼šè‡ªåŠ¨æ¸…ç†å­æ§ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨åˆ é™¤ã€‚
 */
WorkflowSelector::~WorkflowSelector() {
    // Qtä¼šè‡ªåŠ¨æ¸…ç†å­æ§ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨åˆ é™¤
}

/**
 * @brief åˆå§‹åŒ–UIç•Œé¢
 * 
 * åˆ›å»ºå·¥ä½œæµé€‰æ‹©å™¨çš„æ‰€æœ‰UIç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼š
 * - ä¸»å¸ƒå±€å’Œå®¹å™¨
 * - æ ‡é¢˜æ ‡ç­¾
 * - æ»šåŠ¨åŒºåŸŸå’Œå¡ç‰‡å¸ƒå±€
 * - å·¥ä½œæµå¡ç‰‡
 */
void WorkflowSelector::setupUi() {
    // ä¸»å¸ƒå±€ï¼šç•™å‡ºé˜´å½±çš„è¾¹è· (Margin = 3)
    m_mainLayout = new QVBoxLayout(this);
    m_mainLayout->setContentsMargins(3, 3, 3, 3);
    
    // å®ä½“å®¹å™¨ (æ·±è‰²åº•è‰²çš„æ¡†)
    m_container = new QWidget(this);
    m_container->setObjectName("Container");
    m_container->setStyleSheet(
        "QWidget#Container {"
        "  background-color: #2a2a2a;" // æ·±ç°èƒŒæ™¯
        "  border: 1px solid #444;"
        "  border-radius: 12px;"       // åœ†è§’
        "}"
    );
    
    // ç»™å®¹å™¨åŠ é˜´å½±
    QGraphicsDropShadowEffect* shadow = new QGraphicsDropShadowEffect(this);
    shadow->setBlurRadius(25);
    shadow->setColor(QColor(0, 0, 0, 100));
    shadow->setOffset(0, 8);
    m_container->setGraphicsEffect(shadow);
    
    // å®¹å™¨å†…éƒ¨å¸ƒå±€
    m_containerLayout = new QVBoxLayout(m_container);
    m_containerLayout->setContentsMargins(20, 20, 20, 20);
    m_containerLayout->setSpacing(15);
    
    // æ ‡é¢˜
    QLabel* title = new QLabel("é€‰æ‹©å·¥ä½œæµ", m_container);
    title->setStyleSheet("color: white; font-size: 18px; font-weight: bold; border: none; background: transparent;");
    m_containerLayout->addWidget(title);
    
    // æ»šåŠ¨åŒºåŸŸ
    m_scrollArea = new QScrollArea(m_container);
    m_scrollArea->setStyleSheet(
        "QScrollArea { background: #343541; border: none; }"
        "QScrollBar:vertical { border: none; background: #343541; width: 10px; margin: 0px; }"
        "QScrollBar::handle:vertical { background: #565869; min-height: 20px; border-radius: 5px; }"
        "QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical { height: 0px; }"
        "QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical { background: none; }"
    );
    m_scrollArea->setWidgetResizable(true);
    m_scrollArea->setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOff);
    
    // å¡ç‰‡åˆ—è¡¨å®¹å™¨
    m_scrollContent = new QWidget();
    m_scrollContent->setStyleSheet("background: transparent;");
    
    // å‚ç›´å¸ƒå±€æ”¾å¡ç‰‡
    m_cardsLayout = new QVBoxLayout(m_scrollContent);
    m_cardsLayout->setContentsMargins(0, 0, 10, 0); // å³è¾¹ç•™ç‚¹ç©ºç»™æ»šåŠ¨æ¡
    m_cardsLayout->setSpacing(15);
    
    // æ·»åŠ å¡ç‰‡
    createWorkflowCards();
    
    m_scrollArea->setWidget(m_scrollContent);
    m_containerLayout->addWidget(m_scrollArea);
    
    m_mainLayout->addWidget(m_container);
    
    // è®¾ç½®çª—å£å¤§å°ï¼šå¡ç‰‡å®½320 + å†…å¤–è¾¹è·
    this->setFixedSize(380, 500);
}

/**
 * @brief åˆ›å»ºå·¥ä½œæµå¡ç‰‡
 * 
 * æ ¹æ®å·¥ä½œæµæ•°æ®åˆ›å»ºå¯¹åº”çš„å¡ç‰‡ç»„ä»¶ï¼Œå¹¶è®¾ç½®ç‚¹å‡»äº‹ä»¶è¿æ¥ã€‚
 * æ¸…é™¤ç°æœ‰å¡ç‰‡åé‡æ–°åˆ›å»ºï¼Œç¡®ä¿æ•°æ®åŒæ­¥ã€‚
 */
void WorkflowSelector::createWorkflowCards() {
    // æ¸…é™¤ç°æœ‰å¡ç‰‡
    QLayoutItem* item;
    while ((item = m_cardsLayout->takeAt(0)) != nullptr) {
        if (item->widget()) {
            item->widget()->deleteLater();
        }
        delete item;
    }
    m_workflowCards.clear();
    
    // åˆ›å»ºæ–°å¡ç‰‡
    for (const auto& workflow : m_workflows) {
        WorkflowCard* card = new WorkflowCard(workflow, m_scrollContent);
        
        connect(card, &WorkflowCard::clicked, this, [this](const WorkflowInfo& info) {
            emit workflowSelected(info);
            this->hide();
        });
        
        m_workflowCards.append(card);
        m_cardsLayout->addWidget(card, 0, Qt::AlignHCenter); // å±…ä¸­æ·»åŠ 
    }
    
    // æ·»åŠ åº•éƒ¨å¼¹ç°§ï¼Œé˜²æ­¢å¡ç‰‡ç´§è´´åº•éƒ¨
    m_cardsLayout->addStretch();
}

/**
 * @brief è®¾ç½®å·¥ä½œæµæ•°æ®
 * @param workflows å·¥ä½œæµä¿¡æ¯å‘é‡
 * 
 * æ›´æ–°å·¥ä½œæµæ•°æ®å¹¶é‡æ–°åˆ›å»ºå¡ç‰‡ï¼Œç”¨äºåŠ¨æ€æ›´æ–°å·¥ä½œæµåˆ—è¡¨ã€‚
 */
void WorkflowSelector::setWorkflows(const QVector<WorkflowInfo>& workflows) {
    m_workflows = workflows;
    createWorkflowCards();
}

/**
 * @brief ç»˜åˆ¶äº‹ä»¶å¤„ç†
 * @param event ç»˜åˆ¶äº‹ä»¶
 * 
 * ä½¿ç”¨é€æ˜æ¨¡å¼ç»˜åˆ¶çª—å£èƒŒæ™¯ï¼Œç¡®ä¿çª—å£å®Œå…¨é€æ˜ã€‚
 * è¿™æ˜¯å®ç°æ— è¾¹æ¡†é€æ˜çª—å£çš„å…³é”®æ–¹æ³•ã€‚
 */
void WorkflowSelector::paintEvent(QPaintEvent* event) {
    Q_UNUSED(event);
    QPainter p(this);
    // ç”¨ "Clear" æ¨¡å¼æŠŠæ•´ä¸ªçª—å£åˆ·æˆå®Œå…¨é€æ˜
    // è¿™æ ·æ“ä½œç³»ç»Ÿå°±ä¸ä¼šç»˜åˆ¶é»‘è‰²åº•è‰²äº†
    p.setCompositionMode(QPainter::CompositionMode_Clear);
    p.fillRect(rect(), Qt::transparent);
}

/**
 * @brief äº‹ä»¶å¤„ç†
 * @param event äº‹ä»¶å¯¹è±¡
 * @return æ˜¯å¦å¤„ç†äº†è¯¥äº‹ä»¶
 * 
 * å¤„ç†çª—å£å¤±å»ç„¦ç‚¹äº‹ä»¶ï¼Œå½“ç”¨æˆ·ç‚¹å‡»çª—å£å¤–éƒ¨æ—¶è‡ªåŠ¨å…³é—­çª—å£ã€‚
 */
bool WorkflowSelector::event(QEvent* event) {
    // å¦‚æœçª—å£å¤±å»ç„¦ç‚¹ï¼ˆç”¨æˆ·ç‚¹äº†åˆ«å¤„ï¼‰ï¼Œå°±éšè—
    if (event->type() == QEvent::WindowDeactivate) {
        this->hide();
        return true;
    }
    return QWidget::event(event);
}

/**
 * @brief å¼¹å‡ºçª—å£
 * @param pos å¼¹å‡ºä½ç½®ï¼ˆç›¸å¯¹äºå±å¹•åæ ‡ï¼‰
 * 
 * åœ¨æŒ‡å®šä½ç½®å¼¹å‡ºå·¥ä½œæµé€‰æ‹©çª—å£ï¼Œè‡ªåŠ¨è°ƒæ•´ä½ç½®ç¡®ä¿ä¸è¶…å‡ºå±å¹•è¾¹ç•Œã€‚
 * å¦‚æœä¸Šæ–¹ç©ºé—´ä¸è¶³ï¼Œä¼šè‡ªåŠ¨æ˜¾ç¤ºåœ¨ä¸‹æ–¹ã€‚
 */
void WorkflowSelector::popup(const QPoint& pos) {
    // è®¡ç®—çª—å£ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
    int x = pos.x() - width() / 2;
    int y = pos.y() - height() - 10;
    
    // è·å–å±å¹•å°ºå¯¸
    QScreen* screen = QApplication::primaryScreen();
    QRect screenGeometry = screen->geometry();
    
    // é˜²æ­¢çª—å£è¶…å‡ºå±å¹•è¾¹ç•Œ
    if (x < 10) x = 10;
    if (x + width() > screenGeometry.width() - 10) x = screenGeometry.width() - width() - 10;
    
    if (y < 10) {
        // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸è¶³ï¼Œæ˜¾ç¤ºåœ¨ä¸‹æ–¹
        y = pos.y() + 20;
    }
    if (y + height() > screenGeometry.height() - 10) {
        y = screenGeometry.height() - height() - 10;
    }
    
    move(x, y);
    show();
    raise();
    setFocus();
}


--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\WorkflowSelector.cpp ---

--- æ–‡ä»¶å¼€å§‹: src\Ui\Components\WorkflowSelector.h ---

/**
 * @file WorkflowSelector.h
 * @brief å·¥ä½œæµé€‰æ‹©å™¨ç»„ä»¶å¤´æ–‡ä»¶
 * 
 * è¯¥æ–‡ä»¶å®šä¹‰äº†WorkflowSelectorç±»ï¼Œç”¨äºæ˜¾ç¤ºå·¥ä½œæµé€‰æ‹©å¼¹å‡ºçª—å£ã€‚
 * åŒ…å«å·¥ä½œæµå¡ç‰‡çš„å¸ƒå±€ç®¡ç†ã€çª—å£æ ·å¼è®¾ç½®ã€äº‹ä»¶å¤„ç†ç­‰å£°æ˜ã€‚
 * 
 * @author CloudArt Team
 * @version 1.0
 * @date 2024
 */

#pragma once
#include <QWidget>
#include <QVBoxLayout>
#include <QScrollArea>
#include <QLabel>
#include <QGraphicsDropShadowEffect>
#include "../../Model/WorkflowTypes.h"

class WorkflowCard;

/**
 * @brief å·¥ä½œæµé€‰æ‹©å™¨ç±»
 * 
 * ç»§æ‰¿è‡ªQWidgetï¼Œæä¾›å·¥ä½œæµé€‰æ‹©åŠŸèƒ½çš„å¼¹å‡ºçª—å£ã€‚
 * æ”¯æŒæ˜¾ç¤ºå¤šä¸ªå·¥ä½œæµå¡ç‰‡ï¼Œå…·æœ‰é€æ˜èƒŒæ™¯ã€é˜´å½±æ•ˆæœå’Œè‡ªåŠ¨å…³é—­åŠŸèƒ½ã€‚
 */
class WorkflowSelector : public QWidget {
    Q_OBJECT

public:
    /**
     * @brief æ„é€ å‡½æ•°
     * @param parent çˆ¶çª—å£æŒ‡é’ˆ
     */
    explicit WorkflowSelector(QWidget* parent = nullptr);
    
    /**
     * @brief ææ„å‡½æ•°
     */
    ~WorkflowSelector();
    
    /**
     * @brief å¼¹å‡ºçª—å£
     * @param pos å¼¹å‡ºä½ç½®ï¼ˆç›¸å¯¹äºå±å¹•åæ ‡ï¼‰
     */
    void popup(const QPoint& pos);
    
    /**
     * @brief è®¾ç½®å·¥ä½œæµæ•°æ®
     * @param workflows å·¥ä½œæµä¿¡æ¯å‘é‡
     */
    void setWorkflows(const QVector<WorkflowInfo>& workflows);
    
    /**
     * @brief è·å–å½“å‰å·¥ä½œæµåˆ—è¡¨
     * @return å·¥ä½œæµä¿¡æ¯å‘é‡å¼•ç”¨
     */
    const QVector<WorkflowInfo>& workflows() const { return m_workflows; }

signals:
    /**
     * @brief å·¥ä½œæµé€‰æ‹©ä¿¡å·
     * @param info é€‰ä¸­çš„å·¥ä½œæµä¿¡æ¯
     */
    void workflowSelected(const WorkflowInfo& info);

protected:
    /**
     * @brief ç»˜åˆ¶äº‹ä»¶å¤„ç†
     * @param event ç»˜åˆ¶äº‹ä»¶
     */
    void paintEvent(QPaintEvent* event) override;
    
    /**
     * @brief äº‹ä»¶å¤„ç†
     * @param event äº‹ä»¶å¯¹è±¡
     * @return æ˜¯å¦å¤„ç†äº†è¯¥äº‹ä»¶
     */
    bool event(QEvent* event) override;

private:
    /**
     * @brief åˆå§‹åŒ–UIç•Œé¢
     */
    void setupUi();
    
    /**
     * @brief åˆ›å»ºå·¥ä½œæµå¡ç‰‡
     */
    void createWorkflowCards();

private:
    QVector<WorkflowInfo> m_workflows; ///< å·¥ä½œæµæ•°æ®åˆ—è¡¨
    QVector<WorkflowCard*> m_workflowCards; ///< å·¥ä½œæµå¡ç‰‡æŒ‡é’ˆåˆ—è¡¨
    
    // UIç»„ä»¶
    QVBoxLayout* m_mainLayout = nullptr; ///< ä¸»å¸ƒå±€
    QWidget* m_container = nullptr; ///< å†…å®¹å®¹å™¨
    QVBoxLayout* m_containerLayout = nullptr; ///< å®¹å™¨å¸ƒå±€
    QScrollArea* m_scrollArea = nullptr; ///< æ»šåŠ¨åŒºåŸŸ
    QWidget* m_scrollContent = nullptr; ///< æ»šåŠ¨å†…å®¹
    QVBoxLayout* m_cardsLayout = nullptr; ///< å¡ç‰‡å¸ƒå±€
};

--- æ–‡ä»¶ç»“æŸ: src\Ui\Components\WorkflowSelector.h ---

